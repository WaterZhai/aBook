第8章   因特网上的音频/视频服务

本章首先对因特网提供音频/视频服务进行概述。然后介绍流式音频/视频中的媒体服务器合实时流式协议RTSP，并比IP电话为例介绍交互式音频/视频所使用的一些协议，如实时传送协议RTP、实时传送控制协议RTCP、H.323以及会话发起协议SIP。接着讨论改进“尽最大努力交付”的服务的一些措施，包括怎样使因特网能够提供服务质量，并介绍综合服务IntServ、资源预留协议RSVP和区分服务DiffServ的要点。

8.1概述
    计算机网络最初是为传送数据设计的。因特网IP层提供的“尽最大努力交付”服务以及每一个分组独立交付的策略，对传送数据信息十分合适。因特网使用的TCP协议可以很好地解决IP层不能提供可靠交付这一问题。
    然而技术的进步使许多用户开始利用因特网转送音频/视频信息。在许多情况下，这种音频/视频长称为对媒体信息。本来电路交换的公用电话网传送多媒体信息已是相当成熟的技术。例如视频会议（又称为电视会议）原先是使用电路交换的公用电话网。使用电路交换的好处是：一旦连接建立了（也就是只要拨通了电话），经过压缩处理的多媒体信息在电话线路上传输质量有保证。美中不足的是向电信公司租用电话线路的价格太高。
    多媒体信息（包括声音和图像信息）与不包括声音和图像的数据信息有很大的区别，其中最主要的两个特点如下。
    第一，多媒体信息的信息量往往很大。
    含有音频或视频的多媒体信息的信息量一般都很大，下面是简单的说明。
    对于电话的声音信息，如采用标准的PCM编码（8kHz速率采样），而每一个采样脉冲用8位编码，则得出的声音信号的数据率就是64kb/s。对于高质量的立体声音乐CD信息，虽然它也使用PCM编码，但其采样速率为44.1kHz，而每一个采样脉冲用16位编码，因此这种双声道立体声音乐信号的数据率超过了1.4Mb/s。
    再看一下数码照片。假定分辨率为1280x960（中等质量）。若每个像素用24位进行编码，则一张未经压缩的照片的照片的字节数约合3.52MB（这里1B=8bit，1M=2^20）。
    活动图像的信息量就更大。如不压缩的彩色电视信号的数据率超过250Mb/s。
    因此在网上传送多媒体信息都无例外地采用各种信息压缩技术。例如在话音压缩方面的标准有：移动通信的GSM（13kb/s），IP电话使用的G.729（8kb/s）和G.723.1（6.4kb/s和5.3kb/s）。在立体声音乐的压缩技术有MP3（128kb/s或122kb/s）。在视频信号方面有VCD质量的MPEG 1 （1.5Mb/s）和DVD质量的MPEG 2 （3~6Mb/s）。由于多媒体信息压缩技术本身不是计算机网络技术范畴。本书将不讨论有关数据压缩方面的内容。
    第二，在传输多媒体数据时，对时延和时延抖动均有较高的要求
    我们知道，模拟的多媒体信号只有经过数字化后才能在因特网上传送。就是对模拟信号要经过采样和模数转换变为数字信号，然后将一定数量的比特组装成分组进行传送。这些分组在发送时的时间间隔都是恒定的，通常称这样的分组为等时的（isochronous）。这种等时分组进入因特网的速率也是恒定的。但传统的因特网本身是非等时的。这是因为在使用IP协议的因特网中，每一个分组是独立地传送，因而这些分组在到达接收端时变成为非等时的。如果我们在接收端对这些以非恒定速率到达的分组边接收边还原，那么就一定会产生很大的失真。
    要解决这一问题，可以在接收端设置适当大小的缓存，当缓存中的分组数达到一定的数量后再以恒定速率按顺序将这些分组读出进行还原播放。
    从图可看出，缓存实际上就是一个先进先出的队列。图中标明的T叫做播放时延，这就是从最初的分组开始到达缓存算起，经过使所有到达的分组都经受了延迟。由于分组以非恒定速率到达，因此早到达的分组在缓存中停留的时间较长，而晚到达的分组在缓存中停留的时间就较短。从缓存中取出分组是按照固定的时钟节拍进行的，因此，到达的非等时的分组，经过缓存后再以恒定速率读出，就变成了等时的分组（但请注意，时延太大的分组就丢弃了），这就在很大程度上消除了时延的抖动。但我们付出的代价是增加了时延。以上所述的概念可以用图来说明。
    图画出了发送端一连发送6个等时的分组。如果网络没有时延，那么到达的分组数岁时间的变化就如图中最左边的阶梯状的曲线所示。这就是说，只要发送方一发出一个分组，在接收方到达的分组数就立即加1.但实际的网络使每一个分组经受的时延不同，因此这一串分组在到达接收端时就变成了非等时的。这就使得分组到达的阶梯状曲线向右移动，并且变成不均匀的。图标注出了分组1的时延。图中给出了两个不同的开始播放时刻。黑色小圆点表示在播放时刻对应的分组已经在缓存中，而空心小圆圈表示在播放时刻对应的分组尚未到达。我们可以看出，即使推迟了播放时间，也还有可能有某个迟到分组赶不上播放。如果再推迟播放时间，则所有的6个分组都不会错过播放，但这样做的时延会较大。
    然而我们还有一些问题没有讨论。
    首先，播放时延T应当选为多大？把T选择得越大，就可以消除更大的时延抖动，但所有分组经受的平均时延也增大了，而这对某些实时应用（如视频会议）是很不利的。当然这对单向传输的视频节目问题并不太大（如从网上下载一段视频节目，只要耐心多等待一段时间用来将分组放入缓存即可）。如果T选择得太小，那么消除时延抖动的效果就较差。因此播放时延T的选择必须折中考虑。在传送时延敏感（delay sensitive）的实时数据时，不仅传输时延不能太大，而且时延抖动也必须受到限制。
    其次，在因特网上传输实时数据的分组时有可能会出现差错甚至丢失。如果利用TCP协议对这些出错或丢失的分组进行重传，那么时延就会大大增加。因此实时数据的传输在运输层就应采用用户数据报协议UDP而不使用TCP协议。这就是说，对于传送实时数据，我们宁可丢失少量分组（当然不能丢失太多），也不要太晚到达的分组。在连续的音频或视频数据流中，很少量的分组的丢失对播放效果的影响并不大（因为这是由人来进行主观评价的），因而使可以容忍的。丢失容忍（loss tolerant）也是实时数据的另一个重要特点。
    由于分组的到达可能不按序，但将分组还原和播放时又应当是按序的。因此在发送多媒体分组时还应当给每一个分组加上序号。这表明还应当有相应的协议支持才行。
    还有一种情况，就是要使接收端能够将节目中本来就存在的正常的短时间停顿（如音乐中停顿几拍）和因某些分组的较大迟延造成的“停顿”区分开来。这就需要增加一个时间戳（timestamp），以便告诉接收端应当在什么时间播放哪个分组。
    根据以上的讨论可以看出，若想在因特网上传送音频/视频数据，就需要设法改造现有的因特网使它能够适应音频/视频数据的传送。
    对这个问题，网络界一直有较大的争论，众说纷谈。有人认为，只要大量使用光缆，网络的时延和时延抖动就可以足够小。再加上使用具有大容量高速缓存的高速路由器，在因特网上传送数据就不会有问题。也有人认为，必须将因特网改造为能够对端到端的带宽实现预留（reservation），从而根本改变因特网的协议栈--从无连接的网络转变为面向连接的网络。还有人认为，部分改动因特网的协议栈所付出的代价较小，而这也能够使多媒体信息在因特网上传输质量得到改进。
    尽管上述的争论仍在继续，但因特网的一些新的协议也在不断出现。下面我们有选择地讨论与chuansongyinpin/视频信息有关的若干问题。
    目前因特网提供的音频/视频服务大体上可分为三种类型：
    （1）流式（streaming）存储音频/视频   这种类型是先把已压缩的录制好的音频/视频文件（如音乐、电影等）存储在服务器上。用户通过因特网下载这样的文件。请注意，用户不是把文件全部下载完毕后再播放，因为这往往需要很长时间，而用户一般也不大愿意等待太长的时间。流式存储音频/视频文件下载的特点是边下载边播放，即在文件下载后不久（例如，几秒钟几十秒钟后）就开始连续播放。名词“流式”就是这样的含义。
    （2）流式实况音频/视频    这种累心过的无线电台或电视台的实况广播相似，不同之处是音频/视频节目的广播是通过因特网来传送的。流式实况音频/视频是一对多（而不是一对一）的通信。它的特点是：音频/视频节目不是事先录制好和存储在服务器中，而是在发送方边录制边发送（不是录制完毕后再发送）。在接收时也是要求能够连续播放。接收方收到节目的时间和节目中的事件的时间可以认为是同时的（相差仅仅是电磁波的传播时间和很短的信号处理时间）。流式实况音频/视频按理说应当采用多播技术才能提高网络资源的利用率，但目前实际上还是使用多个独立的单播。流式实况音频/视频现在还不普及。
    （3）交互式音频/视频   这种类型是用户使用因特网和其他人进行实时交互式通信。现在的因特网电话或因特网电视会议就属于这种类型。
    请注意，上面所讲的“边下载边播放”中的“下载”，实际上与传统意义上的“下载”有着本质的区别。传统的“下载”时把下载的内容存储在硬盘中，变成一个文件。用户在播放完毕以后，可以在任何时候把下载的文件打开甚至进行编辑和修改，然后转发给其他的朋友。但对于流式音频/视频的“下载”，实际上并没有把“下载”的内容存储在硬盘上。因此当“边下载边播放”结束后，在用户的硬盘上没有留下有关播放内容的任何痕迹。这对保护版权非常有利。播放流式音频/视频的用户，仅仅能够在屏幕上观赏播放的内容。他既不能修改节目内容，也不能把播放的内容存储下来，因此也无法以后再转发给其他人。
    于是现在就出现了一个新的词汇--流媒体（streaming media）。流媒体其实就是上面所说的流式音频/视频。流媒体的特点就是“边下载边播放”（streaming and playing），但不能存储在硬盘上成为用户的文件。在国外的一些文献中，常常把流媒体的“下载”称为streaming。目前还没有对streaming更好的译名。但一定不能把“边下载边播放”中的“下载”理解为传统意义上的下载。
    限于篇幅，下面简单介绍上面的第一种和第三种音频/视频类型的服务。
8.2流式存储音频/视频
    在讨论流式存储音频/视频文件下载方法之前，我们先回忆一下使用传统的浏览器怎样从服务器下载音频/视频文件。图说明了这种下载的三个步骤。
    （1）用户从客户机（client machine）的浏览器上用HTTP协议向服务器请求下载某个音频/视频文件，GET表示请求下载的HTTP报文。请注意，HTTP使用TCP连接。
    （2）服务器如有此文件就发送给浏览器，RESPONSE表示服务器的HTTP响应报文。在响应报文中就装有用户所要的音频/视频文件。整个下载过程可能会花费很长的时间。
    （3）当浏览器完全收下这个文件后，就可以传送给自己机器上的媒体播放器进行解压缩，然后播放。
    为什么不能直接在浏览器中播放音频/视频文件呢？这是因为这种播放器并没有集成在万维网浏览器中。因此必须使用一个单独的应用程序来播放这种音频/视频节目。这个应用程序通常称为媒体播放器（media player）。现在流行的媒体播放器有Real Networks的RealPlayer、微软的Windows Media Player和苹果公司的QuickTime。媒体播放器具有的主要功能是：管理用户界面、解压缩、消除时延抖动和处理传输带来的差错。
    请注意，图所示的传统的下载文件方法并没有涉及到“流式”（即边下载边播放）的概念。传统下载方法最大的缺点就是历时太长（几十分钟到几十小时）。必须把所有下载的音频/视频文件全部下载完毕后才能开始播放。为此，已经找出了几种改进的措施。
    8.2.1具有元文件的万维网服务器
    第一种改进的措施就是在万维网服务器中，除了真正的音频/视频文件外，还增加了一个元文件（metafile）。所谓元文件就是一种非常小的文件，它描述或指明其他文件的一些重要信息。这里离的元文件保存了有关这个音频/视频文件的信息。图说明了使用元文件下载音频/视频文件的几个步骤。
    （1）浏览器用户点击所要看的音频/视频文件的超链，使用HTTP的GET报文接入到万维网服务器。实际上，这个超链并没有直接指向所请求的音频/视频文件，而是指向一个元文件。这个元文件有实际的音频/视频文件的统一资源定位符URL。
    （2）万维网服务器吧该源文件装入HTTP响应报文的主体，发回给浏览器。在响应报文中还有指明该音频/视频文件类型的首部。
    （3）客户机浏览器收到万维网服务器的响应，分析其内容类型首部行，调用相关的媒体播放器（客户机中可能装有多个媒体播放器），把提取出的元文件传送给媒体播放器。
    （4）媒体播放器使用元文件中的URL直接和万维网服务器建立TCP连接，并向万维网服务器发送HTTP请求报文，要求下载浏览器想要的音频/视频文件。
    （5）万维网服务器发送HTTP响应报文，把该音频/视频文件送给媒体播放器。媒体播放器在存储了若干秒的音频/视频文件后（这是为了消除抖动），就以音频/视频流的形式边下载边解压缩边播放。
    8.2.2媒体播放器
    上面讲的这种措施有一个问题，就是媒体播放器使用的是HTTP的服务。但HTTP是在TCP连接上运行的。TCP要重传出错的或丢失的报文段。当网络出现拥塞时，流式音频/视频文件的播放就会暂停（因为在缓存中存放的数据已经用完了）。可见我们应当不使用TCP而使用UDP。由于万维网服务器都是使用HTTP协议，因此我们需要另外的一种服务器，即媒体服务器（media server）图给出了这一概念。
    媒体服务器也称为流失服务器（streaming server）。媒体服务器和万维网服务器可以云心刚在一个端系统内，也可以运行在两个不同的端系统中。媒体服务器与普通的万维网服务器的最大区别就是，媒体服务器支持流式音频和视频的传送。媒体播放器与媒体服务器的关系是客户与服务器的关系。现在媒体播放器不是向万维网服务器而是向媒体服务器请求音频/视频文件。媒体服务器和媒体播放器之间采用另外的协议进行交互。
    采用媒体服务器后，下载音频/视频文件的前三个步骤仍然和上一节所述的一样，区别就是后面两个步骤，即：
    （1）~（3）这三个步骤同上。
    （4）媒体播放器使用元文件中的URL接入到媒体服务器，请求下载浏览器所请求的音频/视频文件。下载可以借助于使用UDP的任何协议，例如使用实时运输协议RTP。
    （5）媒体服务器给出响应，把该音频/视频文件发送给媒体播放器。媒体播放器在迟延了若干秒后，以流的形式边下载边解压边播放。
    请注意，媒体服务器也可以在TCP连接上向媒体播放器传送音频/视频文件。由于TCP有重传丢失报文段的功能，因此音频/视频文件还原后的质量应当会更好些（只要重传时不造成缓存的清空）。但如果网络发生分组丢失而重传时应用程序的缓存已被抽空，那么媒体服务器在播放音频/视频文件时就会出现暂停。
    8.2.3实时流式协议RTSP
    实时流式协议RTSP（Real-Time Streaming Protocol）是IETF的MMUSIC工作组（Multiparty MUltimedia SessIon Control WG）开发的协议，现已成为因特网建议标准。RTSP是为了给流式过程增加更多的功能而设计的协议。RTSP本身并不传送数据，而仅仅是使媒体播放器能够控制多媒体的传送（有点像文件传送协议FTP有一个控制信道），因此RTSP又称为带外协议（out-of-band protocol）.
    RTSP协议以客户服务器方式工作，它是一个应用层的多媒体播放控制协议，用来使用户在播放从因特网下载的实时数据时能够进行控制（像在影碟机上那样的控制），如：暂停/继续、快退、快进等。因此RTSP又称为“因特网录像机遥控协议”。
    RTSP的语法和操作与HTTP协议的相似（所有的请求和响应报文都是ASCII文本）。但与HTTP不同的地方时RTSP是有状态的协议（HTT{是武状态的）。RTSP记录客户机所处于的状态（初始化状态、播放状态或暂停状态）。RFC 2326还规定，RTSP控制分组即可在TCP上传送，也可在UDP上传送。RTSP不规定音频/视频流在媒体播放器中应如何缓存。
    在使用RTSP的播放器中比较著名的是苹果公司的QuickTime和Real Networks公司的RealPlayer。
    图表示使用RTSP的媒体服务器的工作过程。
    （1）浏览器使用HTTP的GET报文向万维网服务器请求音频/视频文件。
    （2）万维网服务器从浏览器发送携带有元文件的响应。
    （3）浏览器把收到的元文件传送给媒体播放器。
    （4）媒体播放器的RTSP客户发送SETUP报文与媒体服务器的RTSP服务器建立连接。
    （5）媒体服务器的RTSP服务器发送响应RESPONSE报文。
    （6）媒体播放器的RTSP客户发送PLAY报文开始下载音频、视频文件（即开始播放）。
    （7）媒体服务器的RTSP服务器发送响应RESPONSE报文。
    此后，音频/视频文件被下载，所用的协议是运行在UDP上的。可以是后面要介绍的RTP，也可以是其他专用的协议。在音频/视频流播放的过程中，媒体播放器可以随时暂停（利用PAUSE报文）和继续播放（利用PLAY报文），也可以快进或快退。
    （8）用户在不想继续观看时，可以由RTSP客户发送TEARDOWN报文断开连接。
    （9）媒体服务器的RTSP服务器发送响应RESPONSE报文。
    请注意，以上编号的步骤（4）至（9）都是使用实时流协议RTSP协议。在图中步骤（7）后面没有编号的“音频/视频流”则使用另外的传送音频/视频数据的协议，如RTP。
8.3交互式音频/视频
    限于篇幅，在本节中我们只介绍交互式音频，即IP电环。IP电话是在因特网上传送多媒体信息的一个例子。通过IP带年华的讨论可以有助于了解在因特网上传送多媒体信息应当解决好哪些问题。
    8.3.1IP电话概述
    1.狭义的和广义的IP电话
    IP电话有多个英文同义词。常见的有VoIP（Voice over IP），Internet Telephone和VON（Voice On the Net）。但IP电话的含义却有不同的解释。
    狭义的IP电话就是指在IP网络上打电话。所谓“IP网络”就是“使用IP协议的分组交换网”的简称。这里的网络可以是因特网，也可以是包含有传统的电路交换网的互联网，不过再互联网中至少要有一个IP网络。
    广义的IP电话则不仅仅是电话通信，而且还可以是在IP网络上进行交互式多媒体实时通信（包括话音、视像等），甚至还包括即时传信IM（Instant Messaging）。即使传信是在上网时就能从屏幕上得知有哪些朋友也正在上网。若有，则彼此可在网上即时交换信息（文字的或声音的），也包括使用一点对多点的多播技术。目前流行的即时传信应用程序有QQ和MSN Messenger，很受网民欢迎。IP电话可看成是一个正在演进的多媒体服务平台，是话音、视像、数据综合的基础结构。在某些条件下（例如使用宽带的局域网），IP电话的话音质量甚至还优于普通电话。
    下面讨论狭义的IP电话，而广义的IP电话在原理上是一样的。其实IP电话并非新概念。早在20世纪70年代初期ARPANET刚开始运行不久，美国即着手研究如何在计算机网络上传送电话信息，即所谓的分组话音通信。但在很长一段时间里，分组话音通信发展得并不快。主要的原因是：
    （1）缺少廉价的高质量、低速率的话音信号编解码软件和相应的芯片。
    （2）计算机网络的传输速率和路由器处理速率均不够快，因而导致传输时延过大。
    （3）没有保证实时通信服务质量QoS（Quality of Service）的网络协议。
    （4）计算机网络的规模较小，而通信网只有在具有一定规模后才能产生经济效益。
    2.IP电话网关
    然而到了20世纪90年代中期，上述的几个问题才相继得到了较好第解决。于是美国的VocalTec在1995年初率先推出了实用化的IP电话。但是这种IP电环必须使用PC机。1996年3月，IP电话进入了一个转折点：VocalTec公司成功地推出了IP电话网关（IP Telephoney Gateway），它是公用电话网与IP网络的接口设备。IP电话网关的作用就是：
    （1）在电话呼叫阶段和呼叫释放阶段进行电话信令的转换。
    （2）在通话期间进行话音编码的转换。
    有了这种IP电话网关，就可实现PC机用户到固定电话用户打IP电话（仅需进过IP电话网关一次），以及固定电话用户之间打IP电话（需要经过IP电话网关两次）。
    图画出了IP电话的几种不同的连接方式。图中最上面的情况最简单，是两个PC机用户时间的通话。这当然不需要经过IP电话网关，但必须是双方都同时上网才能进行通话。图中间的一种情况是PC即到固定电话之间的通话。最后一种情况是两个固定电话之间打IP电话，这当然是最方便的。读者应当特别注意在哪一部分是使用电路交换还是分组交换。
    3.IP电话的通话质量
    IP电话的通话质量与电路交换电话网的通话质量有很大的差别。在电路交换电话网中任何两段之间的通话质量都是有保证的。但IP电话则不然。IP电话的通话质量主要由两个因素决定。一个是通话双方段导弹的时延和时延抖动，另一个是话音分组的丢失率。但这两个因素都是不确定的，而是取决于当时网络上的通信量。若网络上的通信量非常大以致发生了网络拥塞，那么端到端时延和时延抖动以及分组丢失率都会很高，这就导致IP电话的通话质量下降。因此，一个用户使用IP电话的通话质量取决于当时其他的许多用户的行为。请注意，电路交换电话网的情况则完全不是这样。当电路交换电话网的通信量太大时，往往使我们无法拨通电话（听到的是忙音），即电话网拒绝正在拨号的用户提供接通服务。但是只要我们拨通了电话，那么电信公司就能保证让用户满意的通话质量。
    经验证明，在电话交谈中，端到端的时延不应超过250ms，否则交谈着就会感到不自然。陆地公用电话网的时延一般只有50~70ms。但经过同步卫星的电话端到端时延就超过250ms，因此一般人都不太适应经过卫星传送过的过长的时延。IP电话的时延有时会超过250ms，因此IP电话必须努力减小端到端的时延。当通信线路产生回声时，则容许的端到端时延就更小些（有时甚至只容许即使毫秒的时延）。
    IP电话端到端时延是由以下几个因素造成的：
    （1）话音信号进行模数转换要产生时延。
    （2）已经数字化的话音比特流要积累到一定的数量才能够装配成一个话音分组，这也产生时延。
    （3）话音分组的发送需要时间，此时间等于话音分组长度与通信线路的数据率之比。

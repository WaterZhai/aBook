第10章    下一代因特网

因特网的飞速发展，新技术和新应用层出不穷，使得人们不得不考虑怎样把现在的因特网演进为下一代网络。关于下一代网络应当包括哪些问题，各家说法不一，有的问题还存在争议。从大的方面看，有两种不同的“下一代”。一是下一代因特网NGI（Next Generation Internet），另一个则是下一代电信网NGN（Next Generation Network）。这两种网络虽然不同，但却密切关联。这是因为目前打击已经有这样的公式，就是未来的电信网应当是基于分组交换的网络（而不是基于电路交换）。这样，NGN和NGI就有了共同的基础技术。由于本书定位为计算机网络，为了不使讨论的问题过大，本章的“下一代网络”仅局限于“下一代因特网”，即NGI。
NGI牵涉到许多新的技术。在本章中，我们先选择有关NGI最重要的两个问题来讨论。首先是IPv6协议，这是下一代因特网最主要的特征。其次是多协议标记交换MPLS，这是下一代因特网可能会普遍采用的技术。在讨论完这两个重要的问题后，我们还要简单介绍一下P2P文件共享技术。下面就从IPv6开始讨论。

10.1  下一代网际协议IPv6（IPng）
    10.1.1解决IP地址耗尽的措施
    IP协议是因特网的核心协议。现在使用的IP协议（即IPv4）是在20世纪70年代末期设计的，无论从计算机本身发展还是从因特网规模和网络传输速率来看，现在IPv4已很不适应了。这里最主要的问题就是32位的IP地址不够用。
    要解决IP地址耗尽的问题，可以采用以下三个措施：
    （1）采用无分类编址CIDR（见4.3.3节），事IP地址的分配更加合理。
    （2）采用网络地址转换NAT方法（见4.7.2节），可节省许多全球IP地址。
    （3）采用具有更大地址空间的新版本的IP协议，即IPv6。
    尽管上述前两项措施的采用使得IP地址耗尽的日期退后了不少，但却不能从根本上解决IP地址即将耗尽的问题。因此，治本的方法应当是上述的第三种方法。
    IETF早在1992年6月就提出要制定下一代IP，即IPng（IP Next Generation）。IPng现正式称为IPv6。1998年12月发表的RFC 2460~2463已成为因特网草案标准协议。应当指出，换一个新版的IP并非易事。世界上许多团体都从因特网的发展中看到了机遇，因此在新标准的制定过程中出于自身的经济利益而产生了激烈的争论。到目前为止，IPv6还只是草案标准阶段。有关向IPv6转换的进展情况见有关网站。
    及早开始过渡到IPv6的好处是：有更多的时间来规划平滑过渡；有更多的时间培养IPv6的专门人才；及早提供IPv6服务比较便宜。因此现在有些ISP已经开始了进行IPv6的过渡。
    下面是IPv6的简介。
    10.1.2  IPv6的基本首部
    IPv6仍支持无连接的传送，但将协议数据单元PDU称为分组，而不是IPv4的数据报。为方便起见，本书仍采用数据报这一名词。
    IPv6所引进的主要变化如下：
    （1）更大的地址空间。IPv6把地址从IPv4的32位增大到4倍，即增大到128位，使地址空间增大了2^96倍。这样打的地址空间在可预见的将来是不会用完的。
    （2）扩展的地址层次结构。IPv6由于地址空间很大，因此可以划分为更多的层次。
    （3）灵活的首部格式。IPv6数据报的首部和IPv4的并不兼容。IPv6定义了许多可选的扩展首部，不仅可提供比IPv4更多的功能，而且还可提高路由器的处理效率，这是因为路由器对扩展首部不进行处理（除逐跳扩展首部外）。
    （4）改进的选项。IPv6允许数据报包含有选项的控制信息，因而可以包含一些新的选项。我们知道，IPv4所规定的是固定不变的。
    （5）允许协议继续扩充。这一点很重要，因为技术总是在不断地发展（如网络硬件的更新）而新的应用也还会出现。但我们知道，IPv4的功能是固定不变的。
    （6）支持即插即用（即自动配置）。
    （7）支持资源的预分配。IPv6支持实时视像等要求保证一定的带宽和时延的应用。
    （8）IPv6首部改为8字节对齐（即首部长度必须是8字节的整数倍）。原来的IPv4首部是4字节对齐。
    IPv6数据报在基本首部（base header）的后面允许有零个或多个扩展首部（extension header），再后面使数据。但请注意，所有的扩展首部都不属于IPv6数据报的首部。所有的扩展首部和数据合起来叫做数据报的有效载荷（payload）或净负载。
                |<----------有效载荷--------->|
                |<-------选项------->|
        |基本首部|扩展首部1|…|扩展首部N|数据部分|
        |<-------------IPv6数据报------------>|
    图是IPv6数据报的基本首部。在基本首部后面使有效载荷，它包含运输层的数据和可能选用的扩展首部。
    与IPv4相比，IPv6对首部中的某些字段进行了如下的更改：
    ·取消了首部长度字段，因为它的首部长度是固定的（40字节）。
    ·取消了服务类型字段，因为优先级和流标号字段合起来实现了服务类型字段的功能。
    ·取消了总长度字段，改用有效载荷长度字段。
    ·取消了标识、标志和片偏移字段，因为这些功能已包含在分片扩展首部中。
    ·把TTL字段改称为跳数限制字段，但作用是一样的（名称与作用更加一致）。
    ·取消了协议字段，改用下一个首部字段。
    ·取消了检验和字段，这样就加快了路由器处理数据报的速度。我们知道，在数据链路层对检测出有差错的帧就丢弃。在运输层，当使用UDP时，若检测出有差错的用户数据报就丢弃。当使用TCP时，对检测出有差错的报文段就重传，直到正确传送到目的进程为止。因此在网络层的差错检测可以精简掉。
    ·取消了选项字段，而用扩展首部来实现选项功能。
    由于把首部中不必要的功能取消了，使得IPv6首部的字段数减少到只有8个（虽然首部长度增大了一倍）。
    下面解释IPv6基本首部中各字段的作用。
    （1）版本（version）    占4位。它指明了协议的版本，对IPv6该字段是6。
    （2）通信量类（traffic class）    占8位。这是为了区分不同的IPv6数据报的类别或优先级。目前正在进行不同的通信量类性能的实验。
    （3）流标号（flow label）    占20位。IPv6的一个新的机制是支持资源预分配，并且允许路由器把每一个数据报与一个给定的资源分配相练习。IPv6提出流（flow）的抽象概念。所谓“流”就是互联网络上从特定源点到特定终点（单播或多播）的一系列数据报（如实时音频或视频传输），而在这个“流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。因此流标号对实时音频/视频数据的传送特别有用。对于传统的电子邮件或非实时数据，流标号则没有用处，把它置为0即可。
    （4）有效载荷长度（payload length）   占16位。它指明IPv6数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内）。这个字段的最大值是64KB（65535字节）。
    （5）下一个首部（next header）   占8位。它相当于IPv4的协议子弹或可选字段。
    ·当IPv6数据报没有扩展首部时，下一个首部字段的作用和IPv4的协议字段一样，它的值指出了基本首部后面的数据应交付给IP上面的哪一个高层协议（例如：6或17分别表示应交付给TCP或UDP）。
    ·当出现扩展首部时，下一个首部字段的值就标识后面第一个扩展首部的类型。
    （6）跳数限制（hop limit）    占8位。用来防止数据报在网络中无限期地存在。源点在每个数据报发出时即设定某个跳数限制（最大为255跳）。每个路由器在转发数据报时，要先把跳数限制字段中的值减1.当跳数限制的值为零时，就要把这个数据报丢弃。
    （7）源地址    占128位。是数据报的发送端的IP地址。
    （8）目的地址   占128位。是数据报的接收端的IP地址。
    下一节我们先讨论IPv6的扩展首部。
    10.1.3 IPv6的扩展首部
    1.扩展首部及下一个首部字段
    大家知道，IPv4的数据报如果在其首部中使用了选项，那么沿数据报传送的路径上的每一个路由器都必须对这些选项一一进行检查，这就降低了路由器处理数据报的速度。然而实际上很多的选项在途中的路由器上是不需要检查的（因为不需要使用这些选项的信息）。IPv6把原来IPv4首部中选项的功能都放在扩展首部中，并把扩展首部留给路径两端的源点和终点的主机来处理，而数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部），这样就大大提高了路由器的处理效率。
    在RFC 2460中定义了以下六种扩展首部：
    （1）逐跳选项。
    （2）路由选项。
    （3）分片。
    （4）鉴别。
    （5）封装安全有效载荷。
    （6）目的站选项。
    每一个扩展首部都由若干个字段组成，它们的长度也各不同。但所有扩展首部的第一个字段都是8位的“下一个首部”字段。此字段的值指出了在该扩展首部后面的字段是什么。当使用多个扩展首部时，应按以上的先后顺序出现。高层首部总是放在最后面。
    图表示当数据报不包含扩展首部时，固定首部中的下一个首部字段就相当于IPv4首部中的协议字段，此字段的值指出后面的有效载荷应当交付给上一层的哪一个进程。例如，当有效载荷是TCP报文段时（固定首部中下一个首部字段的值就是6，这个数值和IPv4中协议字段填入的值一样），后面的有效载荷就被交付给上层的TCP进程。
    图表示在基本首部后面有两个扩展首部的情况。所有扩展首部中的第一个字段“下一个首部”的值都是指出了跟随在此扩展首部后面的是何种首部。例如，第一个扩展首部时路由选择首部，其“下一个首部字段”的值就指出后面的扩展首部是分片扩展首部，而分片扩展首部的“下一个首部字段”的值又指出再后面的首部是TCP/UDP的首部。
    2.扩展首部举例
    下面以分片扩展首部为例来说明扩展首部的作用。
    IPv6把分片限制为由源点来完成。源点可以采用保证的最小MTU（1280字节），或者在发送数据前完成路径最大传送单元发现（Path MTU Discovery），以确定沿着该路径到终点的最小MTU。当需要分片时，源点在发送数据报前先把数据报分片，保证每个数据报片都小于此路径的MTU。因此，分片时端到端的，路径图中的路由器不允许进行分片。
    IPv6基本首部中不包含用于分片的字段，而是在需要分片时，源点在每一数据报片的基本首部的后边插入一个小的分片扩展首部，它的格式如图所示。

    IPv6保留了IPv4分片的大部分特征，其分片扩展首部共有以下几个字段：
    （1）下一个首部（8位）    指明紧接着这个扩展首部的下一个首部。
    （2）保留（10位）    为今后使用。该字段在第8~15位和第29~30位。
    （3）片偏移（13位）   指明本数据报片在原来的数据报中的偏移量，以8个字节为表示单位，可见每个数据报片的长度必须是8个字节的整数。
    （4）M（1位）    M=1表示后面还有数据报片。M=0则表示这已是最后一个数据报片。
    （5）标识符（32位）   由源点产生的、用来唯一地标志数据报的一个32位数。每产生一个新数据报，就把这个标识符加1.采用32位的标识符，可使得在源点发送到同样的终点的数据报中，在数据报的生存时间内无相同的标识符（即使是高速网络）。
    下面是个例子。设IPv6数据报的有效载荷为3000字节。现用下层的以太网传送此数据报，而以太网的最大传送单元MTU是1500字节，因此必须进行分片。分成的三个数据报片的数据部分分别是1400字节，1400字节和200字节。分片需要在IPv6的基本首部后面增加一个分片扩展首部。分片的结果如图所示。
    采用端到端分片的方法可以减少路由器的开销，因而允许路由器在单位时间内处理更多的数据报。然而，端到端的分片方法有一个重要的后果：它改变了因特网的基本假设。
    因特网原来被设计为允许在任何时候改变路由。例如，如果一个网络或者路由器出故障，那么就可以重新选择另一条不同的路由。这样做的主要好处是它的灵活性。然而IPv6就不能这样容易地改变路由，因为改变路由可能也要改变路径最大传送单元MTU。如果新路径的MTU小于原来路径的MTU，那么就要想办法解决这个问题。
    为此，IPv6允许中间路由器采用隧道技术来传送太长的数据报。当路径途中的路由器需要对数据报进行分片时，路由器既不插入数据报片扩展首部，也不改变基本首部红的各个字段。相反，这个路由器创建一个全新的数据报，然后把这个新的数据报分片。并在各个数据报片中插入扩展首部和新的基本首部。最后，路由器把每个数据报片发送给最后的终点，而在终点把收到的各个数据报片收集起来，组装成原来的数据报，再从中抽取出数据部分。
    10.1.4   IPv6的地址空间
    1.地址的类型与地址空间
    一般来讲，一个IPv6数据报的目的地址可以是以下三种基本类型地址之一：
    （1）单播（unicast）    单播就是传统的点对点通信。
    （2）多播（multicast）    多播是一点对多点的通信，数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，而是将广播看作多播的一个特例。
    （3）任播（anycast）    这是IPv6增加的一种类型。任播的终点是一组计算机，但数据报只交付给其中的一个，通常是距离最近的一个。
    IPv6把实现IPv6的主机和路由器均称为结点。由于一个结点可能会使用多条链路与其他的一些结点相连，因此一个结点就可能有多个与链路相连的接口。这样，IPv6给结点的每一个接口指派一个IP地址。一个结点可以有多个单播地址，而其中的任何一个地址都可以当作到达该结点的目的地址。
    在IPv6中，每个地址占128位，地址空间大于3.4x10^38。如果整个地球表面（包括陆地和水面）都覆盖着计算机，那么IPv6允许每平方米拥有7x10^23个IP地址。如果地址分配速率是每微秒分配100万个地址，则需要10^19年的时间才能将所有可能的地址分配完毕。可见在想象到的将来，IPv6的地址空间是不可能用完的。
    巨大的地址范围还必须使维护互联网的人易于阅读个操纵这些地址。IPv4所用的点分十进制记法现在也不够方便了。例如，一个用点分十进制记法的128位的地址为：
    104.230.140.100.255.255.255.255.0.0.17.1287.150.10.255.255
    为了使地址再捎简洁些，IPv6使用冒号十六进制记法（colon hexadecimal notation，简写为colon hex），它把每个16位的值用十六进制值表示，各值之间用冒号分隔。例如，如果前面所给的点分十进制记法的值改为冒号十六进制记法，就变成了：
    68E6：8C64：FFFF：FFFF：0：1180：960A：FFFF
    在十六进制记法中，允许把数字前面的0省略。上面就把0000中的前三个0省略了。
    冒号十六进制记法还包括两个技术使它尤其有用。首先，冒号十六进制记法可以允许零压缩（zero compression），即一连串连续的零可以为一对冒号所取代，例如：
    FF05：0：0：0：0：0：0：B3
    可以写成：FF05：：B3
    为了保证零压缩有一个不含混的解释，规定在任意地址中只能使用一次零压缩。该技术对已建议的分配策略特别有用，因为会有许多地址包含较长连续的零串。
    其次，冒号十六进制记法可结合使用点分十进制记法的后缀。我们下面会看到这种结合在IPv4向IPv6的转换阶段特别有用。例如，下面的串是一个合法的冒号十六进制记法：
    0：0：0：0：0：0：128.10.2.1
    请注意，在这种记法中，虽然为冒号所分隔的每个值是两个字节（16位）的量，但每个点分十进制部分的值则指明一个字节（8位）的值。再使用零压缩即可得出：
    ：：128.10.2.1
    下面再给出几个使用零压缩的例子。
    1080：0：0：0：800：200C：417A    记为    1080：：8：800：200C：417A
    FF01：0：0：0：0：0：0：101（多播地址）    记为    FF01：：101
    0：0：0：0：0：0：0：1（环回地址）   记为    ：：1
    0：0：0：0：0：0：0：0（未指明地址）    记为    ：：
    CIDR的斜线表示法仍然可用。例如，60位的前缀12AB00000000CD3（十六进制表示的15个字符，每个字符代表4位二进制数字）可记为：
    12AB：0000：0000：CD30：0000：0000：0000：0000/60
    或   12AB：：CD30：0：0：0：0/60
    或   12AB：0：0：CD30：：/60
    但不允许记为：
    12AB：0：0：CD3/60（不能把16位地址块最后的0省略）
    或   12AB：：CD30/60（这是地址12AB：0：0：0：0：0：0：CD30的前60位二进制）
    或   12AB：：CD3/60（这是地址12AB：0：0：0：0：0：0：0CD3的前60位二进制）
    2.地址空间的分配
    根据2006年2月发表的RFC 4291，IPv6的地址指派情况如下面的表所示。（目前是因特网的建议标准）。可以看出，现在已经被指派的地址仅仅占总地址很少的一部分。
        |最前面的几位二进制数字|地址的类型      |占地址空间的份额|
        |0000 0000           |IETF保留       |1/256          |
        |0000 0001           |IRTF保留       |1/256          |
        |0000 001            |IETF保留       |1/128          |
        |0000 01             |IETF保留       |1/64           |
        |0000 1              |IETF保留       |1/32           |
        |0001                |IETF保留       |1/16           |
        |001                 |全球单播地址    |1/8            |
        |010                 |IETF保留       |1/8            |
        |011                 |IETF保留       |1/8            |
        |100                 |IETF保留       |1/8            |
        |101                 |IETF保留       |1/8            |
        |110                 |IETF保留       |1/8            |
        |1110                |IETF保留       |1/16           |
        |1111 0              |IETF保留       |1/32           |
        |1111 10             |IETF保留       |1/64           |
        |1111 110            |唯一本地单播地址|1/128          |
        |1111 1110 0         |IETF保留       |1/512          |
        |1111 1110 10        |本地链路单播地址|1/1024         |
        |1111 1110 11        |IETF保留       |1/1024         |
        |1111 1111           |多播地址        |1/256          |
    3.特殊地址
    我们这里要介绍一下IPv6的几种特殊地址。
    （1）未指明地址    这是16字节的全0地址，可缩写为两个冒号“：：”。这个地址不能用作目的地址，而只能为某个主机当做源地址使用，条件是这个主机还没有配置到一个标准的IP地址。
    （2）环回地址   IPv6的环回地址是0：0：0：0：0：0：0：1（即：：1），作用和IPv4的环回地址一样。
    （3）基于IPv4的地址    前缀为0000 0000保留一小部分地址作为与IPv4兼容的，这是因为必须要考虑到在比较长的时期IPv4和IPv6将会同时存在，而有的结点不支持IPv6。因此数据报在这两类结点之间转发时，就必须进行地址的转换。图表示把IPv4地址嵌入到IPv6地址的方法。这种IPv6地址的前80位都是0，接着的16位是全1，然后是嵌入的IPv4地址。这种地址叫做“IPv4映射的IPv6地址”，它只是把IPv4地址转换为IPv6地址的形式，但IPv6设备并不能设备这种设备。
    原来还有一种兼做“IPv4兼容的IPv6地址”，它的前96位都是0，而最低32位则是嵌入的IPv4地址。这种地址原来用在自动隧道技术机制中。使用这样的地址的结点用的是双协议栈，即支持IPv4也支持IPv6。但2006年2月发表的RFC 4291取消了“IPv4兼容的IPv6地址”，因为在从IPv4向IPv6的转换过程中不再使用这种地址了。
    （4）本地链路单播地址（Link-Local Unicast Address）   这种地址的使用情况是这样的。有些组织的网络使用TCP/IP协议，但并没有连接到因特网上。这可能是由于担心因特网不很安全，也可能是由于还有一些准备工作需要完成。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和因特网上的其他主机通信。
    4.全球单播地址的等级结构
    IPv6把1/8的地址空间划分为全球单播地址，因为单播地址使用得最多。IPv4发展过程中最重要的变化之一就是单播地址所使用的划分策略，以及由此产生的多级地址体系。我们知道IPv4的地址最初是分类地址，后来发展为无分类地址。这种地址实际上是两级结构，即把地址划分为一个全球唯一的前缀和一个后缀。考虑到让IPv6地址更加便于用户使用。在2003年8月公布了RFC 3587，修改了原来对IPv6地址的划分方法，取消了原来划分出的顶级聚合（TLA）和下一级聚合（NLA）等字段。图表示现在使用的IPv6单播地址的建议划分方法。图中各字段中的术语都是RFC 3587上使用的。
        第一级                   第二级           第三级
        |全球路由选择前缀（48位）|子网标识符（16位）|接口标识符（64位）|
    （1）全球路由选择前缀（Global Routing Prefix）    这是第一级地址，占48位，分配给各公司和组织，用于因特网中路由器的路由选择。这相当于最初分类的IPv4地址中的网络号字段。请注意，现在这类单播地址最前面的三位是001，因此可以进行分配的地址共有45位，是IPv4全部地址空间的2^13倍（即8192倍）。IETF让各地区的互联网登记机构（如APNIC，ARIN，LACNIC和RIPE）自己决定怎样进一步划分这部分地址。
    （2）子网标识符（Subnet ID）   这是第二级地址，占16位，用于各公司和组织创建自己的子网。对于小公司，可以把这个字段置为全0。
    （3）接口标识符（Interface ID）    这是第三级地址，占64位，指明主机或路由器单个的网络接口。实际上这就相当于分类的IPv4地址中的主机号字段。
    与IPv4不同，IPv6地址的主机号字段有64位之多，它足够大，因而可以将各种借口的硬件地址直接进行编码。这样，IPv6只需把128位地址中的最后64位提取出就可得到相应的硬件地址，而不需要使用地址解析协议ARP进行地址解析。IPv6使用一个叫做邻站发现协议（neighbor discovery protocol）使一个结点能够确定哪些计算机是和它相邻接的（在网际控制报文协议ICMP新版本ICMPv6中使用这个协议）。
    为了保证可操作性，所有的计算机都必须对硬件地址使用同样的编码方法。因此，IPv6还指明了各种形式的硬件地址的精确编码方法。
    IEEE定义了一个标准的64位全球唯一地址格式EUI-64。它和3.4.3节介绍的EUI-48相似。EUI-64的前三个字节（24位）仍为公司标识符。但后面的扩展标识符是五个字节（40位）。当一个EUI-64硬件地址需要转换为IPv6地址时，只要把它放入IPv6地址中的接口标识符字段中即可。但要把公司标识符的第1字节的最低第2位（即G/L位）置为1（因为这时是全球管理的IP地址，G/L位必须是1）。
    较为复杂的是当需要把48位的以太网硬件地址转换为IPv6地址。图表示地址转换的方法。图中上面的地址是48位的IEEE 802以太网地址（每一个字节的高位在前），其中的前24位是公司标识符（用字母c表示），但第一字节的最低位是I/G位（用字母g表示），而第一字节的最低第二位是G/L位（图中假定是0）。
    从图可看出，把48位的以太网地址放入到IPv6地址中的64位的接口标识符时，应增加16位才行。IPv6规定者16位的十六进制值是0xFFFE，并且应插入在以太网地址前24位的公司标识符之后。此外，公司标识符的第一字节的最低第二位必须置为1。以太网地址最后24位的扩展标识符则复制到接口标识符的最后24位。
    10.1.5从IPv4向IPv6过渡
    由于现在整个因特网上使用老版本IPv4的路由器的数量太大，因此，“规定一个日期，从这一天起所有的路由器一律都改用IPv6”，显然是不可行的。这样，向IPv6过渡只能采用逐步演进的办法，同时，还必须使新安装的IPv6系统能够向后兼容。这就是说，IPv6系统必须能够接收和转发IPv4分组，并且能够为IPv4分组选择路由。
    下面介绍两种向IPv6过渡的策略，即使用双协议栈和使用隧道技术。
    1.双协议栈
    双协议栈（dual stack）是指在完全过渡到IPv6之前，使一部分主机（或路由器）装有两个协议栈，一个IPv4和一个IPv6。因此双协议栈主机（或路由器）既能够和IPv6的系统通信，又能够和IPv4的系统进行通信。双协议栈的主机（或路由器）记为IPv6/IPv4，表明它具有两种IP地址：一个IPv6地址和一个IPv4地址。
    双协议栈主机在和IPv6主机通信时是采用IPv6地址，而和IPv4主机通信时就采用IPv4地址。大麻双协议栈主机怎样知道目的主机时采用哪一种地址呢？它是使用域名系统DNS来查询。若DNS返回的是IPv4地址，双协议栈的源主机就使用IPv4地址。但当DNS返回的是IPv6地址，源主机就使用IPv6地址。
    图所示的情况是源主机A和目的主机F都使用IPv6，所以A向F发送IPv6数据报，路径是A->B->C->D->E->F。中间B到E这段路径是IPv4网络，因此路由器B不能向C转发IPv6数据报，因为C只使用IPv4协议。由于B是IPv6/IPv4路由器，因此路由器B把IPv6数据报首部转换为IPv4数据报首部后发送给C。等到IPv4数据报到达IPv4网络的出口路由器E时（E也是IPv6/IPv4路由器），再恢复成原来的IPv6数据报。需要注意的是：IPv6首部中的某些字段却无法恢复。例如，原来IPv6首部中的流标号X在最后回复出的IPv6数据报只能变为空缺。这种信息的缺失是使用首部转换方法所不可避免的。
    2.隧道技术
    向IPv6过渡的另一种方法是隧道技术（tunneling）。图给出了隧道技术的工作原理。这种方法的要点就是在IPv6数据报要进入IPv4网络时，将IPv6数据报封装成为IPv4数据报（整个的IPv6数据报变成了IPv4数据报的数据部分）。然后，IPv6数据报就在IPv4网络的隧道中传输。当IPv4数据报离开IPv4网络中的隧道时再把数据部分（即原来的IPv6数据报）交给主机的IPv6协议栈。图表示在IPv4网络中打通了一个从B到E的“IPv6隧道”，路由器B是隧道的入口而E是出口。图表示数据报的封装要点。请读者注意，在隧道中传送的数据报的源地址是B而目的地址是E。
    要使双协议栈的主机知道IPv4数据报里面封装的数据是一个IPv6数据报，就必须把IPv4首部的协议字段的值设置为41（41表示数据报的数据部分是IPv6数据报）。
    现在有不少人怀疑是否能够在近期在整个因特网范围实现从IPv4到IPv6的过渡。至少，在北美有一些因特网服务提供者（ISP）表示他们近期并不打算将其路由器升级到IPv6。他们认为，只有不多的用户需要使用IPv6的功能，而对多数的用户只要对IPv4协议打些补丁（例如，地址转换程序）就可以了。目前对IPv6比较感兴趣的是欧洲和亚洲的一些运营商。
    从20世纪90年代初期起，就陆续出现了许多新的网络层协议，如IPv6、多播协议，以及资源预留协议RSVP等，然而它们并没有立即获得广泛的应用。这里的原因就是：把新的协议引入网络层就像改造一座已建好的大楼的地基（大楼里面已有人办公和居住）。如果不暂时把这些人迁出大楼，甚至拆除大楼的某些部分，就很难进行大楼地基的改造。相反，因特网上的应用层协议却能比较容易地添加上去，就像我们可以较容易地改变大楼内一些房间里的装潢那样。因此，在可预见的将来，作为因特网基础的网络层的改变估计会比应用层的包边缓慢得多。
    10.1.6 ICMPv6
    和IPv4一样，IPv6也不保证数据报的可靠交付。因特网中的路由器可能会丢失数据报。因此IPv6也需要使用ICMP来反馈一些差错信息。但旧版本的、适合于IPv4的ICMP并不能满足IPv6全部的要求。因此，ICMP也制定出YUIPv6配套使用的ICMPv6版本。但应注意，IETF并不是把所有的ICMPv6报文都集中到一个RFC 文档中，而是分成好几个RFC 文档。例如，在RFC 2463中定义了6中类型的ICMPv6报文，在RFC 2461中定义了5中类型的ICMPv6报文，而在RFC 2710中定义了3中类型的ICMPv6报文。目前RFC 2461和2463是因特网草案标准，而RFC 2710是因特网建议标准。
    我们知道，ICMP是与IPv4协议配套使用的网络层其他四个协议之一（另外三个协议是ARP，RARP和IGMP）。但IPv6的情况不同。这是因为ARP和IGMP这两个协议已经被并入了IPv6，而RARP协议也被取消了。因此与IPv6配套使用的只有ICMPv6一个协议。
    ICMPv6的报文格式和IPv4使用的ICMP的相似（见第4章的图4-27），即前四个字节的字段名称都是一样的，但ICMPv6把第5个字节起的后面部分都作为报文主体。
    表是常用的集中ICMPv6报文。
        |ICMP报文种类                   |类型的值|ICMP报文的类型|定义的RFC文档|
        -------------------------------------------------------------------
        |差错报告报文                    |1      |终点不可达    |RFC 2463    |
        |                               |2      |分组太长      |            |
        |                               |3      |时间超过      |            |
        |                               |4      |参数问题      |            |
        |-------------------------------|-------|-------------|            |
        |提供信息的报文                  |128    |回送(Echo)请求|            |
        |                               |129    |回送回答      |            |
        |-------------------------------|-------|-------------|------------|
        |多播听众发现报文（组管理协议使用）|130    |多播听众查询  |RFC 2710    |
        |                               |131    |多播听众报告  |            |
        |                               |132    |多播听众完成  |            |
        |-------------------------------|-------|-------------|------------|
        |邻站发现报文                    |133    |路由器询问    |RFC 2461    |
        |                               |134    |路由器通告    |            |
        |                               |135    |邻站询问      |            |
        |                               |136    |邻站通告      |            |
        |                               |137    |改变路由      |            |
    在差错报告报文中，可以用不同的代码表示不同的情况。例如，对于“终点不可达报文”，有以下四种情况无路由到达终点、在管理上禁止与终点通信、地址不可达、端口不可达等。对于“时间超过报文”，有跳数限制超过和分片重装时间超过两种情况、对于“参数问题报文”，有首部字段差错、下一个首部类型无法识别、IPv6选项无法识别等。
    ICMPv6报文的前面是IPv6首部和零个或更多的IPv6扩展首部。在ICMPv6前面的一个首部中的“下一个首部字段”的值应当置为58.请注意：这和IPv4中标志ICMP的值不同，在IPv4中标志ICMP的值是1.
    限于篇幅，本小节只简单介绍了一下ICMPv6。要进一步了解可参考有关的RFC文档。
10.2多协议标记交换MPLS
    10.2.1MPLS的产生背景
    在20世纪80年代，随着因特网的迅速普及，人们开始探索如何提高分组转发速度的方法。这是出现了一种思路：用面向连接的方式取代IP的无连接分组交换方式。这样就可以利用更快捷的查找算法，而不必使用最长前缀匹配的方法来查找路由表。这种基本概念就叫做交换（switching）。人们经常把这种交换概念与异步传递方式ATM（Asynchronous Transfer Mode）联系起来，这仅仅是因为这两个概念当时是在同一时期出现的。然而我们在下面就会阐明，在传统的路由器上也可以实现这种交换。
    为了实现交换，可以利用面向连接的概念（具体的在后面介绍），使每个分组携带一个叫做标记（label）的小整数（这叫作给分组打上一个标记）。当分组到达交换机（即标记交换路由器）时，交换机读取分组的标记，并用标记值来检索分组转发表。图描述了这一概念。
    作为说明原理的例子，图画出了交换机S1中已建立的分组转发表。每个进入交换机的分组都携带一个标记。图中画出了携带标记0的分组从S1的接口1转发出去，而携带标记1的分组则从S1的接口0转发出去。这样的转发速度要比查找路由器快得多。
    按照以上思路，IETF于1997年成立了MPLS工作组，以便开发出一种新的协议标准。这种新的协议取名为多协议标记交换MPLS（MultiProtocol Label Switching）。“多协议”表示在MPLS的上面可以采用多种协议。IETF还综合了许多公司的类似技术，如Cisco公司的标记交换TAG（TAG Switching），以及Ipsilon公司的IP交换（IP Switching）等。2001年1月MPLS终于成为因特网的建议标准。
    现在MPLS受到网络界人士的高度重视，因为MPLS具有以下三个方面的特点：
    （1）支持面向连接的服务质量。
    （2）支持流量工程，平衡网络负载。
    （3）有效地支持虚拟专用网VPN。
    下面讨论MPLS的基本原理。
    10.2.2MPLS的工作原理
    1.基本工作过程
    在传统的IP网络中，

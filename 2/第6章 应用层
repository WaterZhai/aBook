第6章   应用层

在前五章我们已经详细地讨论了计算机网络提供通信服务的过程。但是我们还没有讨论这些通信服务是如何提供给应用进程来使用过的。本章就是讨论各种应用进程通过什么样的应用层协议来使用网络所提供的这些通信服务。
这里需要再强调一下，每个应用层协议都是为了解决某一类应用问题，而应用问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的。应用层的具体内容就是规定应用进程在通信时所遵循的协议。
应用层的许多协议都是基于客户服务器方式。即使是对等通信方式，实质上也是一种特殊的客户服务器方式。这里再明确一下，客户（client）和服务器（Server）都是指通信中所设计的两个应用进程。客户服务器方式所描述的是进程之间服务和被服务的关系。这里最主要的特征就是：客户是服务请求方，服务器是服务提供方。
下面先讨论许多应用协议都要使用的域名系统。在介绍了文件传送协议和远程登录协议后，就重点介绍万维网的工作原理及其主要协议。由于万维网的出现使因特网得到了飞速的发展，因此万维网在本章中占有最大的篇幅，也本章的重点。接着讨论用户最常用的因特网电子邮件，最后，介绍有关网络管理方面的问题以及有关网络编程的概念。对应用层更深入的学习可参阅【come04】【come06】【tane03】及有关标准。

6.1域名系统DNS
    6.1.1域名系统概述
    域名系统DNS（Domain Name System）是因特网使用的命名系统，用来把便于人们使用的机器名字转换为IP地址。域名系统其实就是名字系统。为什么不叫“名字”而叫“域名”呢？这是因为在这种因特网的命名系统中使用了许多的“域”（domain），因此就出现了“域名”这个名词。“名字系统”没有说清用在什么地方，而“域名系统”就很明确地指明这种系统是用在因特网中。在下一节我们就会讲到，在域名结构中会出现很重要的“点(.)”。
    许多应用层软件经常直接使用域名系统DNS，但计算机的用户只是简介而不是直接使用域名系统。
    用户与因特网上某个主机通信时，显然不愿意使用很难记忆的长达32位二进制主机地址。即使是点分十进制IP地址也并不太容易记忆。相反，大家愿意使用比较容易记忆的主机名字。早在ARPANET时代，整个网络只有数百台计算机，那时适用一个叫做hosts的文件，列出所有主机名字和相应的IP地址。只要用户输入一个主机名字，计算机就可很快地把这个主机名字转换成机器能够识别的二进制IP地址。
    为什么机器在处理IP数据报时要使用IP地址而不使用域名呢？这是因为IP地址的长度是固定的32位（如果是IPv6地址，那就是128位，也是定长的），而域名的长度并不是固定的，机器处理起来比较困难。
    从理论上讲，整个因特网可以只使用一个域名服务器，使它装入因特网上所有主机名，并回答所有对IP地址的查询。然而这种做法并不可取。因为因特网规模很大，这样的域名服务器肯定会因过负荷而无法正常工作，而且一旦域名服务器出现故障，整个因特网就会瘫痪。因此，早在1983年因特网就开始采用层次树状结构的命名方法，并使用分布式的域名系统DNS。DNS的因特网标准是RFC 1034，1035。
    因特网的域名系统DNS被设计成为一个联机分布式数据库系统，并采用客户服务器方式。DNS使大多数名字都在本地进行解析（resolve），仅少量解析需要在因特网上通信，因此DNS系统的效率的效率很高。由于DNS是分布式系统，即使单个计算机出了故障，也不会妨碍整个DNS系统的正常运行。
    域名到IP地址的解析是由分布在因特网上的许多域名服务器程序（可简称为域名服务器）共同完成的。域名服务器程序在专设的结点上运行，而人们也常把运行域名服务器程序的机器称为域名服务器。
    域名到IP地址的解析过程的要点如下：当某一个应用进程需要把主机名解析为IP地址时，该应用进程就调用解析程序（resolver），并成为DNS的一个客户，把待解析的域名放在DNS请求报文中，以UDP用户数据报方式发给本地域名服务器（使用UDP是为了减少开销）。本地域名服务器在查找域名后，把对应的IP地址放在回答报文中返回。应用进程获得目的主机的IP地址后即可进行通信。
    若本地域名服务器不能回答该请求，则此域名服务器就暂时称为DNS中的另一个客户，并向其他域名服务器发出查询请求。这种过程直至找到能够回答该请求的域名服务器为止。上述的这种查找过程，后面还要进一步讨论。
    6.1.2因特网的域名结构
    早期的因特网使用了非等级的名字空间，其优点是名字简短。但当因特网上的用户数急剧增加时，用非等级的名字空间来管理一个很大的而且是经常变换的名字集合是非常困难的。因此，因特网后来就采用了层次树状结构的命名方法，就像全球邮政系统和电话系统那样。采用这种命名方法，任何一个连续在因特网上的注意或路由器，都以一个唯一的层次结构的名字，即域名（domain name）。这里，“域”（domain）是名字空间中一个可被管理的划分。域还可以划分为子域，而子域还可继续划分为子域的子域，这样就形成了顶级域、二级域、三级域，等等。
    从语法上讲，每一个域名都是由标号（label）序列组成，而各标号之间用点隔开（请注意，是小数点“.”，不是中文的句号“。”）。例如下面的域名:mail.cctv.com(三级域名.二级域名.顶级域名)
    就是中央电视台用于收到电子邮件的计算机（即邮件服务器）的域名，它由三个标号组成，其中标号com是顶级域名，标号cctv是二级域名，标号mail是三级域名。
    DNS规定，域名中的标号都由英文字母或数字组成，每一个标号不超过63个字符（但为了记忆方便，最好不要超过12个字符），而不区分大小写字母（例如，CCYV或cctv在域名中是等效的）。标号中除连字符（-）外不能使用其他标点符号。级别最低的域名写在最左边，而级别最高的顶级域名则写在最右边。由多个标号组成的完整域名总共不超过255个字符。DNS既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思。各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由ICANN进行管理。用这种方法可使每一个域名在整个因特网范围内是唯一的，并且也容易设计出一种查找域名的机制。
    需要注意的是，域名只是个逻辑概念，并不代表计算机所在的物理地点。变成的域名和使用有助记忆的字符串，是为了便于人来使用。而IP地址是定长的32位二进制数字则非常便于机器进行处理。这里需要注意，域名中的“点”和点分十进制中的“点”并无一一对应的关系。点分十进制IP地址中一定是包含三个“点”，但每一个域名中“点”的数目则不一定正好是三个。
    据2006年12月的统计，现在顶级域名TLD（Top Level Domain）已有265个【W-TLD】，分为三大类：
    （1）国家顶级域名nTLD：采用ISO 3166的规定。如：cn表示中国，us表示美国，uk表示英国，等等。国家顶级域名又常记为ccTLD（cc表示国家代码country-code）。到2006年12月为止，国家顶级域名总共有247个。
    （2）通用顶级域名gTLD：到2006年12月为止，通用顶级域名的总数已经达到18个【W-gTLD】。最常见的通用顶级域名有7个，即：
        com（公司企业），net（网络服务机构），org（非营利性的组织），int（国际组织），edu（美国专用的教育机构），gov（美国的政府部门），mil表示（美国的军事部门）。
        其余11个通用顶级域名是：
        aero（航空运输企业），biz（公司和企业），cat（加泰隆人的语言和文化团体），coop（合作团体），info（各种情况），jobs（人力资源管理者），mobi（移动产品与服务的用户和提供者），museum（博物馆），name（个人），pro（有证书的专业人员），travel（旅游业）。
    （3）基础结构域名（infrastructure domain）：这种顶级域名只有一个，即arpa，用于反向域名解析，因此又称为反向域名。
        在国家顶级域名下注册的二级域名均由该国家自行确定。例如，顶级域名为jp的日本，将其教育和企业机构的二级域名定为ac和co，而不用edu和com。
        我国把二级域名划分为“类别域名”和“行政区域名”两大类。
        “类别域名”共7个，分别为ac（科研机构）；com（工、商、金融等企业）；edu（中国的教育机构）；gov（中国的政府机构）；mil（中国的国防机构）；net（提供互联网络服务的机构）；org（非营利性的组织）。
        “行政区域名”共34个，适用于我国的各省、自治区、直辖市。例如：bj（北京市），js（江苏省），等等。
    值得注意的是，我国修订的域名体系允许直接在cn的顶级域名下注册二级域名。这显然给我国的因特网用户提供了很大的方便。例如某公司abc以前要注册为abc.com.cn，是个三级域名。但现在可以注册为abc.cn，变成了二级域名。据统计，到2006年6月底为止，直接在cn的顶级域名下注册二级域名已经超过66万个。
    关于我国的互联网发展现状以及各种规定（如申请域名的手续），均可在中国互联网网络信息中心CNNIC的网址上找到【W-CNNIC】。
    用域名树来表示因特网的域名系统是最清楚的。图是因特网域名空间的结构，它实际上是一个倒过来的树，在最上面的是根，但没有对应的名字。根下面一级的节点就是最高一级的顶级域名（由于跟没有名字，所以在跟下面一级的域名就叫做顶级域名）。顶级域名可往下划分子域名，即二级域名。在往下划分就是三级域名四级域名，等等。图列举了一些域名作为自己。凡是在顶级域名com下注册的单位都获得了一个二级域名。图中给出的例子有：中央电视台cctv，以及IBM、惠普（HP）等公司。在顶级域名cn（中国）下面举出了几个二级域名，如bj，edu以及com。在某个二级域名下注册的单位就可以获得一个三级域名。图中给出的在edu下面额三级域名有：tsinghua（清华大学）和pku（北京大学）。一旦某个单位拥有了一个域名，它就可以自己决定是否要进一步划分其下属的子域名，并且不必由其上级机构批准。图中画出了cctv（中央电视台）和Tsinghua（清华大学）都分别划分了自己的下一级的域名mail和www（分别是三级域名和四级域名）。域名树的树叶就是单台计算机的名字，它不能在继续往下划分子域了。
    应当注意，虽然中央电视台和清华大学都各有一台计算机取名为mail，但它们的域名并不一样，因为前者是mail.cctv.com，而后者是mail.tsinghua.edu.cn。因此，即使在世界上还有很多单位的计算机取名为mail，但是它们在因特网中的域名却都必须是唯一的。
    这里还要强调指出，因特网的名字空间是按照机构的组织来划分的，与物理的网络无关，与IP地址中的“子网”也没有关系。
    6.1.3域名服务器
    上面讲述的域名体系是抽象的。但具体实现域名系统则是使用分布在各地的域名服务器。从理论上讲，可以让每一级的域名都有一个相对应的域名服务器，使所有的域名服务器构成和图相对应的“域名服务器树”的结构。但这样做会使域名服务器的数量太多，是域名系统的运行效率降低。因此DNS就采用划分区的办法来解决这个问题。
    一个服务器所负责管辖的（或有权限的）范围叫作区（zone）。各单位根据具体情况来划分自己管辖范围的区。但在一个区中的所有节点必须是能够连通的。每一个区设置相应的权限域名服务器（authoritative name Server），用来保存该区中的所有主机的域名到IP地址的映射。总之，DNS服务器的管辖范围不是以“域”为单位，而是以“区”为单位。区是DNS服务器实际管辖的范围。区可能等于或小于域，但一定不可能大于域。
    图是区的不同划分方法的举例。假定abc公司有下属部门x和y，部门x下面又分三个分部门u，v和w，而y下面还有其下属部门t、图表示abc公司只设一个区abc.com。这是，区abc.com和域abc.com指的是同一件事。但图表示abc公司划分了两个区（大的公司可能要划分多个区）：abc.com和y.abc.com。这两个区都隶属于域abc.com，都各设置了相应的权限域名服务器。不难看出，区是“域”的子集。
    图中公司abc划分的两个区为例，给出了DNS域名服务器树状结构图。这种DNS域名服务器树状结构图可以更准确地反映出DNS的分布式结构。在图中的每一个域名服务器都能够进行部分域名到IP地址的解析。当某个DNS服务器不能进行域名到IP地址的转换时，它就设法找因特网上别的域名服务器进行解析。
    从图可看出，因特网上的DNS域名服务器也是按照层次安排的。每一个域名服务器都只对域名体系中的一部分进行管辖。根据域名服务器所起的作用，可以把域名服务器划分为以下四种不同的类型：
    （1）根域名服务器（root name server）：根域名服务器是最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址。根域名服务器是最重要的域名服务器，因为不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析（即转换为IP地址），只要自己无法解析，就首先要求助于根域名服务器。假定所有的根域名服务器都瘫痪了，那么整个的DNS系统就无法工作。在因特网上共有13个不同的IP地址的根域名服务器，他们的名字是用一个英文字母命名，从a一直到m（前12个字母）。这些根域名服务器响应的域名分别是a.rootservers.net，...，m.rootservers.net。但请注意，根域名服务器的数目并不是13个机器，而是13套装置（13 installations）【W-ROOT】。实际上，到2006年底全世界已经安装了123个根域名服务器机器，分布在世界各地（虽然负责运营根域名服务器的组织大多在美国，但这些根域名服务器大部分并不在美国）。这样做的目的是为了方便用户，使世界上大部分DNS域名服务器都能就近找到一个根域名服务器。例如，根域名服务器f现在就有40个地点安装有机器，图是这40个地点的分布情况（中国有三个，位置是背景、香港和台北）。由于根域名服务器采用了任播（anycast）技术，因此当DNS客户向某个根域名服务器进行查询时（用这个根域名服务器的IP地址），因特网上的路由器就能找到里这个DNS客户最近的一个根域名服务器。这样做不仅加快了DNS的查询过程，也更加合理地利用了因特网的资源。
    需要注意的是，在许多情况下，根域名服务器并不直接把待查询的域名直接转换成IP地址（根域名服务器也没有存放这种信息），而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。
    由于根域名服务器在DNS中的地位特殊，因此对根域名服务器有许多具体的需求，可参阅 RFC 2870。
    （2）顶级域名服务器（即TLD服务器）：这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。当收到DNS查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的IP地址）。
    （3）权限域名服务器：这就是前面已经讲过的负责一个区的域名服务器。当一个权限域名服务器还不能给出最后的查询回答时，就会告诉发出查询请求的DNS客户，下一步应当找哪一个权限域名服务器。例如在图中，区abc.com和区y.abc.com各设有一个权限域名服务区。
    （4）本地域名服务器（local name server）：本地域名服务器并不属于图所示的域名服务器层次结构，但它对域名系统非常重要。当一个主机发出DNS查询请求时，这个查询请求报文就发送给本地域名服务器。由此可看出本地域名服务器的重要性。每一个因特网服务提供者ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本地域名服务器，这种域名服务器有时也称为默认域名服务器。当PC机使用WindowsXP操作系统时，打开“控制面板”，选择“网络连接”，再用鼠标右键点击任何一种网络连接，选择“属性”、“网络”，然后选择“Internet协议（TCP/IP）”，再选择“属性”，就可看见有关DNS地址的选项（自动获取或指定地址）。这里的DNS服务器指的就是本地域名服务器。本地域名服务器离用户较近，一般不超过几个路由器的距离。当所要查询的主机也属于同一个本地ISP时，该本地域名服务器立即就能将所查询的主机名转换为它的IP地址，而不需要再去询问其他的域名服务器。
    为了提高域名服务器的可靠性，DNS域名服务器都把数据复制到几个域名服务器来保存，其中的一个是主域名服务器（master name server），其他的是辅助域名服务器（secondary name server）。当主域名服务器出故障时，辅助域名服务器可以保证DNS的查询工作不会中断。主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行。这样就保证了数据的一致性。
    下面简单讨论一下域名的解析过程。这里要注意两点。
    第一，主机向本地域名服务器查询一般都是采用递归查询（recursive query）。所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其他根域名服务器发出查询请求报文（即替该主机继续查询），而不是让该主机自己进行下一步的查询。因此，递归查询返回的查询结果或者是所要查询的IP地址，或者是报错，表示无法查询到所需的IP地址。
    第二，本地域名服务器向根域名服务器的查询通常是采用迭代查询（iterative query）。迭代查询的特点是这样的：当根域名服务器收到本地域名服务发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地域名服务器：“你下一步应当向哪一个域名服务器进行查询”。然后让本地域名服务器进行后续的查询（而不是替本地域名服务器进行后续的查询）。根域名服务器通常是把自己知道的顶级域名服务器的IP地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。顶级域名服务器在收到本都域名服务器的查询请求后，要么给出所要查询的IP地址，要么告诉本地域名服务器下一步应当向哪一个权限域名服务器进行查询。本地域名服务器就这样进行迭代查询。最后，知道了所要解析的域名的IP地址，然后把这个结果返回给发起查询的主机。当然，本地域名服务器也可以采用递归查询。这取决于最初的查询请求报文的设置是要求使用哪一种查询方式。
    图用例子说明了这两种查询的区别。
    假定域名m.xyz.com的主机想知道另一个主机（域名为y.abc.com）的IP地址。例如，主机m.xyz.com打算发送邮件给主机y.abc.com。这是就必须知道主机y.abc.com的IP地址。下面是图的几个查询步骤：
    1.主机m.xyz.com先向其本地域名服务器dns.xyz.com进行递归查询。
    2.本地域名服务器采用迭代查询。它先向一个根域名服务器查询。
    3.根域名服务器告诉本地域名服务器，下一次应查询的顶级域名服务器dns.com的IP地址。
    4.本地域名服务器向顶级域名服务器dns.com进行查询。
    5.顶级域名服务器dns.com告诉本地域名服务器，下一次应查询的权限域名服务器dns.abc.com的IP地址。
    6.本地域名服务器向权限域名服务器dns.abc.com进行查询。
    7.权限域名服务器dns.abc.com告诉本地域名服务器，所查询的主机的IP地址。
    8.本地域名服务器最后把查询结果告诉m.xyz.com。
    我们注意到，这8个步骤总共要使用8个UDP用户数据报的报文。本地域名服务器经过三次迭代查询后，从权限域名服务器dns.abc.com得到了主机y.abc.com的IP地址，最后把结果返回给发起查询的主机m.xyz.com。
    图是本地域名服务器采用递归查询的情况。在这种情况下，本地域名服务器只需向根域名服务器查询一次，后面的几次查询都是在其他几个域名服务器之间进行的（步骤3至6）。只是在步骤7，本地域名服务器从根域名服务器得到了所需的IP地址。最后在步骤8，本地域名服务器把查询结果告诉主机m.xyz.com。整个的查询也是使用8个UDP报文。
    为了提高DNS查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文数量，在域名服务器中广泛地使用了高速缓存（有时也称为高速缓存域名服务器）。高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录。
    例如，在图的查询过程中，如果在不久前已经有用户查询过域名y.abc.com的IP地址，那么本地域名服务器就不必向根域名服务器重新查询y.abc.com的IP地址，而是直接把高速缓存中存放的上次查询结果（即y.abc.com的IP地址）告诉用户。
    假定本地域名服务器的缓存中并没有y.abc.com的IP地址，而是存放着顶级域名服务器dns.com的IP地址，那么本地域名服务器也可以不向根域名服务器进行查询，而是直接向com顶级域名服务器发送请求报文。这样不仅可以大大减轻根域名服务器的负荷，而且也能够使因特网上的DNS查询请求和回答报文的数量大为减少。
    由于名字到地址的绑定并不经常改变，为了保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器并处理超过合理时间的项（例如，每个项目只存放两天）。当域名服务器已从缓存中删去某项信息后又被请求查询该项信息，就必须重新到授权管理该项的域名服务器获取绑定信息。当权限域名服务器回答一个查询请求时，在响应中都指明绑定有效存在的时间值。增加此时间值可减少网络开销，而减少此时间值可提高域名转换的准确性。
    不但在本地域名服务器中需要高速缓存，在主机中也很需要。许多主机在启动时从本地域名服务器下载名字和地址的全部数据库，维护存放自己最近使用的域名的高速缓存，并且只在从缓存中找不到名字时才使用域名服务器。维护本地域名服务器数据库的主机自然应该定期地检查域名服务器以获得新的映射信息，而且主机必须从缓存中删掉无效的项。由于域名改动并不频繁，大多数网点不需花太多精力就能维护数据库的一致性。
6.2文件传送协议
    6.2.1FTP概述
    文件传送协议FTP（File Transfer Protocol）是因特网上使用得最广泛的文件传送协议。FTP提供交互式的访问，允许客户指明文件的类型与格式（如指明是否使用ASCII码），并允许文件具有存取权限（如访问文件的用户必须经过授权，并输入有效的口令）。FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件。RFC 959很早就成为了因特网的正式标准。
    在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而由电子邮件和域名系统所产生的通信量还小于FTP所产生的通信量。只是到了1995年，WWW的通信量才首次超过了FTP。
    在下面6.2.2和6.2.3节分别介绍基于TCP的FTP和基于UDP的TFTP，它们都是文件共享协议中的一大类，即复制整个文件，其特点是：若要存取一个文件，就必须先获得一个本地的文件副本。如果要修改文件，只能对文件副本进行修改，然后再将修改后的文件副本传回原节点。
    文件共享协议中的另一大类是联机访问（on-line access）。联机访问意味着允许多个程序同时对一个文件进行存取。和数据库系统不同之处是用户不需要调用一个特殊的客户进程，而是由操作系统提供对远地共享文件进行访问的服务，就如同对本地文件的访问一样。。这就使用户可以用远地文件作为输入和输出来运行任何应用程序，而操作系统中的文件系统则提供对共享文件的透明存取。透明存取的优点是：将原来用于处理本地文件的应用程序用来处理远地文件时，不需要对该应用程序作明显的改动。属于稳健共享协议的有网络文件系统NFS（Network File System）。网络文件系统NFS最初是在UNIX操作系统环境下实现稳健和目录的共享。NFS可使本地计算机共享远地的资源，就像这些资源在本地一样。由于NFS原先是SUN公司在TCP/IP网络上创建的，因此目前NFS主要应用在TCP/IP网络上。然而现在NFS也可在OS/2，MS-Windows，NetWare等操作系统上运行。NFS还没有成为因特网的正式标准，现在的版本4（NFSv4）是2000年底发表的【RFC 3010】，目前还只是建议标准。限于篇幅，本书不讨论NFS的详细工作过程。
    6.2.2FTP的基本工作原理
    网络环境中的一项基本应用就是将文件从一台计算机中复制到另一台可能相距很远的计算机中。初看起来，在两个主机之间传送文件是很简单的事情。其实这往往非常困难。原因是众多的计算机厂商研制出的文件系统多达数百种，且差别很大。经常遇到的问题是：
    （1）计算机存储数据的格式不同。
    （2）文件的目录结构和文件命名的规定不同。
    （3）对于相同的文件存取功能，操作系统使用的命令不同。
    （4）访问控制方法不同。
    文件传送协议FTP只提供文件传送的一些基本的服务，它使用TCP可靠的运输服务。FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。
    FTP使用客户服务器方式。一个FTP服务器进程可同时为多个客户进程提供服务。FTP的服务器进程有两大部分组成：一个主进程，负责接收新的请求；另外有若干个从属进程，负责处理单个请求。
    主进程的工作步骤如下：
    （1）打开熟知端口（端口号为21），是客户进程能够连接上。
    （2）等待客户进程发出连接请求。
    （3）启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程。
    （4）回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行。
    FTP的工作情况如图所示。图中的椭圆圈表示在系统中运行的进程。图中的服务器端有两个从属进程：控制进程和数据传送进程。为简单起见，服务器端的主进程没有画上。在客户端除了控制进程和数据传送进程外，还有一个用户界面进程用来和用户接口。
    在进行文件传输时，FTP的客户和服务器之间要建立两个并行的TCP连接：“控制连接”和“数据连接”。控制链接在整个会话期间一直保持打开，FTP客户所发出的传送请求，通过控制连接发送给服务器端的控制进程，但控制链接并不用来传送文件。实际用于传输文件的是“数据连接”。服务器端的控制进程在接收到FTP客户发送来的文件传输请求后就创建“数据传送进程”和“数据连接”，用来连接客户端和服务器端的数据传送进程。数据传送进程实际完成文件的传送，在传送完毕关闭“数据传送连接”并结束运行。由于TFP使用了一个分离的控制链接，因此FTP的控制信息使带外（out of band）传送的。
    当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口（21），同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接。接着，服务器进程用自己传送数据的熟知端口（20）与客户进程所提供的端口号码数据传送连接。由于FTP使用了两个不同的端口号，所以数据连接与控制链接不会发生混乱。
    使用两个独立的连接的主要好处是使协议更加简单和更容易实现，同时在传输文件时还可以利用控制链接（例如，客户发送请求终止传输）。
    FTP并非对所有的数据传输都是最佳的。例如，计算机A上运行的应用程序要在远地计算机B的一个很大的文件末尾添加一行信息。若使用FTP，则应先将此文件从计算机B传送到计算机A，添加上这一行信息后，再用FTP将此文件传送到计算机B，来回传送这样打的文件很花时间。实际上这种传送是不必要的，因为计算机A并没有使用该文件的内容。
    然而网络文件系统NFS则采用另一种思路。NFS允许应用进程打来一个远地文件，并能在该文件的某一个特定的位置上开始读写数据。这样，NFS可使用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件。对于上述例子，计算机A中的NFS客户软件，将要添加的数据和文件后面写数据的请求一起发送到远地的计算机B中的NFS服务器，NFS服务器更新文件后返回应答信息。在网络上传送的只是少量的修改数据。
    6.2.3简单文件传送协议TFTP
    TCP/IP协议族中还有一个简单文件传送协议TFTP（Trivial File Transfer Protocol），它是一个很小且易于实现的文件传送协议。TFTP的版本2是因特网的正式标准。虽然TFTP也使用客户服务器方式，但它使用UDP数据报，因此TFTP需要有自己的差错改正措施。TFTP只支持文件传输而不支持交互。TFTP没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别。
    TFTP的主要优点两个。第一，TFTP可用于UDP环境。例如，当需要将程序或文件同时向许多机器下载时就往往需要使用TFTP。第二，TFTP代码占的内存较小。这对较小的计算机或某些特殊用途的设备是很重要的。这些设备不需要硬盘，只需要固化了TFTP、UDP和IP的小容量只读存储器即可。当接通电源后，设备执行只读存储器中的代码，在网络上广播一个TFTP请求。网络上的TFTP服务器就发送响应，其中包括可执行二进制程序。设备收到此文件后将其放入内存，然后开始运行程序。这种方式增加了灵活性，也减少了开销。
    TFTP的主要特点是：
    （1）每次传送的数据报文中有512字节的数据，但最后一次可不足512字节。
    （2）数据报文按序编号，从1开始。
    （3）支持ASCII码或二进制传送。
    （4）可对文件进行读或写。
    （5）使用很简单的首部。
    TFTP的工作很像停止等待协议。发送完一个文件块后就等待对方的确认，

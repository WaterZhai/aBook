第6章   应用层

在前五章我们已经详细地讨论了计算机网络提供通信服务的过程。但是我们还没有讨论这些通信服务是如何提供给应用进程来使用过的。本章就是讨论各种应用进程通过什么样的应用层协议来使用网络所提供的这些通信服务。
这里需要再强调一下，每个应用层协议都是为了解决某一类应用问题，而应用问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的。应用层的具体内容就是规定应用进程在通信时所遵循的协议。
应用层的许多协议都是基于客户服务器方式。即使是对等通信方式，实质上也是一种特殊的客户服务器方式。这里再明确一下，客户（client）和服务器（Server）都是指通信中所设计的两个应用进程。客户服务器方式所描述的是进程之间服务和被服务的关系。这里最主要的特征就是：客户是服务请求方，服务器是服务提供方。
下面先讨论许多应用协议都要使用的域名系统。在介绍了文件传送协议和远程登录协议后，就重点介绍万维网的工作原理及其主要协议。由于万维网的出现使因特网得到了飞速的发展，因此万维网在本章中占有最大的篇幅，也本章的重点。接着讨论用户最常用的因特网电子邮件，最后，介绍有关网络管理方面的问题以及有关网络编程的概念。对应用层更深入的学习可参阅【come04】【come06】【tane03】及有关标准。

6.1域名系统DNS
    6.1.1域名系统概述
    域名系统DNS（Domain Name System）是因特网使用的命名系统，用来把便于人们使用的机器名字转换为IP地址。域名系统其实就是名字系统。为什么不叫“名字”而叫“域名”呢？这是因为在这种因特网的命名系统中使用了许多的“域”（domain），因此就出现了“域名”这个名词。“名字系统”没有说清用在什么地方，而“域名系统”就很明确地指明这种系统是用在因特网中。在下一节我们就会讲到，在域名结构中会出现很重要的“点(.)”。
    许多应用层软件经常直接使用域名系统DNS，但计算机的用户只是简介而不是直接使用域名系统。
    用户与因特网上某个主机通信时，显然不愿意使用很难记忆的长达32位二进制主机地址。即使是点分十进制IP地址也并不太容易记忆。相反，大家愿意使用比较容易记忆的主机名字。早在ARPANET时代，整个网络只有数百台计算机，那时适用一个叫做hosts的文件，列出所有主机名字和相应的IP地址。只要用户输入一个主机名字，计算机就可很快地把这个主机名字转换成机器能够识别的二进制IP地址。
    为什么机器在处理IP数据报时要使用IP地址而不使用域名呢？这是因为IP地址的长度是固定的32位（如果是IPv6地址，那就是128位，也是定长的），而域名的长度并不是固定的，机器处理起来比较困难。
    从理论上讲，整个因特网可以只使用一个域名服务器，使它装入因特网上所有主机名，并回答所有对IP地址的查询。然而这种做法并不可取。因为因特网规模很大，这样的域名服务器肯定会因过负荷而无法正常工作，而且一旦域名服务器出现故障，整个因特网就会瘫痪。因此，早在1983年因特网就开始采用层次树状结构的命名方法，并使用分布式的域名系统DNS。DNS的因特网标准是RFC 1034，1035。
    因特网的域名系统DNS被设计成为一个联机分布式数据库系统，并采用客户服务器方式。DNS使大多数名字都在本地进行解析（resolve），仅少量解析需要在因特网上通信，因此DNS系统的效率的效率很高。由于DNS是分布式系统，即使单个计算机出了故障，也不会妨碍整个DNS系统的正常运行。
    域名到IP地址的解析是由分布在因特网上的许多域名服务器程序（可简称为域名服务器）共同完成的。域名服务器程序在专设的结点上运行，而人们也常把运行域名服务器程序的机器称为域名服务器。
    域名到IP地址的解析过程的要点如下：当某一个应用进程需要把主机名解析为IP地址时，该应用进程就调用解析程序（resolver），并成为DNS的一个客户，把待解析的域名放在DNS请求报文中，以UDP用户数据报方式发给本地域名服务器（使用UDP是为了减少开销）。本地域名服务器在查找域名后，把对应的IP地址放在回答报文中返回。应用进程获得目的主机的IP地址后即可进行通信。
    若本地域名服务器不能回答该请求，则此域名服务器就暂时称为DNS中的另一个客户，并向其他域名服务器发出查询请求。这种过程直至找到能够回答该请求的域名服务器为止。上述的这种查找过程，后面还要进一步讨论。
    6.1.2因特网的域名结构
    早期的因特网使用了非等级的名字空间，其优点是名字简短。但当因特网上的用户数急剧增加时，用非等级的名字空间来管理一个很大的而且是经常变换的名字集合是非常困难的。因此，因特网后来就采用了层次树状结构的命名方法，就像全球邮政系统和电话系统那样。采用这种命名方法，任何一个连续在因特网上的注意或路由器，都以一个唯一的层次结构的名字，即域名（domain name）。这里，“域”（domain）是名字空间中一个可被管理的划分。域还可以划分为子域，而子域还可继续划分为子域的子域，这样就形成了顶级域、二级域、三级域，等等。
    从语法上讲，每一个域名都是由标号（label）序列组成，而各标号之间用点隔开（请注意，是小数点“.”，不是中文的句号“。”）。例如下面的域名:mail.cctv.com(三级域名.二级域名.顶级域名)
    就是中央电视台用于收到电子邮件的计算机（即邮件服务器）的域名，它由三个标号组成，其中标号com是顶级域名，标号cctv是二级域名，标号mail是三级域名。
    DNS规定，域名中的标号都由英文字母或数字组成，每一个标号不超过63个字符（但为了记忆方便，最好不要超过12个字符），而不区分大小写字母（例如，CCYV或cctv在域名中是等效的）。标号中除连字符（-）外不能使用其他标点符号。级别最低的域名写在最左边，而级别最高的顶级域名则写在最右边。由多个标号组成的完整域名总共不超过255个字符。DNS既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思。各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由ICANN进行管理。用这种方法可使每一个域名在整个因特网范围内是唯一的，并且也容易设计出一种查找域名的机制。
    需要注意的是，域名只是个逻辑概念，并不代表计算机所在的物理地点。变成的域名和使用有助记忆的字符串，是为了便于人来使用。而IP地址是定长的32位二进制数字则非常便于机器进行处理。这里需要注意，域名中的“点”和点分十进制中的“点”并无一一对应的关系。点分十进制IP地址中一定是包含三个“点”，但每一个域名中“点”的数目则不一定正好是三个。
    据2006年12月的统计，现在顶级域名TLD（Top Level Domain）已有265个【W-TLD】，分为三大类：
    （1）国家顶级域名nTLD：采用ISO 3166的规定。如：cn表示中国，us表示美国，uk表示英国，等等。国家顶级域名又常记为ccTLD（cc表示国家代码country-code）。到2006年12月为止，国家顶级域名总共有247个。
    （2）通用顶级域名gTLD：到2006年12月为止，通用顶级域名的总数已经达到18个【W-gTLD】。最常见的通用顶级域名有7个，即：
        com（公司企业），net（网络服务机构），org（非营利性的组织），int（国际组织），edu（美国专用的教育机构），gov（美国的政府部门），mil表示（美国的军事部门）。
        其余11个通用顶级域名是：
        aero（航空运输企业），biz（公司和企业），cat（加泰隆人的语言和文化团体），coop（合作团体），info（各种情况），jobs（人力资源管理者），mobi（移动产品与服务的用户和提供者），museum（博物馆），name（个人），pro（有证书的专业人员），travel（旅游业）。
    （3）基础结构域名（infrastructure domain）：这种顶级域名只有一个，即arpa，用于反向域名解析，因此又称为反向域名。
        在国家顶级域名下注册的二级域名均由该国家自行确定。例如，顶级域名为jp的日本，将其教育和企业机构的二级域名定为ac和co，而不用edu和com。
        我国把二级域名划分为“类别域名”和“行政区域名”两大类。
        “类别域名”共7个，分别为ac（科研机构）；com（工、商、金融等企业）；edu（中国的教育机构）；gov（中国的政府机构）；mil（中国的国防机构）；net（提供互联网络服务的机构）；org（非营利性的组织）。
        “行政区域名”共34个，适用于我国的各省、自治区、直辖市。例如：bj（北京市），js（江苏省），等等。
    值得注意的是，我国修订的域名体系允许直接在cn的顶级域名下注册二级域名。这显然给我国的因特网用户提供了很大的方便。例如某公司abc以前要注册为abc.com.cn，是个三级域名。但现在可以注册为abc.cn，变成了二级域名。据统计，到2006年6月底为止，直接在cn的顶级域名下注册二级域名已经超过66万个。
    关于我国的互联网发展现状以及各种规定（如申请域名的手续），均可在中国互联网网络信息中心CNNIC的网址上找到【W-CNNIC】。
    用域名树来表示因特网的域名系统是最清楚的。图是因特网域名空间的结构，它实际上是一个倒过来的树，在最上面的是根，但没有对应的名字。根下面一级的节点就是最高一级的顶级域名（由于跟没有名字，所以在跟下面一级的域名就叫做顶级域名）。顶级域名可往下划分子域名，即二级域名。在往下划分就是三级域名四级域名，等等。图列举了一些域名作为自己。凡是在顶级域名com下注册的单位都获得了一个二级域名。图中给出的例子有：中央电视台cctv，以及IBM、惠普（HP）等公司。在顶级域名cn（中国）下面举出了几个二级域名，如bj，edu以及com。在某个二级域名下注册的单位就可以获得一个三级域名。图中给出的在edu下面额三级域名有：tsinghua（清华大学）和pku（北京大学）。一旦某个单位拥有了一个域名，它就可以自己决定是否要进一步划分其下属的子域名，并且不必由其上级机构批准。图中画出了cctv（中央电视台）和Tsinghua（清华大学）都分别划分了自己的下一级的域名mail和www（分别是三级域名和四级域名）。域名树的树叶就是单台计算机的名字，它不能在继续往下划分子域了。
    应当注意，虽然中央电视台和清华大学都各有一台计算机取名为mail，但它们的域名并不一样，因为前者是mail.cctv.com，而后者是mail.tsinghua.edu.cn。因此，即使在世界上还有很多单位的计算机取名为mail，但是它们在因特网中的域名却都必须是唯一的。
    这里还要强调指出，因特网的名字空间是按照机构的组织来划分的，与物理的网络无关，与IP地址中的“子网”也没有关系。
    6.1.3域名服务器
    上面讲述的域名体系是抽象的。但具体实现域名系统则是使用分布在各地的域名服务器。从理论上讲，可以让每一级的域名都有一个相对应的域名服务器，使所有的域名服务器构成和图相对应的“域名服务器树”的结构。但这样做会使域名服务器的数量太多，是域名系统的运行效率降低。因此DNS就采用划分区的办法来解决这个问题。
    一个服务器所负责管辖的（或有权限的）范围叫作区（zone）。各单位根据具体情况来划分自己管辖范围的区。但在一个区中的所有节点必须是能够连通的。每一个区设置相应的权限域名服务器（authoritative name Server），用来保存该区中的所有主机的域名到IP地址的映射。总之，DNS服务器的管辖范围不是以“域”为单位，而是以“区”为单位。区是DNS服务器实际管辖的范围。区可能等于或小于域，但一定不可能大于域。
    图是区的不同划分方法的举例。假定abc公司有下属部门x和y，部门x下面又分三个分部门u，v和w，而y下面还有其下属部门t、图表示abc公司只设一个区abc.com。这是，区abc.com和域abc.com指的是同一件事。但图表示abc公司划分了两个区（大的公司可能要划分多个区）：abc.com和y.abc.com。这两个区都隶属于域abc.com，都各设置了相应的权限域名服务器。不难看出，区是“域”的子集。
    图中公司abc划分的两个区为例，给出了DNS域名服务器树状结构图。这种DNS域名服务器树状结构图可以更准确地反映出DNS的分布式结构。在图中的每一个域名服务器都能够进行部分域名到IP地址的解析。当某个DNS服务器不能进行域名到IP地址的转换时，它就设法找因特网上别的域名服务器进行解析。
    从图可看出，因特网上的DNS域名服务器也是按照层次安排的。每一个域名服务器都只对域名体系中的一部分进行管辖。根据域名服务器所起的作用，可以把域名服务器划分为以下四种不同的类型：
    （1）根域名服务器（root name server）：根域名服务器是最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址。根域名服务器是最重要的域名服务器，因为不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析（即转换为IP地址），只要自己无法解析，就首先要求助于根域名服务器。假定所有的根域名服务器都瘫痪了，那么整个的DNS系统就无法工作。在因特网上共有13个不同的IP地址的根域名服务器，他们的名字是用一个英文字母命名，从a一直到m（前12个字母）。这些根域名服务器响应的域名分别是a.rootservers.net，...，m.rootservers.net。但请注意，根域名服务器的数目并不是13个机器，而是13套装置（13 installations）【W-ROOT】。实际上，到2006年底全世界已经安装了123个根域名服务器机器，分布在世界各地（虽然负责运营根域名服务器的组织大多在美国，但这些根域名服务器大部分并不在美国）。这样做的目的是为了方便用户，使世界上大部分DNS域名服务器都能就近找到一个根域名服务器。例如，根域名服务器f现在就有40个地点安装有机器，图是这40个地点的分布情况（中国有三个，位置是背景、香港和台北）。由于根域名服务器采用了任播（anycast）技术，因此当DNS客户向某个根域名服务器进行查询时（用这个根域名服务器的IP地址），因特网上的路由器就能找到里这个DNS客户最近的一个根域名服务器。这样做不仅加快了DNS的查询过程，也更加合理地利用了因特网的资源。
    需要注意的是，在许多情况下，根域名服务器并不直接把待查询的域名直接转换成IP地址（根域名服务器也没有存放这种信息），而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。
    由于根域名服务器在DNS中的地位特殊，因此对根域名服务器有许多具体的需求，可参阅 RFC 2870。
    （2）顶级域名服务器（即TLD服务器）：这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。当收到DNS查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的IP地址）。
    （3）权限域名服务器：这就是前面已经讲过的负责一个区的域名服务器。当一个权限域名服务器还不能给出最后的查询回答时，就会告诉发出查询请求的DNS客户，下一步应当找哪一个权限域名服务器。例如在图中，区abc.com和区y.abc.com各设有一个权限域名服务区。
    （4）本地域名服务器（local name server）：本地域名服务器并不属于图所示的域名服务器层次结构，但它对域名系统非常重要。当一个主机发出DNS查询请求时，这个查询请求报文就发送给本地域名服务器。由此可看出本地域名服务器的重要性。每一个因特网服务提供者ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本地域名服务器，这种域名服务器有时也称为默认域名服务器。当PC机使用WindowsXP操作系统时，打开“控制面板”，选择“网络连接”，再用鼠标右键点击任何一种网络连接，选择“属性”、“网络”，然后选择“Internet协议（TCP/IP）”，再选择“属性”，就可看见有关DNS地址的选项（自动获取或指定地址）。这里的DNS服务器指的就是本地域名服务器。本地域名服务器离用户较近，一般不超过几个路由器的距离。当所要查询的主机也属于同一个本地ISP时，该本地域名服务器立即就能将所查询的主机名转换为它的IP地址，而不需要再去询问其他的域名服务器。
    为了提高域名服务器的可靠性，DNS域名服务器都把数据复制到几个域名服务器来保存，其中的一个是主域名服务器（master name server），其他的是辅助域名服务器（secondary name server）。当主域名服务器出故障时，辅助域名服务器可以保证DNS的查询工作不会中断。主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行。这样就保证了数据的一致性。
    下面简单讨论一下域名的解析过程。这里要注意两点。
    第一，主机向本地域名服务器查询一般都是采用递归查询（recursive query）。所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其他根域名服务器发出查询请求报文（即替该主机继续查询），而不是让该主机自己进行下一步的查询。因此，递归查询返回的查询结果或者是所要查询的IP地址，或者是报错，表示无法查询到所需的IP地址。

第7章  进程监控与性能维护

管理员的一项重要工作就是监控网络系统，并确保一切运行正常或处于允许的范围内。第6章曾经讲过，密切关注事件日志有助于检测与追踪应用程序、系统安全以及基础服务方面存在的问题。通常，检测到或怀疑某处存在问题时，应该对其进行深入挖掘，以便找到导致问题的根源并加以纠正。但愿查明问题的根源，可以防止该问题再次发生。

7.1管理应用程序、进程与性能
    操作系统或用户启动服务、运行应用程序或执行命令时，Windows会启动一个或多个进程来处理相关的程序。有几款命令行工具可用于监控与管理程序，包括下面3个。
    · Task List（Tasklist）。列出所有运行中进程的名称与进程ID，包括用户会话与内存使用等信息。
    · Task Kill（Taskkill）。根据名称或进程ID终止运行中的进程。通过使用过滤器，也可以根据进程状态、会话号、CPU时间、内存使用情况、用户名以及其他信息来终止进程。
    · Powershell get-process。显示性能数据的统计资料，包括CPU与内存使用情况、所有运行中进程列表等。用于获取资源使用情况与所有运行中进程的详细资料快照，只有在安装了Windows PowerShell之后才是可用的。
    在接下来的内容中，将会详细讲解如何使用这些命令行工具。不过在具体讲解之前，先介绍一下进程的通常运行方式以及操作中常见的问题。
    7.1.1理解系统与用户进程
        通常，有操作系统启动的进程称为系统进程，由用户启动的进程称为用户进程。大多数用户进程是以交互模式运行的，也就是说，用户启动进程时要与键盘或鼠标进行交互。如果应用软件或程序处于活跃状态并被选定，则相应的交互式进程就控制了键盘与鼠标，直至切换控制权（通过终止相应程序或选定其他程序）。当某进程具有控制权时，就称其为在“前台”运行。
        进程可以独立于用户登录会话在后台运行，后台运行的进程不具备对键盘、鼠标或其他输入设备的控制权，通常由操作系统运行。通过使用任务计划程序，用户也可以将进程设定为在后台运行，并且这些进程的运行不受用户是否登录的影响。比如，如果任务计划程序在某用户登录时启动一个计划任务，该用户退出登录时，该进程会继续运行。
        Windows对系统中运行进程的追踪是通过镜像名、进程ID、优先级以及其他一些记录资源使用情况的参数来实现的。镜像名是启动该进程的可执行程序的名称，比如Msdtc.exe或Svchost.exe。进程ID是该进程的数字标识符，比如2588.进程ID还是一个优先级指示器，代表了该进程与其他运行中进程相比而言获取系统资源的优先程度。在进行优先级处理时，具有高优先级的进程可以比低优先级的进程更快地获取处理器时间、访问内存或操作文件系统。而低优先级的进程必须等待高优先级进程完成当前的处理任务之后，才可以访问CPU、内存或文件系统。
        理想情况下，进程应该正确地按计划运行，而不出现任何问题。然而，实际的情况则是在你最不希望出问题的时候通常会出现问题。就进程而言，常见的问题包括下面3个。
        · 进程失去响应。比如，应用程序停止处理外部的请求。发生这种情况时，用户会报告无法访问特定的应用程序，提交的请求无法得到处理，或者被踢出该应用程序。
        · 进程不释放CPU资源。比如，某个失控进程几乎耗尽CPU资源。发生这种情况时，系统会变慢或失去响应，这是因为失控进程霸占了处理器时间，导致其他进程无法完成自己的任务。
        · 进程占用的内存空间超过了正常的需求。比如，应用程序发生了内存泄露。发生这种情况时，进程无法正常释放其所使用的内存资源，由此导致的结果是系统中可用内存逐渐下降，使得系统对外部响应变慢，或者失去响应。内存泄露还有可能导致系统中其他程序无法正常运行。
        大多数情况下，发现系统进程存在上述问题或其他问题后，你可能需要终止该进程之后重启，并根据需要检查时间日志以便发现导致问题的根源。对内存泄露的情况，你可能需要向开发人员报告，必变发现是否有可用的更新程序。
        此外，对存在内存泄露问题的应用程序，定期进程重启也是有用的。重启之后，操作系统会进行泄露内存的恢复。
    7.1.2检查运行中进程
        如果需要检查本地或远程系统上运行的进程，可以使用Tasklist这一命令行工具。通过该工具，可以完成如下一些任务。
        · 获取系统中运行进程的进程ID、状态以及其他一些重要信息。
        · 查看运行中进程与系统中已配置服务的关系。
        · 查看运行中进程使用的DLL。
        · 使用过滤器包含或排除Tasklist查询获得的进程列表。
        下面几节逐一讨论了这些任务。
        1.获取进程的详细信息
        在本地系统上，通过在命令提示符中键入tasklist命令，就可以查看运行中任务列表。与很多其他的命令行工具类似。默认情况下，Tasklist以当前登录用户的许可权限运行。你也可以指定远程主机（要查询其上的任务）以及Run As许可权限，这是通过使用包含如下一些参数的扩展的语法格式实现的：
            /s Comouter /u [Domain\]User[/p Password]
        其中，Computer为远程计算机名或IP地址，Domain为可选的域名，用户账号就存在于该域内，User为用户账号名（要使用的就是用户账号的许可权限），Password为该用户账号的口令（可选）。如果没有指定域，则系统会假定当前域作为默认的域名。如果没有指定口令，则会弹出提示信息要求输入口令。
        要了解如何添加计算机与用户信息，参考如下一些实例。
        查询Mailer1上运行的任务
            tasklist /s mailer1
        查询192.168.1.5上使用账号adatum/wrstanek运行的任务
            tasklist /s 192.168.1.5 /u adatum\wrstanek
        上述命令的基本输出信息是以表格形式呈现的，通过分别使用/Fo List或/Fo Csv参数，也可以使得输出信息分别呈现为列表形式与逗号分隔的多行形式。你也可以使用重定向操作符（>或>>）将输出信息重定向到文件中，比如，tasklist /s mailer1 >> current-tasks.log
        无论是本地系统还是远程系统，输出信息都应该类似于如下的格式：
            ----------------------------------------------------------------------
            Image Name                   PID    Session Name   Session#  MemUsage
            =======================     ===== ============== =========  ==========
            

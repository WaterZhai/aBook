第7章  进程监控与性能维护

管理员的一项重要工作就是监控网络系统，并确保一切运行正常或处于允许的范围内。第6章曾经讲过，密切关注事件日志有助于检测与追踪应用程序、系统安全以及基础服务方面存在的问题。通常，检测到或怀疑某处存在问题时，应该对其进行深入挖掘，以便找到导致问题的根源并加以纠正。但愿查明问题的根源，可以防止该问题再次发生。

7.1管理应用程序、进程与性能
    操作系统或用户启动服务、运行应用程序或执行命令时，Windows会启动一个或多个进程来处理相关的程序。有几款命令行工具可用于监控与管理程序，包括下面3个。
    · Task List（Tasklist）。列出所有运行中进程的名称与进程ID，包括用户会话与内存使用等信息。
    · Task Kill（Taskkill）。根据名称或进程ID终止运行中的进程。通过使用过滤器，也可以根据进程状态、会话号、CPU时间、内存使用情况、用户名以及其他信息来终止进程。
    · Powershell get-process。显示性能数据的统计资料，包括CPU与内存使用情况、所有运行中进程列表等。用于获取资源使用情况与所有运行中进程的详细资料快照，只有在安装了Windows PowerShell之后才是可用的。
    在接下来的内容中，将会详细讲解如何使用这些命令行工具。不过在具体讲解之前，先介绍一下进程的通常运行方式以及操作中常见的问题。
    7.1.1理解系统与用户进程
        通常，有操作系统启动的进程称为系统进程，由用户启动的进程称为用户进程。大多数用户进程是以交互模式运行的，也就是说，用户启动进程时要与键盘或鼠标进行交互。如果应用软件或程序处于活跃状态并被选定，则相应的交互式进程就控制了键盘与鼠标，直至切换控制权（通过终止相应程序或选定其他程序）。当某进程具有控制权时，就称其为在“前台”运行。
        进程可以独立于用户登录会话在后台运行，后台运行的进程不具备对键盘、鼠标或其他输入设备的控制权，通常由操作系统运行。通过使用任务计划程序，用户也可以将进程设定为在后台运行，并且这些进程的运行不受用户是否登录的影响。比如，如果任务计划程序在某用户登录时启动一个计划任务，该用户退出登录时，该进程会继续运行。
        Windows对系统中运行进程的追踪是通过镜像名、进程ID、优先级以及其他一些记录资源使用情况的参数来实现的。镜像名是启动该进程的可执行程序的名称，比如Msdtc.exe或Svchost.exe。进程ID是该进程的数字标识符，比如2588.进程ID还是一个优先级指示器，代表了该进程与其他运行中进程相比而言获取系统资源的优先程度。在进行优先级处理时，具有高优先级的进程可以比低优先级的进程更快地获取处理器时间、访问内存或操作文件系统。而低优先级的进程必须等待高优先级进程完成当前的处理任务之后，才可以访问CPU、内存或文件系统。
        理想情况下，进程应该正确地按计划运行，而不出现任何问题。然而，实际的情况则是在你最不希望出问题的时候通常会出现问题。就进程而言，常见的问题包括下面3个。
        · 进程失去响应。比如，应用程序停止处理外部的请求。发生这种情况时，用户会报告无法访问特定的应用程序，提交的请求无法得到处理，或者被踢出该应用程序。
        · 进程不释放CPU资源。比如，某个失控进程几乎耗尽CPU资源。发生这种情况时，系统会变慢或失去响应，这是因为失控进程霸占了处理器时间，导致其他进程无法完成自己的任务。
        · 进程占用的内存空间超过了正常的需求。比如，应用程序发生了内存泄露。发生这种情况时，进程无法正常释放其所使用的内存资源，由此导致的结果是系统中可用内存逐渐下降，使得系统对外部响应变慢，或者失去响应。内存泄露还有可能导致系统中其他程序无法正常运行。
        大多数情况下，发现系统进程存在上述问题或其他问题后，你可能需要终止该进程之后重启，并根据需要检查时间日志以便发现导致问题的根源。对内存泄露的情况，你可能需要向开发人员报告，必变发现是否有可用的更新程序。
        此外，对存在内存泄露问题的应用程序，定期进程重启也是有用的。重启之后，操作系统会进行泄露内存的恢复。
    7.1.2检查运行中进程
        如果需要检查本地或远程系统上运行的进程，可以使用Tasklist这一命令行工具。通过该工具，可以完成如下一些任务。
        · 获取系统中运行进程的进程ID、状态以及其他一些重要信息。
        · 查看运行中进程与系统中已配置服务的关系。
        · 查看运行中进程使用的DLL。
        · 使用过滤器包含或排除Tasklist查询获得的进程列表。
        下面几节逐一讨论了这些任务。
        1.获取进程的详细信息
        在本地系统上，通过在命令提示符中键入tasklist命令，就可以查看运行中任务列表。与很多其他的命令行工具类似。默认情况下，Tasklist以当前登录用户的许可权限运行。你也可以指定远程主机（要查询其上的任务）以及Run As许可权限，这是通过使用包含如下一些参数的扩展的语法格式实现的：
            /s Comouter /u [Domain\]User[/p Password]
        其中，Computer为远程计算机名或IP地址，Domain为可选的域名，用户账号就存在于该域内，User为用户账号名（要使用的就是用户账号的许可权限），Password为该用户账号的口令（可选）。如果没有指定域，则系统会假定当前域作为默认的域名。如果没有指定口令，则会弹出提示信息要求输入口令。
        要了解如何添加计算机与用户信息，参考如下一些实例。
        查询Mailer1上运行的任务
            tasklist /s mailer1
        查询192.168.1.5上使用账号adatum/wrstanek运行的任务
            tasklist /s 192.168.1.5 /u adatum\wrstanek
        上述命令的基本输出信息是以表格形式呈现的，通过分别使用/Fo List或/Fo Csv参数，也可以使得输出信息分别呈现为列表形式与逗号分隔的多行形式。你也可以使用重定向操作符（>或>>）将输出信息重定向到文件中，比如，tasklist /s mailer1 >> current-tasks.log
        无论是本地系统还是远程系统，输出信息都应该类似于如下的格式：
            ----------------------------------------------------------------------
            Image Name                   PID    Session Name   Session#  MemUsage
            =======================     ===== ============== =========  ==========
            System Idle Process             0 Services               0          28K
            System                          4 Services               0       28952K
            smss.exe                      488 Services               0         776K
            csrss.exe                     560 Services               0        5272K
            wininit.exe                   608 Services               0        4056K
            csrss.exe                     620 Console                1       13004K
            services.exe                  652 Services               0        7456K
            lsass.exe                     664 Services               0        1852K
            Ism.exe                       680 Services               0        6400K
            svchost.exe                   835 Services               0        7228K
            winlogon.exe                  868 Console                1        5544K
            svchost.exe                   932 Services               0        9440K
            svchost.exe                   984 Services               0       23304K
            svchost.exe                  1048 Services               0       12208K
            svchost.exe                  1100 Services               0       71696K
            svchost.exe                  1132 Services               0       36920K
            dwm.exe                      2832 Console                1       65456K
            explorer.exe                 2892 Console                1       26624K
        输出信息中包含如下一些字段。
        · 镜像名。进程或运行该进程的可执行程序的镜像名。
        · PID。进程的ID号。
        · 会话名。运行该进程的会话名，如果取值为console则表明该进程是本地启动的。
        · 会话#。运行该进程的会话标识符。
        · 内存使用。在Tasklist运行时刻该进程的内存总量。
        如果需要获取更多的详细信息，可以指定详细模式。这是通过包含/V参数实现的，使用该参数后，输出信息中会增加如下一些项目。
        · Status。进程的当前状态，可以为运行、无响应或未知。状态为未知的进程仍然可以正常运行与响应，但处于无响应状态的进程通常必须终止或重启。
        · 用户名。运行该进程的用户账号，并以域\用户格式列出。对由Windows启动的进程，用户账号通常为系统账号，比如系统、本地服务或网络服务等，域名则为NT AUTHORITY。
        · CPU时间。该进程自启动到目前为止所使用的CPU时钟周期总量。
        · 窗口标题。如果可用，则Windows显示进程名，否则为暂缺。比如，进程HelpPana.exe的进程名显示为“Windows帮助和支持中心”。
        使用Tasklist对运行中进程进行检查时，可能会发现两个独特的System与System Idle进程。System进程展示了本地系统进程的资源使用情况，System Idle进程则用于表述当前未使用的CPU资源。因而，如果System Idle进程的CPU一列取值为99，则说明当前有99%的系统资源处于闲置状态。如果觉得系统处于过载状态，则应该监控System Idle进程，查看CPU使用情况与总CPU时间。如果系统持续性地处于低空闲时间（即高CPU占用率），则可以考虑对处理器进行升级，甚至添加处理器。
        检查进程时，要记住的一点是：单一的应用程序可能会启动多个进程。通常，这些进程依赖于一个主进程，并以该进程为根形成一颗进程数。终止进程时，通常需要定位并终止该应用程序的主进程，而不是那些依赖性的附加进程，这将确保应用程序的彻底终止。
        2.查看运行中的进程与服务的关系
        运行Tasklist命令时，通过使用/svc参数，可以检查运行中进程与系统中配置的服务之间的关系。输出信息中，包括进程镜像名、进程ID，以及使用该进程的所有服务的列表，类似于如下的格式：
            Image Name                         PID    Services
            ===========================      ========  ==================================================
            System Idle Process                     0  N/A
            System                                  4  N/A
            smss.exe                              488  N/A
            csrss.exe                             560  N/A
            wininit.exe                           608  N/A
            csrss.exe                             620  N/A
            services.exe                          652  N/A
            Isass.exe                             664  KeyIso, ProtectedStorage, SamSs
            Ism.exe                               680  N/A
            svchost.exe                           836  DcomLaunch, PlugPlay
            winlogon.exe                          868  N/A
            svchost.exe                           932  RpcSs
            svchost.exe                           984  WinDefend
            svchost.exe                          1048  Audiosrv, Dhcp, Eventlog, Imhosts, wscsvc
            svchost.exe                          1100  AudioEndpointBuilder,CscService, EMDMgmt,
                                                        Netman, PcaSvc, SysMain,
                                                        TabletInputService, TrkWks, UmRdpService,
                                                        UxSms, WdiSystemHost, Wlansvc, WPDBusEnum,
                                                        wudfsvc
            svchost.exe                          1132  AeLookupSvc, BITS, Brower, CertPropSvc,
                                                        EapHost, gpsvc, IKEEXT, iphlpsvc,
                                                        LanmanServer, MMCSS, ProfSvc, RasMan,
                                                        Schedule, seclogon, SENS, SessionEnv,
                                                        ShellHWDetection, Themes, Winmgmt, wuauserv
            svchost.exe                          1384  EventSystem, fdPHost,FdResPub,
                                                        LanmanWorkstation, netprofm, nsi, SSDPSRV,
                                                        upnphost, W32Time, WebClient
            svchost.exe                          1520  CryptSvc, Dnscache, KtmRm, NlaSvc, TapiSrv,
                                                        TermService
            spoolsv.exe                          1776  Spooler
            svchost.exe                          1800  BFE, DPS, MpsSvc
            dwm.exe                              2832  N/A
            explorer.exe                         2892  N/A
            ----------------------------------------------------------------------------------------------------
        默认情况下，上述命令的基本输出信息是以表格形式呈现的，并且不能使用list或CSV格式。除了格式之外，要注意的重要一点是服务是以缩略名形式列出的，这是Sc（一款用于对服务进行管理的命令行工具）的命名风格。
        你可以使用进程与服务之间的关联关系来对系统进行管理。比如，如果感觉W3svc服务存在问题，对该服务进行故障排除时，一个有用的步骤就是监控该服务对应的进程。监控的主要要素包括：
        · 进程状态
        · 内存使用
        · CPU时间。
        通过对这些信息金层统计追踪，就有可能发现一些线索表明该进程已经通知响应，或者是一个霸占CPU资源的失控进程，或者存在内存泄露问题。
        3.查看进程使用过的DLL
        运行Tasklist命令时，通过使用/M参数，可以检查运行中进程与系统中配置的DLL之间的关系。输出信息中，包括进程镜像名、进程ID以及使用该进程的所有DLL的列表，如下面的实例所示：
            Image Name                          PID  Modules
            ===========================       =====  =========================================
            System Idle Process                   0  N/A
            System                                4  N/A
            smss.exe                            488  N/A
            csrss.exe                           560  N/A
            wininit.exe                         608  N/A
            csrss.exe                           620  N/A
            services.exe                        652  N/A
            lsass.exe                           664  N/A
            lsm.exe                             680  N/A
            svchost.exe                         836  N/A
            winlogon.exe                        868  N/A
            svchost.exe                         932  N/A
            svchost.exe                         984  N/A
            svchost.exe                        1048  N/A
            svchost.exe                        1100  N/A
            svchost.exe                        1132  N/A
            dwm.exe                            2832  ntdll.dll, kernel32.dll, ADVAPI32.dll,
                                                      RPCRT4.dll, GDI32.dll, USER32.dll,
                                                      msvcrt.dll, ole32.dll, OLEAUT32.dll,
                                                      UxTheme.dll, IMM32.dll, MSCTF.dll,
                                                      dwmredir.dll, SLWGA.dll, urlmon.dll,
                                                      SHLWAPI.dll, iertutil.dll, WTSAPI32.dll,
                                                      slc.dll, LPK.DLL, USP10.dll, comctl32.dll,
                                                      NTMARTA.DLL,WLDAP32.dll, WS2_32.dll,
                                                      NSI.dll, PSAPI.DLL, SAMIB.dll,
                                                      milcore.dll, dwmapi.dll, uDWM.dll,
                                                      WindowsCodecs.dll, ctagent.dll, d3d9.dll,
                                                      VERSION.dll, d3d8thk.dll, nvd3dum.dll,
                                                      IconCodeService.dll
            explorer.exe                       2892  ntdll.dll kernel32.dll, ADVAPI32.dll,
                                                      RPCRT4.dll, GDI32.dll, USER32.dll,
                                                      msvrt.dll, SHLWAPI.dll, SHELL32.dll,
                                                      ole32.dll, OLEAUT32.dll, SHDOCVW.dll,
                                                      UxTheme.dll, POWRPROF.dll, dwmapi.dll,
                                                      gdiplus.dll, slc.dll, PROPSYS.dll,
                                                      BROWSEUI.dll, IMM32.dll, MSCTF.dll,
                                                      DUser.dll,LPK.dll, USP10.dll,
                                                      comctl32.dll, WindowsCodecs.dll,
                                                      apphelp.dll, CLBCatQ.dll, cscui.dll,
                                                      CSCDLL.dll, CSCAPI.dll,
                                                      IconCodecService.dll, Secur32.dll,
                                                      rsaenh.dll, msiltcfg.dll, VERSION.dll,
                                                      msi.dll, NTMARTA.dll, WLDAP32.dll,
                                                      WS2_32.dll, NSI.dll, PSAPI.DLL, SAMLIB.dll,
                                                      SFC.dll, sfc_os.dll, SETUPAPI.dll,
                                                      timedate.cpl, ATL.DLL, NETAPI32.dll,
                                                      OLEACC.dll, actxprxy.dll ,USERENV.dll
        获知进程加载了哪些DLL模块有助于确定导致进程不正常（失去响应、不释放CPU，或者占用了超过正常需求的内存）的原因。有些情况下，你可能需要检查DLL版本，以便确定其是否为系统应该使用的DLL版本。为此，你应该查询微软知识库或制造商文档，以便确定DLL版本及其他相关信息。
        如果需要确定有哪些进程使用了某个指定的DLL，也可以在命令中指定DLL名。比如，如果怀疑打印机缓冲池驱动程序Winpool.drv是导致进程挂起的根源，就可以搜索使用Winspool.drv（而非Winspool32.drv）的进程，并检查这些进程的状态及资源使用情况。
        用于指定DLL的语法格式如下：
            tasklist /m DllName
        其中，DLLName为要搜索的DLL名。Tasklist在匹配DLL文件名时不区分大小写，你可以以任意大小写或混合形式输入要搜索的DLL文件名：
            tasklist /m winspool.drv
        通过上面的命令来搜索使用Winspool.drv的进程，其输出信息应该包括所有使用该DLL文件的进程名及各自的进程ID：
            Image Name                 PID  Modules
            ========================  ===== ==============================
            exporer.exe                2892 WINSPOOL.DRV
            rundll32.dll               3308 WINSPOOL.DRV
            acrotray.exe               3340 WINSPOOL.DRV
            IAAnotif.exe               3464 WINSPOOL.DRV
            IntelHCTAgent.exe          3584 WINSPOOL.DRV
            DrgToDsc.exe               3636 WINSPOOL.DRV
            WINWORD.EXE                4836 WINSPOOL.DRV
        4.对Tasklist的输出进行过滤
        通过Tasklist工具的/Fi参数，可以使用任何可用的信息字段对Tasklist的输出进行过滤，即便由于指定参数导致信息字段并没有正常包含在输出信息中。通过这种过滤机制，你可以只查看那些状态为失去响应的进程，或者只查看Svchost.exe进程相关的信息，或者查看占用了大量CPU时间的进程。
        通过使用过滤器操作符，可以过滤特定的Tasklist信息字段，如下的一些过滤器操作符是可用的。
        · Eq。等于，如果进程的某个字段包含了指定的值，则该进程应该包含在输出信息中。
        · Ne。不等于，如果进程的某个字段包含了指定的值，则该进程应该排除在输出信息之外。
        · Gt。大于，如果进程的某个字段包含了大于指定值的数值，则该进程应该包含在输出信息中。
        · Lt。小于，如果进程的某个字段包含了小于指定值的数值，则该进程应该包含在输出信息中。
        · Ge。大于等于，如果进程的某个字段包含了大于或等于指定值的数值，则该进程应该包含在输出信息中。
        · Le。小于等于，如果进程的某个字段包含了小于或等于指定值的数值，则该进程应该包含在输出信息中。
        如表所示，过滤器操作符可以使用的值依赖于该操作符针对Tasklist信息字段。要记住的是，所有字段都是可用过的，即便某些字段不能根据指定的参数正常显示。比如，你可以对status字段进行匹配，而不使用/V (verbose)标记。
            ----------------------------------------------------------------------------------------
            过滤器字段名|有效操作符|有效值
            ---------------------------------------------------------------------------------------
            CPUTime |eq、ne、gt、lt、ge、le、eq、ne|以hh:mm:ss格式呈现的任意有效值
            Services|eq、ne|任意有效的字符串

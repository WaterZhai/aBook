第五部分  使用命令行管理网络

第16章  管理网络打印机与打印服务
第17章  TCP/IP网络的配置、管理与故障排除

第16章  管理网络打印机与打印服务

大多数组织所拥有的打印机都是多样化的，包括一些高容量、高成本的打印机，也包括一些低容量、低成本的打印机。典型情况下，高容量打印机用于处理多个用户繁重的、日常的打印任务，低容量打印机用于处理小型组或单独用户的打印任务。不管哪种用途，打印服务器都需要足够的内存与处理能力来提供打印服务。在高容量的打印环境，或者经常性地打印很多非常大、非常复杂文档的环境中，需要对打印服务器进行特殊配置，或者使其专门提供打印服务。其他对打印只有一般性需求的环境中，打印服务器并不会非常昂贵，也不会是专门的计算机。实际上，很多打印服务器都是标准的桌面系统，同时还提供其他网络服务。要记住的是，Windows Server 2008与Windows Vista为文件共享赋予了比打印共享更高的优先级。因此，如果某系统同时处理这两种共享服务，则打印服务将会被抑制，以便先提供文件服务，从而防止出现文件访问性能问题。
打印服务器必须拥有足够的磁盘空间，用来处理打印任务。所需要的磁盘空间总量取决于打印任务的大小与打印队列的长度。为获得最佳性能，打印机缓冲池文件夹应该存储在专用的磁盘驱动器上（不用于打印缓冲之外的任何其他用途）。打印服务管理关键的一个部分是维护。为正确维护与支持打印服务，应该注意及时追踪打印缓冲池信息与使用情况的统计资料，这些信息有助于确定打印服务的执行情况。尽管你主要关注的可能是打印相关的性能问题，但你会发现，有几个命令行工具对打印服务器维护以及打印机故障排除也是有用的，本章将对这些工具进行讲解与讨论。

16.1获取打印机的支持信息与故障排除信息
    打印机在采购与部署时通常并未过多考虑如何使用。比如，公司内的某个职员觉得某个办公室需要一个打印机，就会采购并安装一个打印机。有时候这项工作并不是由管理员完成的，所以在管理员管理打印时，就会比较盲目。但不管打印机是如何获取的，管理员或支持小组都应该维护每一台打印机的配置信息，包括有哪些可用的驱动程序、使用的是哪种驱动程序等。作为管理员，应该定期检查打印机的任务繁忙程度，以及是否当前正在处理打印任务。也可能需要追踪打印机状态、打印队列中任务数以及其他有助于确定存在问题的重要信息。很多情况下，这些信息对于容量规划也是有用的。
    16.1.1在命令行中操作打印机
        与操作其他组件或硬件相比，在命令行中操作打印机存在一些不同，主要原因在于使用的工具存储在子目录中，并且这些子目录不是默认情况下命令路径的组成部分。为此，你或者需要切换到这些子目录中使用相关工具，或者对命令路径进行更新--2.2.1节对这一问题进行了讨论。在%SystemRoot%\System32\Printing_Admin_Scripts的场所特定的文件夹中，比如C:\Windows\System32\Printing_Admin_Scripts\en-us，你会发现其中存在如下一些Windows脚本。
        · prncnfg.vbs。用于列出与管理打印机配置设置信息。
        · prndrvr.vbs。用于列出。安装与管理打印机驱动程序。
        · prnjobs.vbs。用于列出与管理打印队列中的打印任务。
        · prnmngr.vbs。用于安装、列出与移除打印机。
        · prnport.vbs。用于添加、配置与移除打印机使用的TCP/IP端口。
        · prnqctl.vbs。用于管理打印队列。 
        · pubprm.vbs。用于在活动目录中发布打印机。
        如果是第一次在命令行中操作脚本，或者已将WScript设置为主脚本宿主，则需要将CScript设置为默认的脚本宿主。为此，需要在命令行中键入cscript//h:cscript//s。设置之后，就可以操作命令行脚本宿主，而非图形界面的脚本宿主。要记住的是，脚本宿主是以每个用户为单位进行设置的。因而，如果需要以某个用户身份运行一个脚本，但该用户可能尚未将CScript设置为默认的脚本宿主，为避免这一情况，可以在脚本中添加一行：cscript//h:cscript//s。 
        对上面的每一个脚本，通过-S参数，可以指定要操作的远程计算机；通过使用-U与-W参数，可以指定登录凭据。其中，-U用于指定远程登录的用户账号，-W用于指定该账号的口令。下面的实例中，将远程计算机设置为PrintServer43，并使用WilliamS的登录凭据：
            -s PrintServer43 -u WilliamS -w Rover 
        （注解  与大多数命令类似，你也可以同时指定用户域与用户账号，其格式为Domain/User。）
        另一个有用的工具是打印机备份与迁移工具（Printbrm.exe）。在为远程服务器管理安装PrintServices工具时，或者为Windows服务器添加Print Services角色时，会在%SystemRoot%\System32\Spool\Tools文件夹中发现Printbrm，使用Printbrm可以完成如下一些任务。
        · 列出打印机的配置信息摘要。
        · 备份与恢复打印服务器的配置。
        · 恢复时将LPR端口转换为TCP/IP端口。 
        · 将打印机与打印队列从某计算机迁移到其他计算机。
        · 在活动目录中发布所有可用的打印机。
        由于Printbrm是一个命令行工具，因此不需要通过脚本宿主执行。使用Printbrm时，可以使用-S参数指定待操作的远程主机。然而，由于无法指定可替代的登录凭据，你应该使用增强的命令提示符，并以一个具有操作打印机、打印驱动程序、打印队列权限的用户身份登录。
    16.1.2追踪打印驱动程序与打印机信息
        要更好地了解打印服务器上打印机的配置与使用方式，你可以需要追踪其上安装的打印机的详细信息。Prndrvr就是一款可用于获取已安装打印机及其驱动程序信息的工具。使用Prndrvr与-L参数，可以列出本地计算机上安装的所有打印机及其各自的打印驱动程序配置。如命令清单16-1中所示，所列出的打印驱动程序与打印机信息是非常详细的。
            命令清单16-1 Prndrvr-1的输出信息
                Server name PrintServer43 
                Driver name magicolor 2300 DL.3.Windows NT x86 
                Version 3
                Environment Windows NT x86 
                Monitor name MLMON_B.DLL 
                Driver path C:\Windows\systen32\spool\DRIVERS\W32X86\3\MIMFN5_B.DLL 
                Data file C:\Windows\system32\spool\DRIVERS\W32X86\MSDMLT_B.DLL 
                Config file C:\Windows\system32\spool\DRIVERS\W32X86\MNT5UI_B.DLL 
                Help file C:\Windows\system32\spool\DRIVERS\W32X86\3\MSDMLT_B.DLL 
                Depedent files
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSPL32_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSPOOL_B.DLL
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MIMFPR_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MIMF32_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSDIMF_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MQDPRT_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSD32__B.DLL
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSR32__B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MDDM32_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MCMM___B.DLL
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM___B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MGDI32_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MDDMUI_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MTAG32_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MLTSRV_B.DLL
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSUMLT_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM6__B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM12_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM24_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM6L_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM12LB.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MICM24LB.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MSEP01_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MUINST_B.DLL 
                    C:\Windows\system32\spool\DRIVERS\W32X86\3\MUNZ___B.DLL 
        检查这些信息可以发现，其中包含了如下的一些信息。
        · 打印机驱动程序名，比如magicolor 2300 dl。Windows使用打印机驱动程序名来追踪打印机驱动程序，打印机使用的驱动程序应该与打印机的实际类型相匹配。在上面的实例中，打印机属于Minolta Magicolor 2300 DL系列打印机。打印文档时，用于打印的应用程序会使用打印机驱动程序将文档转换为物理打印设备可以识别的文件格式。如果打印机出现问题，并怀疑是因为加载了错误的驱动程序，这将是最好的标志。
        · 打印机驱动程序模式。打印机驱动程序或者运作在类型2（内核）模式，或者运作在类型3（用户）模式。在相应的输出信息中，内核模式标记为Version2，用户模式标记为Version3。在内核模式下。打印机驱动程序的运作方式与其他由操作系统运行的程序类似；在用户模式下，打印机驱动程序的运作方式与其他由用户运行的程序类似。典型情况下，内核模式下的终止错误信息比用户模式下的终止错误信息更为详细。然而，如果打印机驱动程序本身存在问题，则运行在内核模式下更容易造成系统的不稳定。在Windows Server 2008与Windows Vista下，更倾向于选择使用用户模式的打印机驱动程序，以便确保操作系统自身的稳定性。
        · 可用的打印机环境。共享打印机时，Windows会自动将驱动程序设置为可用，以便用户在第一次连接该打印机时可以下载。典型情况下，只有类型3 X86驱动程序是默认可用的。类型3 X86驱动程序。比如，如果所在组织拥有X64或IA64计算机，就需要为这些计算机安装适当的打印机驱动程序。
        · 使用的打印监视器。每一个打印设备都有相关联的打印监视器。支持双向打印的打印机有宇哥语言监视器，用于处理打印机与打印缓冲池之间的双工通信，还有一个端口监视器，用于控制与打印机相连的I/O端口，所有这些统称为打印设备的打印监视器。如果打印机有相关联的语言监视器，则该监视器的名字被指定为与文件名相同，只是没有.dll扩展名。如果没有语言监视器，则名字值指定为Null，或者不指定。待打印文档到达打印机栈顶后，打印监视器负责将其发送到相关的打印设备，即实际完成打印工作的物理打印机。大多数打印设备都有自己的打印监视器，是由打印设备的制造商创建的。Windows也有自己默认的打印监视器。要使得打印设备完成实例的打印任务，打印监视器是必须的。如果打印监视器损坏或者找不到，则需要重新安装。
        · 打印缓冲池DLL与相关的数据文件。打印缓冲池的特定DLL文件是由驱动程序路径指定的。缓冲池有相关联的数据、配置与帮助文件。打印缓冲池用于存储用户需要打印处理器处理的文档。打印处理器的作用是创建原始的、必要的打印数据，用来提供给打印设备。打印设备再将这些数据回传给打印缓冲池吗，以便其在缓冲池中排队等待打印。
        · 打印机驱动程序栈文件。与特定打印机驱动程序相关联的所有栈文件都是以独立文件的形式列出的。待打印文档的路由（使用打印路由器）是从打印缓冲池到打印机栈的，也称为打印队列。出现在打印队列中之后，待打印文档就称为打印任务，这意味着该文档已经称为打印缓冲池需要处理的任务。
        如果需要使用Prndrvr返回远程打印服务器与网络打印机的驱动程序信息，可以使用-S参数，其后跟随服务器的域名，比如：
            prndrvr -s corpserver01 
        上面的命令中，检查的是CorpServer01的打印机驱动程序信息。
        Prndrvr命令的输出中，缺少一些详细资料，无法完整反映打印机配置的相关信息。要获取更多打印机相关信息，可以使用Printbrm命令与-Q参数。尽管Printbrm -Q的输出与Prndrvr -I的输出类似，但可以提供一些重要的附加信息。参考如下实例输出信息：
            Operation mode: query 
            Target server: local machine 
            Queue publish mode: none 
            Overwrite Mode: keep existing settings 

            LISTING  PRINT  QUEUES 
            hp laserjet 9500 on second floor 
            magicolor 2300 main floor 
            Adobe PDF 

            LISTING PRINTER DRIVERS 
            hp laserjet 9500 series, Windows NT x86, HP_PRNMON.DLL 
            magicolor 2300 DL, Windows NT x86, MLMON_B.DLL 
            Adobe PDF Converter, Windows NT x86, None 

            LISTING PRINT  PROCESSORS 
            hpzpplhn Windows NT x86 hpzpplhn.dll 
            MIMFPR_B Windows NT x86 MIMFPR_B.DLL 

            LISTING PRINTER PORTS 
            192.169.0.90, TCP 
            192.168.1.90, TCP 

            Displaying print hierarchy.
            hp laserjet 9500 on second floor 
                hp laserjet 9500 (Windows NT x86) #1
                192.168.1.80  #1
            magicolor 2300 main floor 
                magicolor 2300 DL (Windows NT x86) #1
                192.168.1.90  #1
            Adobe PDF 
                Adobe PDF Converter (Windows NT x86)  #1
            Unassociated:
                192.168.0.70 #0
        上面的输出信息中，可以发现如下一些信息。
        · 所有打印队列的列表，分别列出了打印队列名。
        · 已安装打印机的打印驱动程序列表，列出了打印驱动程序名、激活的驱动程序环境以及相关联的打印监视器。
        · 已配置的网络打印机端口列表，列出了相关的IP地址与类型。
        · 计算机上打印体系列表，用于将打印队列与相关的打印驱动程序（也可能还有打印机端口）进行关联。
        （注解  打印机可以使用LPT、COM或USB端口直接连接到打印服务器，网络上的打印机通常还设置了IP地址与TCP端口。）
    16.1.3获取用于容量规划与故障排除的打印详细统计资料
        通过追踪打印队列信息与使用情况的统计资料，有助于回答如下一些重要问题。
        · 打印服务器的平均繁忙程度？
        · 打印任务的平均大小？
        · 打印队列中排队等待的打印任务数？
        · 当前缓冲池运行了多久？
        · 打印缓冲池运行了多久？
        · 打印机运行了多久？
        · 打印服务器运行了多久？
        这些问题之所以重要，是因为通过对这些问题的解答，可以更积极地管理与维护组织内的打印服务，也可以对未来的打印需求进行规划。作为管理员，不应该仅仅满足于对这些问题进行解答，而是应该更进一步，以便为组织内的打印用户提供更好的打印服务。
        用于追踪打印缓冲池信息与使用情况统计信息的关键工具是Print Queue这一计数器对象，该对象可以通过TYPEPERF命令进行访问。这一性能计数器对象包含了很多性能计数器，可用于追踪打印队列与使用情况统计资料。如第6章到第9章中所讨论的，在命令行中，可以使用很多技术来操作和自动监控性能对象。
        操作Print Queue对象时，你可能需要追踪_Total计数器实例，用来确定打印服务器的整体繁忙程度，也可能需要追踪单独的计数器实例，用来确定某个特定打印队列的繁忙程度。可用于确定使用情况统计资料的重要计数器包括下面列举的。
        · Bytes Printed/sec。列出每秒钟打印的字节数，用来确定打印机处理的数据量以及每台打印机的繁忙程度。通过将Bytes Printed/sec与打印服务器的开机时间相比较，可以了解打印机每小时或每天处理的数据量。
        （注解  有些打印机的配置中，打印任务是在排队后保存的，使得用户可以从打印队列（而不是从应用程序）将文档重提交给打印机。如果需要将打印机配置为保存打印任务，就应该监视Bytes Printed/sec与打印任务的总数。这些信息有助于确定需要多大的磁盘空间，以便维护打印服务，并了解需要从打印队列中清楚旧打印任务的频率。）
        （提示  大多数打印机拥有自己的内部内存。理想情况下，你可能希望该内存足够大，以便整个打印任务可由打印设备自身完成。如果打印机需要经常性地处理大的或复杂的打印任务，可以考虑为打印设备添加内存。你需要通过打印机的配置页面（可以在打印机自身进行打印）来确定其已安装的内存大小。）
        · Jobs。展示排队等待的打印任务数。典型情况下，繁忙的打印机都会有几个排队等待的打印任务，尤其在峰值打印时间段。然而，如果频繁地发现有很多打印任务需要排队等待，则可能说明该打印机处于任务过载状态。为解决这一问题，可以让用户知道还有哪些可用的打印机，或者为某些用户设置不同的默认打印机。
        · Jobs Spooling。列出当前缓冲池中的打印任务数（这些任务稍后将进入打印队列），实际上也是入栈的任务数。
        · Max Jobs Spooling。列出当前缓冲池中的峰值打印任务数。
        · References。列出打印队列当前开放的句柄数，开放句柄可以来自当前没有处于活跃打印状态的用户，每个开放的句柄都会占用资源。
        · Max References。列出打印队列的峰值开放句柄数。
        · Total Jobs Printed。展示自打印服务器上次重启依赖处理的打印任务数，该值可以相对表示出某打印机的繁忙程度。通过将打印任务数总量与打印服务器的开机时间相比较，可以准确确定打印机的繁忙程度。
        · Total Pages Printed。展示自上次重启以来打印队列中打印的页面数，该值可以相对表示出某打印机的繁忙程度。
        示例16-1展示了一个使用TYPEPERF命令获取企业内多台打印服务器相对打印负载快照的实例。该实例中，使用名为Perf.txt的计数器文件指定带追踪的计数器。出打印队列计数器之外，还对System对象的System Up Time计数器进行了追踪，以便确定自计算机上次重启以后运行的时间（以秒为计数单位）。从每一台打印服务器上收集一个示例，将输出信息保存到一个名为SaveData.txt的文件中。如果将这些数据导入到电子表格中，或者将其转换到Word文档的表格中，就可以更清晰地观察这些输出信息，并准确理解每台打印服务器的繁忙程度。
        示例16-1  获取打印服务器的使用情况统计资料
            Comand line 
            typeperf -cf c:\printers\perf.txt -o c:\printers\savedata.txt -so 1 -y
            Source for perf.txt 
            \\printserver14\system\System Up Time 
            \\printserver14\print queue(_Total)\Bytes Printed/Sec 
            \\printserver14\print queue(_Total)\Jobs Spooling 
            \\printserver14\print queue(_Total)\Max Jobs Spooling 
            \\printserver14\print queue(_Total)\Jobs 
            \\printserver14\print queue(_Total)\References 
            \\printserver14\print queue(_Total)\Max References 
            \\printserver14\print queue(_Total)\Total Jobs Printed 
            \\printserver14\print queue(_Total)\Total Pages Printed 
            \\printserver21\system\System Up Time 
            \\printserver21\print queue(_Total)\Bytes Printed/Sec 
            \\printserver21\print queue(_Total)\Jobs Spooling 
            \\printserver21\print queue(_Total)\Max Jobs Spooling 
            \\printserver21\print queue(_Total)\Jobs 
            \\printserver21\print queue(_Total)\References 
            \\printserver21\print queue(_Total)\Max References 
            \\printserver21\print queue(_Total)\Total Jobs Printed 
            \\printserver21\print queue(_Total)\Total Pages Printed 
            \\printserver32\system\System Up Time 
            \\printserver32\print queue(_Total)\Bytes Printed/Sec 
            \\printserver32\print queue(_Total)\Jobs Spooling 
            \\printserver32\print queue(_Total)\Max Jobs Spooling 
            \\printserver32\print queue(_Total)\Jobs 
            \\printserver32\print queue(_Total)\References 
            \\printserver32\print queue(_Total)\Max References 
            \\printserver32\print queue(_Total)\Total Jobs Printed 
            \\printserver32\print queue(_Total)\Total Pages Printed 
            Sample output
            "(PDH_CSV 4.0)","\\printserver14\system\System Up Time","\\printserver14\print queue(_Total)\Bytes Printed/Sec","\\printserver14\print queue(_Total)\Jobs Spooling","\\printserver14\print queue(_Total)\Max Jobs Spooling","\\printserver14\print queue(_Total)\Jobs","\\printserver14\print queue(_Total)\References","\\printserver14\print queue(_Total)\Max References","\\printserver14\print queue(_Total)\Total Jobs Printed","\\printserver14\print queue(_Total)\Total Pages Printed"
            "10/12/2009 08:20.509","15535.955367","96.827000","3.000000","19.000000","8.000000","93.000000","151.000000","267.000000","2413.000000"

            "(PDH_CSV 4.0)","\\printserver21\system\System Up Time","\\printserver21\print queue(_Total)\Bytes Printed/Sec","\\printserver21\print queue(_Total)\Jobs Spooling","\\printserver21\print queue(_Total)\Max Jobs Spooling","\\printserver21\print queue(_Total)\Jobs","\\printserver21\print queue(_Total)\References","\\printserver21\print queue(_Total)\Max References","\\printserver21\print queue(_Total)\Total Jobs Printed","\\printserver21\print queue(_Total)\Total Pages Printed"
            "10/12/2009 08:21.002","2487384.875323","124.393923","17.000000","39.000000","12.000000","165.000000","223.000000","17897.000000","35672.000000"

            "(PDH_CSV 4.0)","\\printserver34\system\System Up Time","\\printserver34\print queue(_Total)\Bytes Printed/Sec","\\printserver34\print queue(_Total)\Jobs Spooling","\\printserver34\print queue(_Total)\Max Jobs Spooling","\\printserver34\print queue(_Total)\Jobs","\\printserver34\print queue(_Total)\References","\\printserver34\print queue(_Total)\Max References","\\printserver34\print queue(_Total)\Total Jobs Printed","\\printserver34\print queue(_Total)\Total Pages Printed"
            "10/12/2009 08:21.535","86375.673823","24.975632","2.000000","7.000000","3.000000","43.000000","67.000000","514.000000","5785.000000"
        上面的实例中，对3台打印服务器的打印队列进行了检查，并假定每台打印服务器有一个朱打印队列、单台打印服务器上所有活跃打印队列针对的是同一台物理打印机。检查示例中PrintServer14的输出信息，可以确定如下一些事实。
        · 该服务器平均每个小时处理62个打印任务。因为打印池中共计267个打印任务，服务器开机时间为4.3个小时，用Total Jobs Printed值除以System Up Time值（以小时为计数单位，而非分钟），就可以获得这个结果。
        · 打印任务的平均长度为2页，这是通过将打印的页面总数除以打印任务总数得到的。
        · 当前，该打印服务器缓冲池中有3个活跃的打印任务，打印队列中有8个打印任务，缓冲池中打印任务峰值为19。
        检查示例中PrintServer21的输出信息，可以确定如下一些事实。
        · 该服务器平均每小时处理26个打印任务。因为打印池中共计17897个打印任务，服务器开机时间为691个小时，用Total Jobs Printed值除以System Up Time值（以小时为计数单位，而非分钟），就可以获得这个结果。
        · 打印任务的平均长度为2页，这是通过将打印的页面总数除以打印任务总数得到的。 
        · 当前，该打印服务器缓冲池中有17个活跃的打印任务，打印队列中有12个打印任务，缓冲池中打印任务峰值为39。
        检查示例中PrintServer34的输出信息，可以确定如下一些事实。
        · 该服务器平均每小时处理19个打印任务。因为打印池中共计514个打印任务，服务器开机时间为27个小时，用Total Jobs Printed值除以System Up Time值（以小时为计数单位，而非分钟），就可以获得这个结果。 
        · 打印任务的平均长度为11.25页，这是通过将打印的页面总数除以打印任务总是得到的。
        · 当前，该打印服务器缓冲池中有2个活跃的打印任务，打印队列中有3个打印任务，缓冲池中打印任务峰值为7。
        从上面信息可以看出，可以发现当前的打印环境处于繁忙状态，有较重的打印负载。如果在几个时间间隔内检查这些统计信息，并在几次重启printers/spooler之后都看到类似的统计信息，则需要对其进行检查或重新配置。因为这些信息表明打印机处于非常繁忙的状态，考虑到大多数打印机实际上只有在上班时间（12小时，甚至8小时）才会有人使用，这一情况就更需要关注。
        对于这一水平的使用情况，你可能需要密切关注服务器的使用与性能信息，如第7章中所讨论的。你可能还需要深入挖掘使用情况的统计资料，查看每台打印机配置的详细情况。在对系统性能与使用情况进行了足够时间间隔的检测后，你会发现如下一些事实。
        · 打印服务器需要添加更多的内存，因为在任意给定时间点上都有大量的打印任务需要处理。
        · 需要更强的处理能力，因为平均处理的打印任务数较大。
        · 需要更大的磁盘空间或者用于缓冲池文件夹的专用磁盘驱动器。
        Print Queue对象还包括几个附加的性能计数器，有助于常规监控，包括下面列举的。
        · Job Errors。列出自上次重启以来打印队列中的任务错误数。在将打印任务传递给打印机时，如果中间出现问题，就会导致任务错误。如果任务错误数相对较多，则可能表明存在网络故障，或是网卡问题。
        · Not Ready Errors。列出自上次重启以来打印队列中的打印机尚未就绪错误。如果打印机等待用户输入，或者没有做好打印的准备，就会出现这一错误。
        · Out Of Pager Errors。列出自上次重启以来打印队列中的出纸错误。如果打印机频繁出现这一错误，则说明打印纸没有正确配套，或者需要一个附加的进纸盒。
        上面的示例中，给出的打印系统是相对简单的，通过常规性地监控与适当调整，就可以确保打印服务的正确运行。如果需要自动监控，可以创建一个脚本，将使用统计资料写入到一个日志文件中，并将该脚本设置为计划任务，使其在适当的时间间隔运行，第9章中对这些技术进行了讨论。
        要记住的是，通常需要的是以几天为周期对打印机使用情况进行监控，以便确定是否需要进行必要的升级或修改。进行升级或修改时，你需要终止打印缓冲池，完成之后再重启。
16.2管理打印机
    在命令行中，可以使用Prnmngr工具安装与管理打印机。通过Prnmngr，可以操作物理连接到计算机上的打印设备，但只有登录到该计算机的用户才可以进行操作，对这些用户而言，打印设备称之为本地打印设备，对于那些通过网络进行操作的打印设备，则称之为网络打印设备。本地打印机与网络打印机的关键区别在于，本地打印机不能共享。在网络上共享打印机时，需要使用某台计算机作为该打印机的宿主机，该计算机称之为打印服务器。
    打印服务器的主要任务是将打印设备共享在网络上，并处理打印缓冲池。通过使用打印服务器，可以很便利地对打印队列服务器。实际上，用户也可以直接连接到网络上的打印机，之后就像对连接到用户计算机上的本地打印机一样进行操作。这种方式下，每个用户有自己的打印队列，必须分别进行管理。
    在计算机上安装打印机时，实际上是配置一个打印队列，以便对打印任务进行路由排队，并在合适的时间将其发送到物理打印设备。因此，讨论安装打印机与配置打印机，实际上是讨论安装与配置打印队列，以便打印任务发送到物理打印设备。
    如果需要安装或配置打印机，需要具备适当的管理员特权。在域内，这意味着必须是管理员组、Print Operators组或Server Operators组的成员。如果只是需要连接并使用打印机，则不需要具备管理员特权，只需要具备适当的访问许可权限就可以。
    16.2.1安装物理连接的打印设备
        物理连接的打印设备直接连接在计算机上，可以配置为本地打印设备或网络打印设备。本地打印设备只对登录到该计算机的用户是可用的，网络打印设备则作为共享资源，网络上具备适当权限的用户都可以访问并使用。配置时，使用适当的串口、并口或USB接口将打印设备物理连接到服务器上。如果配置的是网络打印机，则此计算机充当打印服务器。对即插即用式打印机，登录计算机后，只需要将打印机插到计算机上，就可以自动地识别、安装与配置打印机。
        你可以使用Prnmngr命令与如下一些参数，手动安装本地打印机。
        · -A AddPrinter。指定要添加或安装本地打印机。
        · -P PrinterName。为打印机指定一个打印机名。在控制面板的打印机页面或命令行中对打印机进行操作时，看到的就是这个打印机名。
        · -M PrinterModel。指定打印机型号。型号必须是由制造商指定的准确的型号，型号决定了打印机应该使用的驱动程序。
        · -R PrinterPort。指定打印机应该连接到的端口号。端口可以是并口，比如LPT1：、LPT2：、LPT3：。也可以是串口，比如COM1：、COM2：、COM3：。还可以是USB端口，比如USB001。
        （注解  设置打印机名与型号时，字母的大小写与命令提示符与对话框中显示的是一样的。然而，尽管设定和显示时这些名称能用大小写，但实际上并不区分大小写。也就是说，在Windows看来，centralcolorlaser与CentralColorLaser是一样的。）
        要配置物理连接的打印机，并不一定需要本地登录计算机，也可以远程进行安装与配置。为此，可以使用-S参数指定远程计算机名（需要为其添加本地打印机）。如果有必要，还可以分别使用-U参数与-W参数指定连接到远程计算机时使用的用户名与口令。
        （注解  在本地命令提示符进行操作时，不管是远程登录还是物理连接，都不能指定用户名与口令。如果尝试这样做，会返回错误消息“用户凭据不能用于本地连接。”）
        要了解如何使用Prnmngr命令，参考如下一些实例。
        使用USB001配置一台HP 5500 Series InkJet打印机：
            prnmngr -a -p "OfficeJetPrinter" -m "hp officejet 5500 series" -r USB001 
        使用LPT1配置一台HP 1100 DN Series InkJet打印机： 
            prnmngr -a -p "BusinessJetPrinter" -m "hp businessjet 1100 series DN" -r LPT1:
        在chesign09上使用USB001配置一台Epson Stylus Photo打印机：
            prnmngr -a -p "hotoPrinter" -m "epson stylus photo 1270 esc/p 2" -r USB001 -s cdesign09 
        在mteam06上使用LPT1配置一台Epson Stylus Color打印机：
            prnmngr -a -p "ColorPrinter" -m "epson stylus color esc/p 2" -r LPT1: -s mteam06 -u wrstanek -w goldfish 
        如果打印机成功安装，Prnmngr会报告“已添加打印机”，否则会报告“不能添加打印机”，并描述发生的错误。最常见的错误是型号输入错误或设备型号未知，这会导致Prnmngr报告打印机驱动程序未知。因此，要确保输入了正确的打印机型号名。
        （注解  如果是计算机上安装的第一台打印机，则会设置为默认的打印机，但不会自动设置为共享的打印机。如果需要将其进行共享，以便其他用户也可以使用，可以参考16.4.2节所作的讲述。）
        （提示  你可以为相同的打印设备创建附加的打印机，唯一的要求是打印机名与共享名是唯一的。通过这种做法，可以设置不同的属性，用来满足不同的需求。比如，一种配置为低优先级打印任务，另一种配置为高优先级打印任务。）
    16.2.2安装网络连接的打印设备
        网络连接的打印设备直接通过网卡连接到网络上，并配置为网络打印设备，以便网络用户可以将其作为共享打印设备对其进行访问。为此，需要将打印机连接到网络上，并为其配置适当的IP地址（或者从DHCP服务器获取IP地址），具体操作可以参考制造商的打印机手册。
        在打印机上配置TCP/IP后，还需要在充当打印服务器的计算机上创建一个TCP/IP端口。以便网络用户通过该端口连接到打印机。之后，就可以像安装物理连接的打印机一样对其进行安装，唯一的区别是使用-R参数指定创建的TCP/IP端口，而不是指定LPT、COM、USB等端口。比如，如果创建了一个名为IP_192.168.10.15的TCP/IP端口，则可以使用个如下命令添加一个使用该端口的打印机：
            prnmngr -a -p "CentralColorLaser" -m "magicolor 2300 dl" -r IP_192.168.10.15 -s corpsvr03 
        上面的命令安装了一台Minolta QMS Magicolor彩色激光打印机，该打印机使用TCP/IP端口。由于打印机是在CorpSvr03上配置的，因此该计算机将充当此打印机的打印服务器，但该打印机尚未设置为任意用户的默认打印机，也没有设置为共享资源。如果需要将该打印机设置为共享资源，以便其他用户可以使用，可以参考16.4.2节的讲述。
    16.2.3列出计算机上配置的打印机
        通过prnmngr -l命令，可以列出本地计算机上配置的所有打印机。如果需要查看远程计算机上的这些信息，可以使用-S参数，其后跟随计算机名，比如prnmngr -l -s corpsvr03。如果必要，也可以分别使用-U参数与-W参数指定登录帐号使用的用户名与口令。
        上面命令的输出信息展示了打印服务器名（如果在本地计算机上使用，则为空）以及其他一些关于每台打印机配置的重要信息，参考下面的实例：
            Server name corpsvr03 
            Printer name magicolor 2300 main for 5th floor 
            Share name magicolor 
            Driver name magicolor 2300 DL 
            Port name 192.168.1.92 
            Comment Main printer for the fifth floor. 
            Location 5/ne 
            Print processor MIMFPR_B 
            Data type IMF 
            Parameters 
            Attributes 2629 
            Priority 1 
            Default priority 0
            Status Idle 
            Average pages per minute 8 
            Printer status Idle 
            Extended printer status Unknown 
            Detended printer state Unknown 
            Extected detected error status Unknown 
            Number of printers enumberared 1 
        上面的实例中，打印机名、驱动程序名与端口名是在安装打印机时设置的，该打印机已设置为共享，以便域内其他用户可以用其完成打印任务。如果需要将该打印机移动到新的打印服务器上，真正需要注意的唯一信息是驱动程序名，大多数情况下该名与打印机型号是一致的。
    16.2.4查看与设置默认打印机
        在命令提示符中键入prnmngr -g命令，可以显示当前登录用户的默认打印机。如果希望该用户使用其他默认打印机，可以键入prnmngr -t -p命令，其后跟随待设置的默认打印机名，比如：
            prnmngr -t -p "magicolor 2300 DL" 
        如果成功执行，则Prnmngr会报告称打印机已经被设置为默认打印机。否则，Prnmngr会报告错误信息。典型情况下，“Not Found”错误说明输入了无效的打印机名。
    16.2.5打印机重命名
        对打印机重命名是无法通过Prnmngr完成的，而是需要使用命令行工具Prncnfg。对打印机重命名的语法格式为：
            prncnfg -x -p CurrentPrinterName -z NewPrinterName 
        其中，Prncnfg通过-X参数表明待执行的任务是对打印机重命名，之后使用-P参数指定当前打印机名，-Z参数设定新打印机名，比如：
            prncnfg -x -p "CentralColorLaser" -z "EngineeringPrinter" 
        如果该打印机存在，则Prncnfg会报告已对其进行了重命名，并设置了新打印机名。
        你也可以对远程计算机上的打印机重命名。为此，可以使用-S参数指定远程计算机名，比如：
            prncnfg -x -s corpsvr03 -p "CentralColorLaser" -z "EngineeringPrinter" 
        上面的命令中，对CorpSvr03上的打印机重命名。然而，这一命令不允许设置登录帐号。
    16.2.6删除打印机
        Prnmngr提供了用于删除特定计算机上打印机的两种方法，你可以如下命令删除单独的打印机：
            prnmngr -d -p PrinterName 
            比如：
            prnmngr -d -p "magicolor 2300 DL" 
        如果输入了无效的打印机名，Prnmngr会报告由于没有发现打印机而无法删除。如果没有许可权限删除打印机，Prnmngr会报告用户登录凭据无法枚举打印机，你需要使用具备管理员特权的账号登录。注意的是，操作远程计算机时情况不是这样。操作远程计算机时，可以使用-U参数与-W参数指定登录帐号及其口令，比如：
            prnmngr -d =p "magicolor 2300 DL" -s corpsvr03 -u wrstanek -p goldfish 
        通过如下命令，可以删除计算机上所有打印机：
            prnmngr -x 
        Prnmngr不会弹出提示信息询问是否确认操作，但会报告每个已删除的打印机，比如：
            Deleted printer OfficeJet 
            Deleted printer CentralPrinter 

            Number of local printers and connections enumerated 2 
            Number of local printers and connections deleted 2 
16.3管理网络连接打印机的TCP/IP端口 
    要连接到网络连接的打印机，需要使用TCP/IP端口，这是使用Prnport创建于管理的。与Prnmngr类似，Prnport也是一个必须使用命令行脚本宿主运行的Windows脚本。
    16.3.1为打印机创建与改变TCP/IP端口 
        通过-A参数，可以通知Prnport要执行的任务是添加TCP/IP端口，之后使用-R参数指定端口名，使用-H参数指定打印机的IP地址。通常的做法是，端口名以连接的打印机IP地址为基础设置。比如，如果需要为IP地址为192.168.10.15的打印机配置端口，则可以将其端口设置为IP_192.168.10.15。
        除端口外，还必须指定端口使用的输出协议。输出协议是使用-O参数设置的，或者是raw，或者是lpr。大多数打印机使用Raw协议。使用这种输出协议时，数据不经修改地使用指定的端口号发送到打印机。大多数请款修改，这一端口号为9100，这也是之所以使用这一数值作为默认值的原因。当然，你也可以使用-N参数将端口号指定为不同的数值。使用LPR协议时，端口是与LPR（行式打印机守护进程）联合使用的，可以使用-Q参数设置打印队列名。
        与大多数打印机配置命令类似，并不一定需要本地登录计算机来配置端口。如果需要对远程计算机上的打印机端口进行配置，可以使用-S参数指定待操作的远程计算机名。如果需要，可以使用-U参数与-W参数指定到远程计算机的用户名与口令。如果登录域与当前域不同，用户名可以指定为Domain\Username的形式。参考如下一些实例。
        添加一个端口，使用TCP Raw协议，通过9100端口连接到192.168.10.15：
            prnport -a -r IP_192.168.10.15 -h 192.168.10.15 -o raw 
        添加一个端口，使用Raw参数，通过9500端口连接到10.10.1.50：
            prnport -a -r IP_192.168.10.15 -h 10.10.1.50 -o raw -n 9500 
        添加一个端口，使用LPR输出，连接到172.20.18.2，将队列名设置为LPRQUEUE：
            prnport -a -r IP_192.168.10.15 -h 172.20.18.2 -o lpr -q lprqueue 
        在CORPSVR03上添加一个端口，使用TCP Raw协议，通过9100端口连接到192.168.10.15：
            prnport -a -r IP_192.168.10.15 -h 192.168.10.15 -o raw -s corpsvr03 
        如果成功创建，Prnport会报告“创建/更新端口”，否则会报告“无法创建/更新端口”，并描述发生的错误。
        大多数网络连接的打印机也支持简单网络管理协议（SNMP）。为使打印机支持这一协议，必须使用-Me参数激活SNMP，并使用-Y参数设置SNMP community名，使用-l参数设置SNMP设备索引。典型情况下，community名设置为Public，这表明网络上的任意用户都可以使用与管理该打印设备。设备索引用于指定SNMP community中一个特定的设备。第一个设备索引为1，第二个设备索引为2，以此类推。
        参考如下实例：
            Prnport -a -r IP_192.168.10.15 -h 192.168.10.15 -o raw -me -y public -i 1 
        （注解  你可以使用-Md参数禁用SNMP。）
        上面的实例中，配置了一个TCP/IP端口，所用协议为TCP Raw，并通过9100端口连接到192.168.10.15.此外，还激活了SNMP，并将SNMP community名配置为public，设备索引则为1。
        如果以后需要改变TCP/IP端口的配置，可以使用Prnport命令与-T参数。下面的实例中，使用-R参数指定待操作的端口，其他参数用于设置相关的属性值：
            prnport -a -r MainPrinter -h 10.10.12.50 -o raw -md 
        这一命令中，试图修改MainPrinter这一TCP/IP端口，IP地址设置为10.10.12.50，输出协议设置为Raw，并禁用SNMP。
    16.3.2列出打印机使用的TCP/IP端口相关的信息
        使用prnport -l命令，可以列出本地计算机上已配置的所有打印机TCP/IP端口。如果需要查看远程计算机的这一信息，可以使用-S参数，其后跟随计算机名，比如prnport -l -s corpsvr03。如果必要，也可以使用-U参数与-W参数指定登录帐号的用户名与口令。 
        输出信息中会展示打印服务器名（如果是本地计算机则为空），以及每个已配置端口的其他一些重要信息。下面给出的是一个Raw端口相关的实例：
            Server name 
            Port name IP_192.168.1.101 
            Host address 192.168.1.101 
            Protocol RAW 
            Port number 9100 
            SNMP Enabled 
            Community public 
            Device index 1
        下面给出的是一个LPR端口相关信息的实例：
            Server name 
            Port name IP_192.168.1.101 
            Host address 192.168.1.101 
            Protocol LPR 
            Queue crownnet 
            Byte Count Enabled 
            SNMP  Enabled 
            Comnunity public 
            Device index 1 
        （注解  LPR端口信息会错误地展示字节计数是激活的。在激活的情况下，计算机会在将文档发送到打印机之前统计其中包含的字节数。大多数打印机不需要进行字节计数，字节计数或降低性能，因为打印时对文档中每一字节进行计数是一个非常耗时的过程。）
    16.3.3删除打印机使用的TCP/IP端口 
        通过如下语法格式，可以删除打印机使用的各个端口：
            prnport -d -r PortName 
            比如：
            prnport -d -r IP_192.168.1.101 
        如果输入了无效的打印机名，Prnport会报告由于没有发现打印机而无法删除。如果没有许可权限删除打印机，Prnport会报告用户登录凭据无法枚举打印机，你需要使用具备管理员特权的帐号登录。注意的是，操作远程计算机时情况不是这样。操作远程计算机时，可以使用-U参数与-W参数指定登录帐号及其口令，比如： 
            prnport -d -r IP_192.168.1.101 -s corpsvr03 -u wrstanek -p goldfish 
16.4配置打印机属性
    使用Prncnfg脚本与-T参数，可以查看并配置打印机属性。不管当前操作的是什么属性，Prncnfg都期望使用-P参数指定打印机。与大多数打印机配置命令类似，并不一定需要本地登录计算机来配置打印机属性。如果需要修改远程计算机上的打印机属性（而非打印机名），可以使用-S参数指定待操作的远程计算机名。如果必要，可以使用-U参数与-W参数指定连接到远程计算机的用户名与口令。如果登录域与当前域不同，用户名可以指定为Domain\Username的形式。 
    16.4.1添加注释与位置信息
        通过为打印机添加注释与位置信息，可以使用户更便利地确定自己应该使用哪一台打印机。注释信息对打印机进行了常规意义上的描述，比如打印设备的类型与责任人。位置信息则描述了打印设备的物理位置。添加之后，这些信息会在打印机属性对话框中的“常规”选项卡中显示，也会在“打印”对话框（大多数应用程序中，选择了打印命令后会显示这一对话框）中显示。
        为打印机添加注释与位置信息的语法格式如下：
            prncnfg -t -p PrinterName -m "Comment" -l "Location" 
        上面的命令中，Prncnfg与-T参数的作用是声明要修改打印机属性，之后使用-M参数指定注释文本，使用-L参数指定打印机的位置信息，比如：
            prncnfg -t -s corpsvr03 -p "CentralColorLaser" -m "Main EngineeringPrinter" -l "5th Floor SE" 
        如果成功执行，Prncnfg会报告已经对打印机进行了配置。如果不能执行，则可能是因为没有使用双引号对信息进行封装，也可能是因为忘记输入了其中的一个或几个参数。当然，并不要求一定同时输入注释与位置信息，你也可以分别设置这些信息。
    16.4.2共享打印机
        在命令行中添加打印机之后，打印机并不会自动地设置为其他用户共享。如果需要共享打印机，比如专门使用Prncnfg命令对其进行配置。首先使用-T参数表明需要设置或改变打印机属性，使用-P参数指定待操作的打印机，之后使用-H参数设置共享名，并使用+Shared参数激活共享。为与Windows 2000之前的操作系统兼容，共享名在长度上应该为8个字符，并且不能包含空格。
        由于位置信息可能并不总是可见的，因此，共享名中也可以包含用于指明打印机所在位置的相关信息，以便为用户节省一些时间。比如，如果某个打印机放置在第五层的东南角，则可以将其命名为FifthSE。参考如下实例：
            prncnfg -t -s corsrv03 -p "CentralColorLaser" -shared 
    16.4.3在活动目录中发布打印机
        通过将打印机相关信息发布到活动目录中，可以使得用户更容易找到可用的打印机。打印机在活动目录中发布之后，用户可以根据打印机的位置与功能进行搜索。比如，打印机是否在楼内第五层？是否可以彩打？
        要对打印机发布进行配置，可以使用Prncnfg命令。如果需要将打印机发布到活动目录中，可以使用-T参数便是要对打印机属性进行设置或修改，-P参数指定待操作的打印机，之后使用-Published参数表示将要发布打印机，或者使用-Published参数表示将要从活动目录中移除打印机。
        参考如下实例。
        将CorpSrv03上的打印机CentralColorLaser发布到活动目录：
            Prncnfg -t -s corpsrv03 -p "CentralColorLaser" +published 
        从活动目录中删除名为OfficeJet的本地打印机：
            Prncnfg -t -p "OfficeJet" -published 
        无论是发布打印机还是移除打印机，Prncnfg都应该报告对打印机进行了配置。但如果打印机已经发布或移除，也不会报告错误。
    16.4.4设置分隔页并改变打印设备模式
        分隔页可以用在打印任务的起始处，以便在繁忙的打印设备上找到某个文档。可以用于改变打印设备模式，比如打印设备是使用PostScript或打印机控制语言（PCL）。
        分隔页存储在文件夹%%SystemRoot\System32中，Windows系统中定义了下面4中默认的分隔页。
        · pcl.sep。将打印设备切换到PostScript模式，并为每个文档打印一个分隔页。
        · pscript.sep。将打印设备切换到PostScript模式，但并不打印分隔页。
        · sysprint.sep。将打印设备切换到PostScript模式，并为每个文档打印一个分隔页。
        · sysprintj.sep。将打印设备切换到PostScript模式，并为每个文档打印一个分隔页。实际上是Sysprint.sep的替代版，只是使用了不同版本的旗标文本。
        通过Prcnfg，可以指定打印机应该使用上面的某个分隔页，或者文件夹%SystemRoot%\System32中的其他分隔页。使用-T参数表明正在设置或改变打印机属性，-P参数指定待操作的打印机，之后使用-F参数指定要使用的分隔页。
        参考如下实例：
            Prncnfg -t -s corpsrv03 -p "CentralColorLaser" -f sysprint.sep 
        上面的命令中，将CorpSrv03上的打印机CentralColorLaser配置为使用sysprint.sep。
        如果需要终止使用分隔页，可以使用-F参数与“ ”，比如：
            Prncnfg -t -s corpsrv03 -p "CentralColorLaser" -f " "
    16.4.5打印任务的调度与优先级设置
        在命令行汇总，可以使用Prncnfg命令管理打印任务的优先级并对其进行调度。打印任务总是按照优先级顺序进行打印，1代表最低优先级，99代表最高优先级。高优先级的打印任务比低优先级的打印任务具有更高的优先打印权。如果某物理打印设备包含几个打印机（打印队列），则每一个高优先级的打印任务都可以优先得到打印。使用-T参数表明正在设置或改变打印机属性，-P参数指定待操作的打印机，之后使用-O参数设置打印任务的优先级：
            prncnfg -t -p "EngineeringPrinter" -o 50 
        上面的命令中，将通过EngineeringPrinter传递给相关打印机的打印任务的优先级设定为50.比如，如果某个Marketing打印机也配置为使用同一个物理打印设备，但优先级低于50，则Engineering打印任务总是会优先得以打印。
        打印机或者总是可用的，或者只有在指定的时间段内可用。要设置打印机的可用性，可以使用-St参数与-Ut参数分别指定打印机可用于不可用的时间点，其中时间是以24小时时钟设置的，比如：
            prncnfg -t -p "EngineeringPrinter" -st 0530 -ut 1930 
        上面的命令中，指定打印机在每天的上午5点30到下午的7点30是可用的。
    16.4.6配置缓冲池与其他高级打印机选项
        对网络连接的打印机，通常需要打印机对文件进行缓存，而不是直接打印。通过打印缓冲池，可以使用打印机（打印队列）对打印任务进行管理。通过Prncnfg与如下一些选项，可以对打印缓冲池进行配置。
        · +Direct。通过该参数，可以将打印机配置为直接打印，而不需要通过打印缓冲池。并且，指定了该参数后，就不能再使用任意缓冲池选项。
        · -Direct。通过该参数，对打印文档进行缓存，以便程序可以快速完成打印任务。这是默认的打印选项。
        · +Queued。通过该参数，在打印文档最后一页缓存之后开始打印。如果希望在打印开始之前缓存整个文档，则可以选定这一选项，确保在打印开始之前整个文档进入打印队列。如果由于某些原因导致打印取消或未完成，则该打印任务不会被打印。
        · -Queued。通过该参数，只要开始缓存文档，就开始打印。如果希望在打印设备没有被占用的情况下立即开始打印，则可以选定这一选项。如果需要打印任务更快完成，或者需要确保应用程序尽可能快地将控制权转交给用户，则应该选择这一选项，这也是默认选项。
        · +Enabledevq。通过该参数，缓冲池会对打印机设置进行检查，并在将文档发送到打印设备之前与文档设置进行匹配。如果不匹配，缓冲池会抑制该打印任务，但允许匹配的文档进行打印。如果需要频繁地改变打印机型号或纸盒分配，则选择这一选项是有益的。
        · -Enabledevq。通过该参数，缓冲池在将文档发送到打印设备之前不会对打印机设置进行检查。如果不匹配，则打印机通常会终止打印，并等待用户取消该打印任务、改变打印机型号、或插入一个带有合适纸张类型的进纸盒。这是默认的选项。
        其他一些可以进行配置的Prncnfg高级选项包括下面列举的。
        · +Keepprintedjobs。通过该选项，任务在打印后不会从打印队列中删除。如果正在打印的文档不易创建，可以使用这一选项，用于以后需要打印该文档时不必再次创建该文档。
        · -Keepprintedjobs。通过该选项，任务在打印后会从打印队列中删除，从而释放打印任务占用的磁盘空间，但无法从打印队列中再次打印该文档。这是默认选项。
        · +Docompletefirst。通过该选项，则完成缓存的任务会比正在缓存的任务优先打印，而不管正在缓存的任务是否具有更高的优先级。这是默认选项。
        · -Docompletefirst。通过该选项，高优先级的任务将抢占低优先级的任务。设置该选项后，如果有高优先级的任务进入打印队列，则低优先级的任务会终止打印，高优先级的任务将开始打印。
        · Enablebidi。通过该参数，可以激活元文件缓存，并打开那些高级打印选项（如果支持），比如打印顺序、书册打印、多页合并打印。使用该选项时，如果注意到兼容性问题，则应该禁止相关功能。这是默认选项。
        · -Enablebidi。通过该参数，可以禁用元文件缓存，并关闭那些高级打印选项。如果打印机遇到兼容性问题，则应该使用这一选项。
        要了解如何使用这些选项，参考如下一些实例。
        将sales06上的SalePrinter配置为直接打印，并保持已打印的任务：
            prncnfg -t -s sales06 -p "SalesPrinter" +direct +keepprintedjobs 
        将本地计算机上的MainPrinter配置为在最后一页缓存后开始打印：
            prncnfg -t -p "MainPrinter" -queued 
        将corpsvr09上的HPLaserJet配置为抑制不匹配的文档，并禁用元文件缓存：
            prncnfg -t -s corpsvr09 -p "HPLaserJet" +enabledevq -enablebidi 
16.5解决缓存问题
    Windows使用Print Spooler服务控制打印任务的缓存。如果该任务尚未启动，则打印任务无法缓存。
    16.5.1检查PrintSpooler服务
        在本地计算机上，使用如下命令可以检查PrintSpooler服务的状态：
            sc query spooler 
        对远程计算机，则需要指定UNC服务名，比如：
        sc \\Engsvr04 query spooler 
        无论哪种，输出信息都包含spooler部分，类似于如下格式：
            SERVICE_NAME: spooler 
            TYPE        : 110 WIN32_OWN_PROCESS  (interactive)
            STATE       : 4 RUNNING (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
            WIN32_EXIT_CODE: 0 (0x0)
            SERVICE_EXIT_CODE: 0 (0x0)
            CHECHPOINT  : 0x0 
            WAIT_HINT   : 0x0 
        从上面信息可以看出，Print Spooler服务正在运行。如果该服务终止，则可能需要检查服务配置为此，可以键入如下命令：
            sc qc spooler 
            或
            sc \\Engsvr04 qc spooler 
        输出信息会报告PrintSpooler的启动设置，如下所示：
            [SC] QueryServiceConfig  SUCCESS 
            SERVICE_NAME: spooler 
            TYPE        : 110 WIN32_OWN_PROCESS  (interactive) 
            START_TYPE  : 2 AUTO_START 
            ERROR_TYPE  : 1 NORMAL 
            BINARY_PATH_NAME: C:\Windows\System32\spoolsv.exe 
            LOAD_ORDER_GROUP: SpoolerGroup 
            TAG         : 0
            DISPLAY_NAME: Print Spooler 
            DEPENDENCIES: RPCSS 
                        : http
            SERVICE_START_NAME: LocalSystem 
        从上面信息可以看出，启动类型为AUTO_START表明PrintSpooler服务被设置为自动启动。
    16.5.2修复损坏的缓冲池
        缓冲池也存在损坏的可能性。如果损坏，则打印机会停止工作，或者不能将打印任务发送到打印设备，有时候还可能导致打印设备无法理解的数据。大多情况下，终止后在重新启动PrintSpooler服务就可以解决问题。要终止PrintSpooler服务，可以键入如下命令：
            sc stop spooler 
        缓冲池终止后，如果需要重启该服务，可以键入如下命令：
            sc start spooler 
        如果操作的是远程计算机，也可以输入远程计算机名，比如：
            sc \\Engsvr04 stop spooler 
            sc \\Engsvr04 start spooler 
        （注解  有些缓存问题可能与许可权限有关。为解决这些问题，可以在%SystemRoot%\System32\Spool文件夹中检查打印机的访问许可权限与许可权限。）
16.6管理打印队列与单个打印任务
    有几个Windows脚本可用于操作打印队列及其包含的打印任务，比如，Prnqctl可用于启动、终止或暂停打印队列中所有文档的打印，Prnjobs可用于操作打印任务。
    16.5.1查看队列中的任务
        你可以使用Prnjobs查看打印队列中的任务。如果需要查看本地计算机上所有打印机的所有任务可以使用命令prnjobs -l。要查看特定打印机上的任务，可以使用-P参数指定打印机名。对远程计算机可以使用-S参数指定待操作的远程计算机。如果必要，还可以使用-U参数与-W参数指定远程登录的用户名与口令。
        参考如下实例。
        查看Corpsrv03上的所有打印任务：
            prnjobs -l -s corpsrv03 
        查看本地计算机上MainPrinter的所有打印任务：
            prnjobs -l -p MainPrinter 
        单个打印任务的输出包含了如下一些信息。
        · Job ID。打印任务标识符，在操作单个打印任务时是必需的。
        · Printer。打印机名。 
        · Document。文档文件名，可以包含打印该文档文件的应用程序名。
        · Data Type。打印机数据类型。
        · Driver Name。打印机驱动程序名，也代表了打印机型号。
        · Description。打印机描述信息。
        · Elapsed Time。文档打印的时间长度。
        · Job Status。打印任务状态，包括正在打印、缓存、暂停、正在删除、正在重启。
        · Notify。打印任务完成时应该通知的人（如果已经进行了通知配置）。
        · Owner。文档属主。
        · Pages Printed。到目前为止已打印的页面数。
        · Size。文档大小（以字节计数）。
        · Time Submitted。打印任务提交的时间与日期。
        · Total Pages。文档的页面总数。
    16.6.2打印机的暂停与恢复
        有时候需要暂停打印机，以便操作物理打印设备，对出现的问题进行故障排除。暂停打印机时，打印机完成当前的打印任务，并挂起所有其他打印任务。要暂停打印机，可以使用Prnqctl命令。先键入prnqctl -z，之后，对本地打印机，使用-P参数设置需要暂停的打印机名。对远程计算机。使用-S参数指定待操作的远程计算机。如果必须，还可以使用-U参数与-W参数指定用户名与口令，以便访问远程计算机。
        要恢复暂停的打印机，可以使用-M参数（而不是-z参数），用来重启对打印队列中所有文档的打印。
        参考如下实例。
        暂停CorpSrv03上EngineeringPrinter的打印：
            prnqctl -z -s corpsrv03 -p EngineeringPrinter 
        暂停本地计算机上5thfloorPrinter上的打印任务：
            prnqctl -z -p 5thfloorPrinter 
        恢复CorpSrv03上EngineeringPrinter的打印：
            prnqctl -m -s corpsrv03 -p EngineeringPrinter 
    16.6.3清空打印队列
        你可以使用Prnqctl命令清空打印队列，并删除其中所有内容。先键入prnqctl -x，之后，对本地打印机，使用-P参数设置需要清空的打印队列名，对远程计算机，使用-S参数指定待操作的远程计算机如果必要，还可以使用-U参数与-W参数指定用户名与口令，用来访问远程计算机。
        参考如下实例。
        清空salespc06上SalesPrinter的打印队列：
            prnqctl -x -s salespc06 -p SalesPrinter 
        清空本地计算机上TempPrinter上的打印任务：
            prnqctl -x -p TempPrinter 
        如果命令执行成功，Prnqctl会报告成功地打印队列中移除了文档，即便打印队列中本来可能没有文档。
    16.6.4暂停、恢复与重启单个文档的打印
        你可以使用Prnjobs暂停或恢复单个文档的打印。暂停某打印任务后，就挂起了对该任务的打印，但允许其他文档进行打印。恢复某打印任务后，就从该任务的挂七点恢复打印。
        要暂停某个打印任务，可以使用如下的语法格式：
            prnjobs -z -p PrinterName -j JonID 
        其中，PrintName是待操作的打印机名，JobID是待暂停任务的ID号。
        要恢复某个打印任务，可以使用如下的语法格式：
            prnjobs -m -p PrinterName -j JobID 
        其中，PrintName是待操作的打印机名，JobID是待恢复任务的ID号。
        上面的两种情况都指的是，默认情况下，对本地计算机上的打印机进行操作。对远程计算机上的打印队列，使用-S参数指定待操作的远程计算机。如果必要，还可以使用-U参数与-W参数指定用户名与口令，用来访问远程计算机。 
        参考如下实例。
        餐厅CorpSrv03上EngineeringPrinter中编号为6的任务的打印：
            Prnjobs -z -s corpsrv03 -p EngineeringPrinter -j 6 
        暂停本地计算机上5thfloorPrinter上编号为17的任务的打印：
            prnjobs -z -p 5thfloorPrinter -j 17 
        恢复CorpSrv03上EngineeringPrinter中编号为6的任务的打印：
            prnjobs -m -s corpsrv03 -p EngineeringPrinter -j 6 
        成功执行后，Prnjobs会报告成功暂停或恢复某ID打印任务的打印。如果指定的是无效的任务ID，Prnjobs会报告“不能设置打印任务”。
    16.6.5移除文档并取消打印任务
        你可以使用Prnjobs取消单独的打印任务并将其从打印队列中删除。先键入prnqctl -x，之后，对本地打印机，使用-P参数设置打印机名，使用-j参数指定待删除文档的ID。对远程计算机，使用-S参数指定待操作的远程计算机。如果必要，还可以使用-U参数与-W参数指定用户名与口令，用于访问远程计算机。
        参考如下实例。
        取消本地计算机上MainPrinter中ID为12的打印任务：
            prnjobs -x -p MainPrinter -j 12 
        取消CorpSrv03上EngineeringPrinter中ID为9的打印任务：
            prnjobs -x -s corsrv03 -p EnginerringPrinter -j 9 
        成功执行后，Prnjobs会报告成功取消打印任务。如果指定的是无效的任务ID，Prnjobs会报告“不能设置打印任务”。
        （注解  如果待取消的打印文档正在打印过程中，则打印设备会继续打印部分或全部文档。因为，大多数打印设备会将文档缓存在内部缓冲区中，因而会继续打印缓冲器中的内容。）
16.7备份与恢复打印服务器配置
    作为应对故障的常规规划的一部分，应该考虑如何处理打印机与打印服务器的失效。要对潜在的打印机问题有所准备，理想情况下，可以购置空闲的打印机或相应组件，用于修复或替换失效的打印机。如果不能，则应该指定好失效后的策略，以便用户可以使用替代的打印机，或者已经为用户在其计算机上配置好从打印机，以便在主打印机失效后使用。
    16.7.1备份打印服务器的配置
        要对潜在的打印服务器问题进行处理，应该准备一台可用的从打印服务器，或者将某台计算机设置为从打印服务器。作为周期性备份的一部分，你可以使用PrintBrm工具对打印服务器的打印机配置进行备份，使用如下命令：
            printbrm -b -f SaveFile 
        其中，SaveFile为打印机配置文件（带.printerexport扩展名）的全文件路径。你也可以使用-S参数指定远程计算机。下面的实例中，将打印机配置备份到PrintServer12_Config.printerexport文件中。
            printbrm -b -f PrintServer12_Config.printerexport 
        在对打印机配置进行备份的过程中，Printbrm工具还会列出打印机当前配置的摘要信息，并按步骤列出任务，如下面实例所示：
            Operation mode: backup 
            Target server: local machine 
            Target file path: c:\Windows\printserver12_config.printexport. 
            Queue publish mode: none 
            Overwrite Mode: keep existing settings 

            LISTING  PRINT  QUEUES 
            OfficeJetPrinter 
            HP  Color LaserJet 9500 main 

            magicolor 2300 DL 
            Adobe PDF 
            LISTING  PRINTER DRIVERS 
            hp officejet 5500 series, windiws NT x86, LIDIL hpzllhn 
            HP Color LaserJet 9500 PS, Windows NT x86, None 
            magicolor 2300 DL,Windows NT x86, MLMON__B.DLL 
            Adobe PDF Converter, Windows NT x86, None 
            LISTING PRINT  PROCESSORS 
            hpzpplhn Windows NT x86 hpzpplhn.dll 
            MIMFPR_B  Windows NT x86 MIMFPR_B.DLL 
            LISTING  PRINTER  PORTS 
            192.168.0.90, TCP 
            192.168.1.90, TCP 
            192.168.10.150, TCP 
            Saving Print Queues... 
            Saved print queue OfficeJetPrinter 
            Saved print queue HP Color LaserJet 9500 main 
            Saved print queue magicolor 2300 DL 
            Saved print queue Adobe PDF 
            Saving Print Processors...
            Saved print processor hpzpplhn, Windows NT x86, hpzpplhn.dll 
            Saved print processor MIMFPR_B, Windows NT x86, MIMFPR_B.DLL 
            Saving Printer Drivers...
            Saved printer driver hp officejet 5500 series, Windows NT x86, 3
            Saved printer driver HP Color LaserJet 9500 PS,Windows NT x86, 3
            Saved printer driver magicolor 2300 DL,Windows NT x86, 3
            Saved printer driver Adobe PDF Converter, windows NT x86, 3
            Saving Printer Ports...
            Saved printer port 192.168.0.90, TCP 
            Saved printer port 192.168.1.90, TCP 
            Saved printer port 192.168.10.150, TCP 
            ************ 100% Complete ************

            Successfully finished operation. 
        如果在输出中发现了错误信息，要对导致错误的问题进行解决，之后再次使用Printbrm工具进行备份。要确保打印机配置备份在全服务器故障时是可用的，还应该将配置文件复制到安全的网络文件夹或其他计算机上。
    16.7.2恢复打印服务器的配置
        对打印机配置进行备份后，可以有多种方式使用备份文件。发生打印服务器失效后，可以将打印服务器断开网络连接，之后使用Printbrm在新打印服务器上恢复打印机配置，再之后需要改变从打印服务器的IP地址与计算机名，以便于原始打印服务器匹配。设置完毕后，用户就可以访问打印机并恢复打印。
        用于恢复已保存打印配置的语法格式如下：
            printbrm -r -f ConfigFileToRestore 
        其中，ConfigFileToRestore为已保存打印机配置文件（带.printerexport扩展名）的全文件路径。下面实例中，使用PrintServer12_Config.printerexport文件恢复打印机配置：
            printbrm -r -f PrintServer12_Config.printerexport 
        恢复打印机配置时，Printbrm会列出设置与操作的摘要信息，如下面实例所示：
            Operation mode: restore 
            Target server: local machine 
            Target file path: c:\windows\printserver12_config.printerexport. 
            Queue publish mode: none 
            Overwrite Mode: keep existing settings 
            Restoring Printer Drivers...
            Restoring Printer Ports...
            Restoring Print Processors...
            Restoring Print Queues...
            ************ 0% ***********

            Successfully  finished operation.
        如果输出中包含了错误信息，要先解决导致错误的问题，之后再次运行Printbrm来恢复打印机配置。默认情况下，Printbrm不会重写现存打印队列的设置。在已经包含自己打印队列的计算机上恢复打印队列时，这是有益的。在无意间从打印服务器删除打印队列后，一般希望Printbrm只恢复已删除的打印队列，因而这种不重写设置也是有益的。
        要强制Printbrm执行恢复操作并重写现存打印队列的设置，可以使用-O FORCE参数，比如：
            printbrm -r -f PrintServer12_Config.printerexport -o force 
        如果对已保存打印机配置文件中的内容有疑问，可以使用如下的语法格式查询该文件并列出其中包含的内容：
            printbrm -q -f ConfigFileToQuery 
        其中，ConfigFileToQuery为已保存打印机配置文件的全文件路径。
    16.7.3迁移打印机与打印队列
        你可以使用Printbrm将打印机及其打印队列从打印服务器移动到其他打印服务器。如果需要加固多台打印服务器或替换旧的打印服务器，这是一种有效的方法。
        移动打印机时，打印机当前所在服务器为源服务器，打印机将迁移到的服务器为目的服务器。通过如下步骤，可以将打印机移动到新的打印服务器上。
        （1）为源服务器创建打印机配置文件，使用如下命令：Printbrm -b -s ServerName -f SaveFile。其中，ServerName为源服务器名或IP地址，SaveFile为.printerexport文件的文件名。
        （2）在目的服务器上恢复打印机配置文件备份，使用如下命令：Printbrm -r -s ServerName -f RestoreFile。其中，ServerName为目的服务器名或IP地址，RestoreFile为用于恢复的.printerexport文件的文件名。 
        如果目的服务器上包含的打印队列与来自源服务器的打印队列同名，可以通过-O FORCE参数使用恢复文件中的打印队列设置重写现存打印队列设置。
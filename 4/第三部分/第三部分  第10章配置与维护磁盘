第三部分  使用命令行管理Windows文件系统和磁盘

第10章  配置与维护磁盘
第11章  对基本磁盘进行分区
第12章  管理动态磁盘上的卷与RAID

第10章  配置与维护磁盘

本章将讲述关于磁盘配置与维护的技术，实际上这里涉及的内容比大多数人想象的要多得多。Windows Server 2008与Windows Vista支持硬盘驱动器与可移动存储设备。硬盘驱动器可以配置为基本的和动态的两种磁盘类型，以及主引导记录（MBR）与GUID分区表（GPT）两种磁盘分区类型；可移动存储设备的磁盘类型为可以动的。

10.1使用DiskPart
    要操作磁盘、磁盘分区和卷，DiskPart是首选的工具，它可以完成的主要任务包括转换磁盘类型、创建磁盘分区与卷、配置RAID等。比外，可以使用DiskPart对新磁盘的自动挂载进行配置，也可以通过它分配驱动器盘符与驱动器路径，还可以用它格式化磁盘。要格式化磁盘，可以使用FORMAT命令，该命令将在11.4节讨论。
    10.1.1DiskPart基础
        与本书中前面讲述的所有其他命令不同的是，DiskPart并不是一个可以使用命令行与参数调用的简单的命令行工具，而是一个文本模式的可调用的命令解释器，这样你可以使用一个单独的命令提示符与一些内部命令来管理磁盘、磁盘分区和卷。要调用DiskPart命令解释器，可以在命令窗口中键入diskpart，之后按Enter键。
        DiskPart的作用是操作计算机上安装的物理硬盘，可以是内部的、外部的。也可以是混合的。尽管DiskPart也会列出其他类型的磁盘，比如CD/DVD驱动器、可移动存储介质以及连接在USB接口的闪存设备，也可以执行一些恶基本的任务，比如分配盘符，但DiskPart不能完成对这些设备的完全管理与操作。
        在使用DiskPart命令之前，必须首先列出并选定待操作的磁盘、分区或卷。选定某个具体的磁盘、分区或卷之后，键入的DiskPart命令就会作用于该设备。
        通过如下的list命令，可以分别列出系统中的磁盘、卷与分区。
        · list disk。列出计算机上安装的所有物理硬盘。
        · list volume。列出计算机上安装的所有卷（包括硬盘分区与逻辑驱动器）。
        · list partition。列出选定的磁盘上的分区。
        使用这些list命令后，星号会出现在选定的磁盘、卷、分区之后。磁盘或分区的选择是通过其编号实现的，卷的选择是通过其编号或盘符实现的，比如disk 0、partition 1、volume 2、volume D等。 
        使用DiskPart解释器完成操作后，键入exit，就可以退出DiskPart提示符，并返回到标准的命令行。
    10.1.2DiskPart：一个实例
        要了解如何使用DiskPart，可以参考下面的实例，该实例调用了DiskPart，列出了可用的磁盘，并将焦点放置到disk 2。
        （1） 在命令提示符中键入diskpart，调用DiskPart。
        （2）执行后，命令提示符切换为
            DISKPART>
        （3）此时处于文本模式的DiskPart解释器中。要列出可用的磁盘，可以在命令提示符中键入list disk。 
        （4）list disk的输出信息列出了计算机中可用的磁盘及其状态、大小与可用空间：
            Disk###    Status    Size    Free    Dyn    Gpt    
            -------    ------    ----    ----    ---    ---
            Disk 0     Online    466GB   1528KB     
            Disk 1     Online    466GB   1528KB 
            Disk 2     Online    233GB   0B      *
        （5）由于disk 2是需要操作的磁盘，因此，键入select disk 2命令，将焦点防止在其上。
        （6）DiskPart报告：
            “磁盘2现在是所选磁盘。”
        （7）根据需要对该磁盘进行操作，完成后，键入exit，就可以退出DiskPart解释器。
    10.1.3理解焦点及其内涵
        选定了一个磁盘、分区或卷后，焦点自动放置在该设备，直到选择了另外的设备。前面的实例中，焦点防止在disk 2，但如果选择disk 0上的volume 2，则焦点会从disk 2转移到disk 0，volume 2。有些情况下，焦点会根据使用的命令自动变换。比如，黄建分区或卷后，焦点会自动切换到新的分区或卷。
        要注意的是，只能将焦点防止到当前选定磁盘上的某个分区。当焦点转移到某个分区上之后，其相关的卷也相当于放置了焦点。卷放置了焦点之后，相关的磁盘与分区也相当于放置了焦点（如果该卷映射到单一的特定分区）。如果该卷没有映射到单一的特定分区，则只有该卷具备焦点。
    10.1.4DiskPart命令与脚本
        LIST命令与SELECT命令只是DiskPart命令提供的众多命令中的两个。表10-1展示了DiskPart命令的完整列表，其中的很多命令接收Noerr作为另外的参数。该参数可用于DiskPart脚本中，其作用是在发生错误时，告诉DiskPart继续处理脚本中的命令。如果没有指定Noerr参数，则发生错误时，DiskPart命令会退出并返回错误代码。使得脚本的执行中断。
        · 可以使用Noerr参数并在退出时返回错误代码的命令包括ADD、ASSIGN、ATTRIBUTES、AUTOMOUNT、BREAK、CONVERT、CREATE、DELETE、EXTEND、IMPORT、OFFLINE、ONLINE、RECOVER、REMOVE、REPAIR、SAN、SETID、SHRINK、UNIQUEID。
        · 不使用Noerr参数或者在退出时返回错误代码的命令包括ACTIVE、CLEAN、DETAIL、EXIT、FILESYSTEMS、GPT、HELP、INACTIVE、LIST、REM、RESCAN、RETAIN、SELECT。
            表  DiskPart命令总结
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            命令        |描述                                                                                                      |语法
            -----------|----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            ACTIVE     |在MBR磁盘上，将当前焦点所在分区标记为活跃的系统分区，意味着该分区包含了操作系统启动文件                           |active 
            ADD        |在选定的动态磁盘上创建一个镜像卷                                                                             |add disk=n,其中n为包含镜像的磁盘编号;add disk=n[aligh=nn]
            ASSIGN     |为选定的分区、逻辑驱动器或卷分配盘符或挂载点                                                                  |assign letter=x;assign mount=path
            ATTRIBUTES |显示或管理磁盘或卷上的属性                                                                                  |attributes disk [set|clear] [readonly]（注意SP1版本前的Windows Vista不支持disk子命令）;attributes disk [set|clear] [hidden|readonly|nodefaultdriveletter|shadowcopy] （注意SP1版本前的Windows Vista不支持nodefaultdriveletter与shadowcopy子命令）
            AUTOMOUNT  |用于控制是否自动挂载新加入到系统中的基本卷并为分配盘符                                                         |automount[enable|disable|scrub]
            BREAK      |中断一个镜像集。添加nokeep，以便规定只保留一个卷，这意味着删除其他卷（只适用于Windows Server 2008）              |break disk=n;break disk=n nokeep
            CLEAN      |移除焦点所在磁盘上所有格式化的分区或卷，使用CLEAN ALL时，所有磁盘删去被清零                                     |clean;clean[all]
            CONVERT    |在不同的磁盘格式间转换                                                                                      |convert basic|dynamic;convert gpt |mbr 
            CREATE     |创建特定类型的分区或卷                                                                                      |create partition efi | extended |logical |msr |primary;create volume simple|raid |stripe
            DELETE     |删除焦点所在的磁盘、分区或卷                                                                                |delete disk |partiton |volume 
            DETAIL     |提供焦点所在磁盘、分区或卷的详细资料                                                                         |detail disk |partition|volume 
            EXIT       |退出DiskPart解释器                                                                                        |exit 
            EXTEND     |扩展选定磁盘上的简单卷，或者跨越多个磁盘上的简单卷                                                            |extend size=n disk=n;extend filesystem
            FILESYSTEMS|显示卷上当前的与支持的文件系统类型                                                                          |filesystems 
            FORMAT     |对选定的卷进行格式化                                                                                       |format ;[[format fs=type][revision] | [recommended][label=label][unit=n][compress][override][nowait]]
            GPT        |改变焦点所在分区的GPT属性                                                                                  |gpt attributes=n，其中，n为包含16个字符的16进制数值
            HELP       |为指定的命令显示支持的命令列表或帮助信息                                                                     |help;help command name
            IMPORT     |导入外部磁盘                                                                                              |import 
            INACTIVE   |在MBR磁盘上，将当前焦点所在的分区标记为不活跃的分区，意味着计算机不会从该系统分区启动，而是从固件中选择下一个引导项|inactive 
            LIST       |显示磁盘或卷的列表及其相关信息，或者焦点所在磁盘上的分区列表                                                   |list disk|partition|volume 
            ONLINE     |将选定的磁盘或卷联机对焦点所在的镜像（或RAID-5）卷进行重新同步                                                |online disk ;online volume 
            OFFLINE    |将选定的磁盘脱机（只适用于Windows Server 2008）                                                             |offline disk 
            RECOVER    |尝试对选定的动态磁盘相关联的RAID-5卷进行恢复与重新同步（只适用于Windows Server 2008）                         |recover 
            REM        |在DiskPart脚本中标记注释的开始                                                                             |rem comment
            REMOVE     |从当前选定的卷上移除盘符或挂结点，可选的是，可以添加Diskmount参数                                             |remove letter=x;remove mount=path;remove all 
            REPAIR     |修复焦点所在的RAID-5卷，其方法是使用指定的动态磁盘替换该卷（只适用于Windows Server 2008）                     |repair disk=n[align=nn]
            RESCAN     |搜索可能已经添加到计算机上的新磁盘                                                                          |rescan 
            RETAIN     |将选定的简单卷预备用于引导卷或系统卷                                                                        |retain 
            SAN        |为当前引导的操作系统显示或设置存储区域网络（SAN）策略（Windows Vista SP1及后续版本或者Windows Server 2008）    |san ;san policy=value 
            SELECT     |选定磁盘、分区或卷，并将焦点防止到其上                                                                      |select disk |partition volume 
            SETID      |在选定的分区上设置分区类型                                                                                 |set id=value[override]
            SHRINK     |降低选定卷的容量，其方法是，将空闲空间转变为卷尾部的未使用空间                                                |shrink [desired [desired=n][nowait]];shrink [minimun=n][nowait];shrink querymax
            UNIQUEID   |为磁盘显示或设置GPT标识符或MBR签名（Windows Vista SP1及后续版本或者Windows Server 2008）                     |Uniqueid disk[id=value]
            ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        说到DiskPart脚本，其使用方法与其他命令脚本有些差别。因为DiskPart是一个文本模式的解释器，而不是一个标准的命令行工具。调用DiskPart时（方法是在命令提示符中键入diskpart），要附加/S参数，以便DiskPart解释器获知要使用的脚本，如下所示：
            diskpart /s ScriptName.txt
        其中，ScriptName.txt为文本文件名，其中包含了要使用的脚本。默认情况下，DiskPart的输出写入到当前的命令提示符，但也可以对其进行重定向，如下所示：
            diskpart /s ScriptName.txt > LogFile.log 
            或
            diskpart /s ScriptName.txt >>LogFile.log 
        其中，LogFile.log是DiskPart输出将要写入的文件名。
        （注解  重定向符号>用于创建或重写文件，>>用于创建文件或向现存文件添加内容。）
        （提示  使用脚本而不是直接输入命令的好处是：可以将磁盘相关任务自动化，以便以完全相同的方式重复执行。在采用无人值守的安装模式部署Windows系统时，这种脚本化的磁盘管理任务也是有益的。）
        使用DiskPart脚本时，要注意如下的一些错误代码。
        · 0。表示没有错误发生，执行顺利。
        · 1。发生致命以外，可能存在严重问题。
        · 2。表示为命令指定的参数是错误的。
        · 3。表示DiskPart无法打开指定的脚本或输出文件。
        · 4。表示DiskPart使用的服务返回错误代码或报告错误。
        · 5。表示发生了命令语法错误，典型的原因是错误地选择了磁盘、分区或卷，或者不适用于该命令。
    10.1.5DiskPart：脚本实例
        使用DiskPart脚本时，应该将所要指定的所有操作作为某一次会话的一部分。脚本中应该包含所有待执行的DiskPart命令，但没有必要包含EXIT命令，因为文本模式的解释器会在脚本指定到结尾时自动退出。命令清单10-1给出了一个DiskPart脚本实例：
            命令清单10-1 DiskPart：脚本实例
                rem Select disk 2
                select disk 2

                rem Create the primary partition on the disk and assign the drive letter 
                create partition primary size=4096assign letter=s 
                fomat fs=ntfs label="primary" 
                rem Create extended partition with 2 logical drives 
                create partition extended size=4096 
                create partition logical size=2048 
                assign letter=u 
                format fs=ntfs label="extended1" create partition logocal size=2047 
                assign letter=vformat fs=ntfs label="extended2"
        上面的脚本实例中，在disk2上创建了主分区与扩展分区。主分区大小设置为4096MB，盘符设置为S，并使用NTFS文件系统进行格式化。扩展分区大小为4096MB，分为两个逻辑分区。第一个逻辑分区大小设置为2048MB，盘符为U，使用NTFS文件系统进行格式化；第二个逻辑分区大小设置为2048MB，盘符为U，使用NTFS文件系统进行格式化。这样设置逻辑分区大小的原因是分区过程会损失一些磁盘空间，如果不需要分为两个逻辑分区，也可以只创建一个大小为4096MB的逻辑分区。
        （注解  按上面实例中这样创建分区并分配盘符之后，分区并不能直接使用，仍然需要使用DiskPart中的FORMAT命令对其进行格式化。要获取关于格式化分区与卷的更多信息，可以参考第11章11.4节。）
        （提示  由于DiskPart命令对磁盘的变更到实际生效有一个过程，因此，不应该连续运行多个DiskPart脚本，而是应该在运行多个脚本之间（或处理单一的DiskPart会话的所有任务之间）间歇10~15秒。这样做不仅可以保证前一次DiskPart会话发布的最后一条命令执行完毕，还可以保证前一次DiskPart会话在下一次会话开始之前完成并关闭。）
        要运行DiskPart脚本，可以键入diskpart /s ScriptName，比如diskpart /s disk2config.txt。运行该脚本时，应该有类似于如下的输出信息：
            Disk 2 is now the selected disk.
            DiskPart succeeded in creating the specified partition.
            DiskPart successfully assigned the drive letter or mount point.
            DiskPart successfully formatted the volume.
            DiskPart succeeded is creating the specified partition.
            DiskPart succeeded is creating the specified partition.
            DiskPart successfully assigned the drive letter or mount point.
            DiskPart successfully formatted the volume.
            DiskPart succeeded in creating the specified partition.
            DiskPart successfully assigned the drive letter or mount point.
            DiskPart successfully formatted the volume.
        从输出信息可以看出，对脚本运行的每一步骤，DiskPart都报告了成功或失败的结果。需要指出的是，DiskPart脚本也可以不保存在本地计算机上。如果DiskPart脚本保存在网络共享位置\\corpserver01\scripts处，则可以通过如下命令调用该脚本：
            diskpart /s \\corpserver01\scripts\disk2config.txt 
        上面命令可以成功执行的前提是从本地系统可以访问该网络共享位置。为确保这一点，也可以使用NET USE命令来映射网络驱动器，其格式为：
            net use DriveLetter: \\ComputerName\ShareName 
        比如，对上面的实例，可以使用如下命令来映射网络驱动器：
            net use x: \\corpserver01\scripts 
        （注解  使用NET USE命令时，可以以/USER:Domain\User的格式提供用户名与口令信息，也可以指定映射的驱动是否持久化的，也就是说，计算机重启都，网络共享映射是否仍然有效。其方法是使用参数/Persistent:Yes。如果需要删除持久化的网络共享，则可以键入net use \\ComputerName\ShareName /DELETE命令。）
        默认情况下，如果DiskPart脚本在执行命令时遇到错误，就会停止执行该脚本，并返回宇哥错误代码。但如果为齐总的每一条命令都指定Noerr参数，则DiskPart脚本在执行命令出错后也会报错，但会继续执行后续命令。此外，并不是必须在命令行中直接键入命令，命令可以是大型脚本（可以称为master脚本）的一部分，命令清单10-2给出了一个master脚本实例。
            命令清单10-2master脚本实例 
                @echo off 
                @if not "%OS%"=="Windows_NT" goto :EXIT 
                @if "%1"=="" (set INFO=echo && set SEXIT) else (set INFO=rem && set SEXIT=0)

                %INFO% ************************
                %INFO% Script: Disk2Setup.bat
                %INFO% Creation Date: 3/3/2008
                %INFO% Last Modified: 3/15/2008
                %INFO% Author: William R. Stank 
                %INFO% Email: williamstanek@aol.com 
                %INFO% ************************
                %INFO% Description: Configures the standard Partitions on workstations
                %INFO%            with a third hard drive. The script is configured so 
                %INFO%           that it will only run if you pass in a parameter,
                %INFO%           which can be any value.This is meant as a 
                %INFO%           safeguard to help prevent accidental formatting
                %INFO%           of disks.
                %INFO% ***********************
                @if "%SEXIT%"=="1" goto :EXIT 

                @title "Configuring Disk 2..."
                cls 
                color 07

                net use x: \\corpserver01\scripts 
                diskpart /s x:\disk2config.txt 

                rem perform other necessary tasks here 
                :EXIT 
                echo Exiting...
        本章前面对DiskPart命令进行了一些介绍，下面将讨论如何使用DiskPart命令及其相关命令（比如CHKDSK与DEFRAG）来创建、维护磁盘、分区与卷。
10.2安装与管理硬盘驱动器
    使用DiskPart的一个重要原因是有助于配置与维护硬盘驱动器。关键的管理任务包括检查新驱动器、确定驱动器状态以及管理分区表风格等。
    10.2.2检查驱动器状态与配置
        通过在DiskPart提示符中键入list disk命令，可以检查驱动器的状态。该命令典型的输出信息类似于如下格式：
            DISK###        Status       Size        Free         Dyn        Gpt        
            -------        ------       ----        ----         ---        ---    
            Disk 0         Online       466GB       1528KB    
            Disk 1         Online       466GB       1528KB  
            Disk 2         Offline      233GB        233GB       *
        从上面的输出信息可以看出，list disk命令展示了系统中已配置磁盘如下一些要素。
        · Disk ###。磁盘编号。
        · Status。磁盘总容量。
        · Free。可用于分区的磁盘空间（不是磁盘上实际可用空间的总量）。
        · Dyn。如果本列中是*，则说明该磁盘是动态磁盘，否则是基本磁盘。
        · Gpt。如果本列中是*，则说明该磁盘分区表类型是GPT，否则是MBR。
        前面的实例中，输出信息表明该计算机上有3块使用MBR分区类型的基本磁盘。其中，disk 0与disk 1状态为联机，disk 2状态为脱机，但通过将焦点切换到disk 2（键入select disk 2，之后键入online），可以让disk 2状态由脱机变为联机。
        可以看出，在安装新驱动器或排除驱动器问题时，获知驱动器状态是有用的，表10-2总结了常用的驱动器状态值。
            表10-2常用驱动器状态值及其含义
                -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                状态                         |描述                                                                                                                    |含义
                ----------------------------|------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------
                音频CD（AudioCD）            |CD/DVD驱动器中放置了一个音频CD                                                                                            |驱动器一切正常
                外部（Foreign）              |动态磁盘以移动到计算机中，但尚未导入并使用。有时候，失效的驱动器重新联机后也可能标记为外部磁盘                                  |需要使用IMPORT命令将磁盘添加到系统中
                初始化（Initializing）       |将基本磁盘转换为动态磁盘时经历的一个临时状态                                                                                |初始化完成时，状态应该自动变化为联机
                丢失（Missing）              |动态磁盘损坏、关闭或失去连接，该值出现在磁盘标识符中，而非状态列                                                              |重新连接或打开失去连接的磁盘，之后使用RESCAN命令来定位卷。如果不再使用该磁盘，可以使用DELETE DISK命令从磁盘列表中删除该磁盘
                没有介质（NoMedia）          |CD-ROM或可移动驱动器中尚未防止存储介质，只有CD-ROM或可移动磁盘类型才会显示这一状态                                             |插入CD-ROM、软盘或可移动存储介质，以便使得磁盘状态变为联机
                尚未初始化（Not Initialized）|磁盘不包括含有效的签名。在通过新磁盘检测向导第一次启动磁盘管理时，Windows会为磁盘赋予MBR或GPT类型。囚取消了该向导，就会出现这一状态|如果尚未启动磁盘管理，启动它，之后使用初始化磁盘向导写入磁盘签名。否则，在磁盘管理中右击某磁盘，之后选择初始化磁盘
                脱机（offline）              |动态磁盘不可访问，可能是因为损坏或暂时不可用。如果磁盘名变为丢失，则系统可能无法再定位或识别该磁盘                               |检查驱动器及其控制器与缆线的问题，确认驱动器电路及线路是否正确连接。如果可能的话，使用ONLINE命令将磁盘状态变为联机
                联机（Online）               |正常的磁盘状态，表示磁盘可以访问，不存在问题。基本磁盘与动态磁盘都可以显示这一状态信息                                          |磁盘不存在任何已知的问题
                联机（错误）[Online(Errors)] |动态磁盘中检测到了输入/输出（I/O）错误                                                                                      |你可以尝试使用ONLINE命令纠正临时性的错误，也可以使用RECOVER命令重新同步镜像卷或RAID-5卷
                不可读（Unreadable）         |磁盘当前不可访问，重扫描磁盘时可能发生这一情况，基本磁盘与动态磁盘都可能显示这一状态信息                                        |如果驱动器不是正处于扫描状态，则该驱动器很可能已损坏或存在I/O错误。可以使用RESCAN命令重扫描磁盘并进行读取操作（如果可能），也可以尝试重新引导系统
                未识别（Unrecognized）       |磁盘类型未知，无法在系统中使用，来自非Windows系统的磁盘在Windows中可能会显示这一状态                                           |无法在计算机上使用该驱动器，应该尝试使用其他驱动器
                -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    10.2.3修改驱动器分区风格
        在计算机上安装了驱动器后，使用时需要对其进行配置，主要是对其进行分区并在分区上创建文件系统。磁盘使用的分区类型有主引导记录（MBR）与GUID分区表（GPT）两种。
        1.MBR与GPT分区风格
            MBR包含了一个分区表，其中描述了分区在磁盘中的位置。如果磁盘采用的是这种分区风格，则磁盘上的第一个扇区包含了主引导记录与一个二进制代码文件（称为主引导代码），用于引导系统。出于保护系统的需要，该扇区不参加分区，并且是不可见的。
            采用MBR分区类型时，磁盘支持最大4T的卷，并使用如下两种分区类型的一种：
            · 主分区；
            · 扩展分区。
            MBR驱动器最多可以包含4个主分区，或者3个主分区与1个扩展分区。主分区是可以直接访问的驱动器部分（用于文件存储等），通过在其上创建文件系统，用户就可以访问主分区。与主分区不同的是，扩展分区不能直接访问，但可以使用一个或多个逻辑驱动器（用于存储文件）对其进行配置。由于可以将扩展分区分配给多个逻辑驱动器，因此可以将物理驱动器分配为多于4个部分。
            32位于64位的Windows Server 2008与Windows Vista都支持MBR与GPT。GPT最初是为基于安腾处理器的高性能计算机设计的，对大于2TB的磁盘（基于X86与X64系统）或基于安腾处理器的计算机，建议使用GPT。MBR与GPT的关键区别在于分区数据的存储方式。在GPT风格中，关键性的分区数据存储在单独的分区中，并且为了增强的结构完整性，还使用了冗余的主分区与备份分区表。
            基于GPT的磁盘有两个必不可少的分区，一个数据分区，一个或多个可选的（OEM或数据）分区：
            · EFI系统分区（ESP）；
            · 微软保留分区（MSR）；
            · 至少一个数据分区。
            此外，GPT磁盘支持最大18EB的卷、128个分区。需要指出的是，尽管GPT与MBR这两种磁盘风格有底层的区别，但大多数磁盘相关的任务是以相同方式执行的。
        2.转换分区表风格
            通过使用CONVERT命令，DiskPart可以实现分区表庚哥在MBR与GPT之间的转换。在完成如下任务时，改变分区表风格是有用的。
            · 将磁盘在不同计算机上使用，需要使用不同的分区表风格。
            · 磁盘使用错误的分区表风格进行了格式化，需要进行转换。
            要记住的是，只能在空磁盘上进行分区风格的转换。这意味着磁盘或者是新的，或者是新格式化的。当然，你也可以通过移除带转换磁盘上的所有现存分区或卷，以便清空磁盘。
        （注解  DiskPart提供了一条CLEAN命令，可用于擦除磁盘上所有卷或分区信息。对焦点所在磁盘使用CLEAN命令后，其上所有分区或卷信息将会被清空。对MBR磁盘，这意味着MBR分区与隐藏扇区信息被重写；对GPT磁盘，这意味着GPT分区信息，包括受保护的MBR，都被重写。你也可以使用CLEAN ALL命令，该命令将磁盘上每个扇区填充位0。）
        （警告  在将待转换驱动器上的数据进行备份之前，不要删除任何分区或卷，那会清空磁盘上所有数据。）
        要转换分区表风格，可以采用如下步骤。
        （1）在命令提示符中，键入diskpart来调用DiskPart解释器。
        （2）选择待操作的磁盘，将焦点放置在该磁盘上，比如：
            DISKPART>select disk 2
        （3）对磁盘进行转换，如下所示。
        · 要将磁盘从MBR转换为GPT，在命令提示符中键入convert gpt命令。
        · 要将磁盘从GPT转换为MBR，在命令提示符中键入convert mbr命令。
10.3操作基本磁盘与动态磁盘
    Windows Server 2008与Windows Vista支持下面两种类型的硬盘配置。
    · 基本的。以前Windows版本支持的标准磁盘类型，进行了分区后，基本磁盘可以在以前与当前的Windows版本中使用。
    · 动态的。一种增强的磁盘类型，可以在不需要重启的情况下进行更新（大多数情况下）。动态磁盘可以分配为一个或多个卷，也可以使用软RAID进行配置。
    （注解  不能在便携式计算机或可移动介质上使用动态磁盘。）
    10.3.1理解基本磁盘与动态磁盘
        从以前的Windows版本升级到Windows Server 2008与Windows Vista时，磁盘会被初始化为基本磁盘；在新系统与未分区驱动器上安装Windows Server 2008与Windows Vista时，可以选择将驱动器初始化为基本的或动态的。
        要注意的是，不能使用基本磁盘来创建容错的驱动器集。有鉴于此，如果想构建软RAID，就必须转换为动态磁盘，之后创建使用镜像或带区卷。容错以及无需重启计算机来修改磁盘是动态磁盘区别于基本磁盘的关键功能。
        尽管可以在同一台计算机上同时使用基本磁盘与动态磁盘，但可以执行的磁盘配置任务是不同的。对于基本磁盘，可以操作分区，并执行如下一些任务。
        · 格式化分区，并将其标记为活动分区。
        · 创建或删除主分区与扩展分区。
        · 创建或删除扩展分区内的逻辑驱动器。
        · 将基本磁盘转换为动态磁盘。
        对于动态磁盘，可以对卷进行操作，并执行如下一些任务。
        · 创建标准卷与容错卷。
        · 从镜像卷中移除一个镜像。
        · 扩展简单卷或扩展卷。
        · 将一个卷分割为两个卷。
        · 修复镜像卷或RAID-5卷。
        · 重新激活状态为丢失或脱机的磁盘。
        · 从动态磁盘反转换为基本磁盘（进行次操作之前需要删除所有现存卷）。
        对这两种磁盘类型，都可以执行如下一些任务。
        · 查看磁盘、分区或卷的属性。
        · 分配驱动器盘符。
        · 配置安全性与共享驱动器。
        不管是基本磁盘还是动态磁盘，都要记住下面5中特殊类型的驱动器部分。
        · 活动分区。活动分区或卷是用于系统缓存与启动的驱动器部分，有些带有可移动存储介质设备也可能被标记为包含活动分区。
        · 引导分区。引导分区或卷包含了操作系统及其支持文件，系统分区（或卷）与引导分区（或卷）可以是相同的。
        · 崩溃转储。在系统崩溃事件发生时，计算机会向本分区写入转储文件。默认情况下，转出文件写入到%SystemRoot%文件夹，但也可以写入到任意需要的分区或卷上。
        · 页面文件。包含了操作系统使用的页面文件的分区。由于计算机可以将内存分页到多个磁盘根据虚拟内存的配置方式，计算机可以包含多个页面文件分区或卷。
        · 系统分区。系统分区或卷包含了硬件特定的文件（用于加载操作系统），系统分区或卷不可以作为带区卷或跨区卷的一部分。
    10.3.2设置活动分区
        在分区风格为MBR的磁盘上，可以将分区标记为活动分区，这意味着计算机是从该部分启动的，但不能将动态磁盘或卷标记为活动分区。在将包含活动分区的基本磁盘转换为动态磁盘时，该分区会转换为一个简单卷，并自动变为活动分区。在将分区标记为活动分区之前，要确保主分区（视图将该分区标记为活动分区）上包含了必要的启动文件。要指定活动分区，可以遵循如下几个步骤。
        （1）在命令提示符中，键入diskpart来调用DiskPart解释器。
        （2）选择包含了待标记为活动分区的磁盘，比如：
            DISKPART>select disk 0
        （3）在命令提示符中键入命令list partition，列出了磁盘上的分区。
        （4）选择待操作的分区，比如：
            DISKPART>select partition 0
        （5）在命令提示符中键入命令active，使得选定的分区变为活动分区。
        （警告  上面步骤的磁盘编号、分区编号是随意指定的，只是为了展示这一过程。要确保步骤2、4中对磁盘与分区的选择是正确的。如果错误地将一个不包含操作系统启动文件的分区标记为活动分区，则可能导致计算机无法启动。）
    10.3.3改变磁盘类型：基本磁盘与动态磁盘的互相转换
        Windows Vista与Windows Server 2008都同时支持基本磁盘与动态磁盘两种类型。有时候，可能需要将磁盘类型在二者之间进行转换，Windows提供了相应的工具来完成这一任务。在将基本磁盘转换为动态磁盘时，分区会自动转换为适当类型的卷。但无法再将其转换为基本磁盘上的分区，而必须在动态磁盘上删除这些卷，之后将磁盘类型转换为基本磁盘。删除卷会损毁磁盘上存储的所有信息。
        1.转换基本磁盘
            将基本磁盘转换为动态磁盘是直接的，但包含很多约定。在开始之前，了解一下如下一些知识。
            · 对MBR磁盘，要确保磁盘末尾有1MB的空闲空间。如果没有这样的空闲空间，会导致磁盘转换失败。磁盘管理工具与DiskPart都会自动保留这一空闲空间，在使用第三方磁盘管理工具时，则需要关注是否保留了这一空闲空间。
            · 对GPT磁盘，必须包含临近的、可识别的分区。如果GPT磁盘包含了Windows不能识别的分区，比如由其他操作系统创建的分区，则无法将其转换为动态磁盘。
            此外，两种类型的磁盘都遵循如下一些准则。
            · 不能对删除大小超过512字节的驱动器进行转换。对这种启动器，在进行转换之前需要重新格式化。
            · 在便携式计算机或移动设备中不能使用动态磁盘。对这种驱动器，只能将其标记为基本驱动器（带有主分区）。
            · 如果系统或引导分区是跨区卷、带区卷、镜像或RAID-5卷的一部分，则不能进行磁盘转换。转换之前，应该终止跨区卷、带区卷、镜像。
            对于其他类型的分区，即便是跨区卷、带区卷、镜像或RAID-5卷的一部分，也可以进行转换。但必须对驱动器集中的所有驱动器一起转换，转换之后，变为动态卷。
            通过如下步骤，可以将基本磁盘转换为动态磁盘。
            （1）在命令提示符中，键入diskpart来调用DiskPart解释器。
            （2）选择要转换为动态磁盘的磁盘，比如：
                DISKPART>select disk 0
            （3）在命令提示符中，键入convert dynamic进行磁盘转换。
        2.转换动态磁盘
            将基本磁盘转换为动态磁盘后，再转换为基本磁盘的唯一途径是移除上的所有卷。这将确保磁盘被清空，其上所有数据源被移除。DiskPart提供了一条名为CLEAN的命令，用于擦除磁盘上所有卷或分区信息。选定了一个磁盘并将焦点防止到其上之后，键入CLEAN命令，则该磁盘上所有分区或卷信息都将被清除。
            在MBR磁盘上，这意味着MBR分区与隐藏扇区信息被重写：对GPT磁盘，这意味着GPT分区信息，包括受保护的MBR，都被重写。也可以使用CLEAN ALL命令，该命令将磁盘上所有删除填充位0，从而完全删除磁盘上所有数据。
            通过如下步骤，可以将空动态磁盘转换为基本磁盘。
            （1）在命令提示符中，键入diskpart来调用DiskPart解释器。 
            （2）选择要转换为基本磁盘的磁盘，比如：
                DISKPART>select disk 0
            （3）在命令提示符中，键入convert basic进行磁盘转换。
            完成上述步骤之后，动态磁盘就转换为基本磁盘，之后就可以在该磁盘上创建新分区与逻辑卷。
    10.4磁盘维护
        很多命令行工具可以用于磁盘维护，包括FSUtil、ChkDsk以及Defrag等。
        10.4.1使用FSUtil获取磁盘信息并管理文件系统
        文件系统工具（FSUtil）是本书尚未讲解的一个工具。
        1.FSUtil概览
            FSUtil的命令结构相当复杂，但你需要做的仍然是键入命令字符串。其中包含了命令以及相关的子命令，以便让FSUtil去完成相关任务。表10-3中总结了可用的FSUtil命令。
                表10-3FSUtil命令及其使用方法
                    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                    BEHAVIOR    |使用相关的子命令查看并控制短文件名（MS-DOS）的生成方式，NTFS卷上最后一次访问的时间戳是否已更新，配额时间写入到系统日志的频率，NTFS换页池内存与NTFS非换页池内存的内部缓存级别，以及为Master文件表（MFT）保留的磁盘空间总量
                    DIRTY       |使用相关的子命令查询或设置卷的dirty位。如果某个卷是dirty，则说明该卷可能出错，下一次计算机启动时会运行一个名为AUTOCHECK的程序对磁盘进行检查。如果必要，还会运行磁盘检查来修复存在的错误
                    FILE        |使用相关的子命令根据用户名（只适用于磁盘配额激活的情况）寻找文件，检查文件的稀疏区域，设置文件的有效数据长度，取消文件的稀疏部分
                    FSINFO      |使用相关子命令列出计算机上的驱动器、查询驱动器类型、获取卷信息
                    HARDLINK    |使用相关子命令创建硬链接，以便单一文件可以在多个目录中出现（甚至在同一个目录中以多个文件名的形式出现）。程序可以打开任意的连接来修改文件，只有在所有链接都删除的情况下，该文件才会从文件系统中删除
                    OBJECTID    |使用相关子命令管理文件与目录的对象标识符
                    QUOTA       |使用相关子命令管理NTFS卷上的磁盘配额
                    REPARSEPOINT|使用相关子命令查看或删除稀疏点，稀疏点主要用作目录连接点与卷挂载点
                    REPAIR      |使用相关子命令查看并修改自愈状态，默认情况下，自愈在Windows Server 2008与Windows Vista中都是激活的
                    RESOURCE    |使用相关子命令管理实务资源管理者。事务是被作为单一业务处理的一系列操作，这些操作或者都发生，或者都不发生
                    SPARSE      |使用相关子命令管理稀疏文件，稀疏文件是指其中包含了一个或多个未分配数据区域的文件
                    TRANSACTION |使用相关子命令管理事务
                    USN         |使用相关子命令管理更新序列号（USN）修改日志，USN修改日志提供了对卷上文件所有修改操作进行记录的持久化日志
                    VOLUME      |使用相关子命令卸载一个卷，或者查询还有多少可用的空闲空间。
                    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        2.使用FSUtil 
            尽管FSUtil有很多高级应用，比如移除磁盘上的稀疏点、管理磁盘配额、指定稀疏文件等，但也有很多基本的应用，这些基本应用对获取磁盘信息是有益的。
            获取某计算机上驱动器列表。要根据盘符获取计算机上的驱动器列表，可以键入如下命令：
                fsutil fsinfo drives 
            这一命令的输出信息以字母顺序展示了计算机上可用驱动器，如下：
                Drives：A:\ C:\ D:\ F:\ G:\ T:\ U:\
            获取驱动器类型。获知驱动器之后，可以键入命令fsutil fsinfo drivetype（其后跟随具体的驱动器），以便获取某个具体驱动器的类型信息，比如：
                C:\>fsutil fsinfo drivetype g:
                g: - CD-ROM Drive 
            输出信息表明，G:盘是一个CD-ROM驱动器。当然，你也可以使用DiskPart的list volume命令，获取计算机上所有磁盘的类似信息，但FSUtil提供了另一种有益的途径。
            获取驱动器的详细信息。要获取某个驱动器的详细信息，可以键入fsutil fsinfo volumeinfo（其后跟随具体的驱动器），比如：
                c:\>fsutil fsinfo volumeinfo c:
            执行后，FSUtil会列出卷名、序列号、文件系统类型以及支持的功能，比如：
                Volume Name : Primary 
                Volume Serial Number : 0x23b36g45
                Max Component Length : 255
                File System Name : NTFS 
                Supports Case-sensitive filenames 
                Preserves Case of filenames 
                Supports Unicode in filenames 
                Preserves & Enforces ACL's 
                Supports file-based Compression
                Supports Disk Quotas
                Supports Sparse files 
                Supports Reparse Points
                Supports Object Identifiers
                Supports Encryted File System 
                Supports Named Streams 
                Supports Transactions 
            获取驱动器的扇区与簇信息。要获取某个NTFS磁盘的扇区或簇信息，可以键入fsutil fsinfo ntfsinfo（其后跟随具体的驱动器），比如：
                C:\>fsutil fsinfo ntfsinfo c:
            执行后，FSUtil会列出扇区数与簇数，包括总簇数、空闲簇数、保留簇数等信息，比如：
                NTFS Volume Serial Number : 0x23b36g45 
                Version : 3.1
                Number Sectors : 0x0000000008fcf7c3
                Total Clusters : 0x0000000000eb9f38
                Free Clusters  : 0x0000000000d12400
                Total Reserved : 0x0000000000000000
                Bytes Per Sector  : 512
                Bytes Per Cluster : 4096
                Bytes Per FileRecord Segment       : 1024
                Clusters Per FileRecord Segment    : 0
            获取驱动器的空闲空间信息。要获取某磁盘上可用空间总量，可以键入fsutil volume disktree（其后跟随具体的驱动器），比如：
                c:\>fsutil volume diskfree c:
            执行后，FSUtil会列出磁盘的总字节数、空闲字节数、可用的空闲字节数等信息，比如：
                Total # of free bytes       : 52231667712
                Total # of bytes            : 60028059648
                Total # of avail free bytes : 52231667712
            确定某个卷是否dirty。要确定某磁盘是否被标记为dirty，可以键入fsutil dirty query（其后跟随具体的驱动器），比如：
                fsutil dirty query c:
            如果该卷上存在需要修复的错误（或已被标记为dirty），则FSUtil会报告如下信息：
                Volume -c: is Dirty 
            如果该卷上不存在任何已知的错误，则FSUtil或报告如下信息：
                Volume - c: is NOT Dirty 
        10.4.2检查磁盘的错误与坏扇区
            如果需要检查磁盘错误与坏扇区，可以使用命令行工具CheckDisk（Chkdsk.exe）。它可以检查基本磁盘与动态磁盘的完整性，也可以用于检查与修复（可选）FAT、FAT32、NTFS卷上发现的问题。
            Chkdsk.exe可以检查与纠正很多类型的磁盘错误。它主要用来寻找文件系统及其相关元数据的不一致性，且其用于定位错误的一种途径是，将卷位图与文件系统中分配给文件的磁盘删去进行比较。然而，chkdsk.exe不能修复文件中看起来结构上比较完整的损坏数据。

            分析磁盘但不修复它

            在命令行中键入命令名，其后跟随驱动器盘符与一个分号，就可以测试驱动器的完整性。比如要检查C盘驱动器的完整性，可以键入命令 chkdsk c:。对于FAT与FAT32卷，Check Disk会报告类似于如下信息：
                The type of the fiel system is FAT32.
                The volume is in use by another process. Chkdsk 
                might report errors when no corruption is present.
                Volume TRAVELDRIVE created 4/21/2008 12:32 AM 
                Volume Serial Number is DFGA-9871
                windows is verifying files and folders...
                File and folder verification is complete.
                Windows has checked the file system and found no problems.
                    80430504 KB total disk space.
                    20       KB in 5 folders.
                    3739684  KB in 85 files.
                    4303796  KB are available.

                    4096     bytes in each allocation unit.
                    2010876  total allocation units on disk.
                    1075949  allocation units available on disk.
            上面的命令对文件分配表中的每一条记录进行一致性检查，对当前分配的文件与文件夹记录进行分析，并使用根目录表确定每个记录的起始簇。该工具检查每个文件，并注意查看输出信息中的差异。那些标记为已被文件或文件夹使用但实际上没有实际应用的簇都会被显示出来，在修复过程中，这些簇可以标记为可用。输出信息中标记的任意其他的差异也可以在修复过程中修订。
            对于NTFS，chkdsk.exe在多个阶段进行分析，并分阶段报告其分析过程。下面给出了一个对NTFS卷进行检查时的输出示例：
                The type if the fiel system is NTFS.
                WARNING! F parameter not specified.
                Running CHKDSK in read-only mode.

                CHKDSK is verifying files (stage 1 of 3)...
                73088 file records processed.
                File verification completed.
                123 large file records processed.
                0 bad file records processed.
                0 EA records processed.
                0 reparse records processed.
                CHKDSK is verifying indexes (stage 2 of 3)...
                269869 index entries processed.
                Index verification completed.
                5 unindexed files processed.
                CHKDSK is verifying security descriptors (stage 3 of 3)...
                73088 security descriptors processed.
                Security descriptor verification completed.
                3511 data files processed.
                CHKDSK is verifying Usn Journal...
                26911912 USN bytes processed.
                Usn Journal verification completed.
                Windows has checked the file system and found no problems.

                488384000 KB total disk space.
                353648812 KB in 69111 files.
                25836 KB in 3512 indexes.
                0 KB in bad sectors.
                180660 KB in use by the system.
                65536 KB  occupied by the log file.
                134528692 KB available on disk.
                4096 bytes in each allocation unit.
                122096000 total allocation units in disk.
                33632173 allocation units available on disk.
            可以看出，chkdsk.exe操作是分3个阶段进行的。在第一个阶段，chkdsk.exe的作用是对文件结构进行验证：
                CHKDSK is verifying files (stage 1 of 3)...
                73088 file records processed.
                File verification completed.
                123 large file records processed.
                0 bad file records processed.
                0 EA records processed.
                0 reparse recprds processed.
            这意味着chkdsk.exe对MFT中每一个文件的记录进行一致性检查，对当前已分配的所有文件记录进行分析，确定文件记录存储在哪些簇中，并将其与卷的簇位图元数据文件进行比较，任意的差异都会在其输出信息中标记。比如，那些标记为已被文件或文件夹使用但实际上没有应用的簇都会被显示出来，在修复过程中，这些簇可以标记为可用。
            在第二阶段中，chkdsk.exe对磁盘索引条目进行确认：
                CHKDSK is verifying indexes (stage 2 of 3)...
                269869 index entries processed.
                Index verification completed.
                5 unindexed files processed.
            这意味着chkdsk.exe通过检查目录索引（从卷的根目录索引开始，且存储于索引元数据文件中）来验证目录结构。通过对目录索引的检查，chkdsk.exe可以确认是否每个索引记录都对应了磁盘上真实存在的目录，是否每个被认为存在于某个目录中的文件确实存在于某个目录中。此外，chkdsk.exe还对包含MFT目录但实际上并不存在于该目录中的文件进行检查，在修复过程中，这些丢失的文件可以恢复。
            如果在验证磁盘索引条目的过程中发现丢失的文件，并且提供了/F参数，则chkdsk.exe会尝试对这些文件进行恢复。典型情况下，恢复的文件在相关的磁盘驱动器的根目录下保存为.chk文件。如果chkdsk.exe发现了未索引的文件，则会对其进行索引编目。
            在第三阶段，chkdsk.exe会对安全描述符进行验证：
                CHKDSK is verifying security descriptors (stage 3 of 3)...
                73088 security descriptors processed.
                Security descriptor verification completed.
                3511 data files processed.
            这意味着chkdsk.exe对卷上每个文件与目录对象的安全描述符进行验证，这是通过安全元数据文件检测安全描述符是否正常工作实现的，但实际上并不真正检查安全描述符中标记的用户或组是否存在。
            chkdsk.exe还会对USN修改日志中的更新序列号进行验证。USN修改日志对卷中所有相关操作进行了完整的记录，记录了所有增加、删除与修改等操作，而不管是哪个用户以哪种方式进行的这些操作。这一日志是持久性的，并不会随着关机或重启而消失。如果在对USN修改日志进行验证时发现USN错误，则chkdsk.exe会尝试对其进行修复。
            完成上述3个步骤后，chkdsk.exe会报告是否存在问题，并提供一份关于磁盘的报告信息：
                Windows has checked the file system and found no problems.

                488384000 KB total disk space.
                353648812 KB in 69111 files.
                25836 KB in 3512 indexes.
                0 KB in bad sectors.
                180660 KB in use by the system.
                65536 KB occupied by the log file.
                134528692 KB available on disk.

                4096 bytes in each allocation unit.
                122096000 total allocation units on disk.
                33632173 allocation unites available on disk.
        10.4.3修正磁盘错误
            对磁盘进行分析时，默认情况下并不会修复存在的错误。如果希望在检测的过程中自动地对其中存在的错误进行恢复，就需要使用/F参数：
                chkdsk /f C:
            要注意的是，chkdsk.exe不能对使用中的卷进行修复。如果卷正处于使用中，则chkdsk.exe会弹出提示信息，询问是否希望在下次重启系统时对其进行修复。此外，使用/R参数或/X参数可以替代/F参数的功能（/X参数只适用于NTFS卷）。/R参数用于定位磁盘的坏扇区，并恢复可读的信息，/X参数用于强制卸载NTFS卷（如果需要）。
            （真实场景  如果指定了/R参数，则chkdsk.exe在分析与修复的过程中会增加一个附加的步骤，即对磁盘上的每一个扇区进行检查，以便确定这些扇区是否可以正确进行读写操作。如果某扇区是正在使用中的簇的一部分，则chkdsk.exe会将该簇中的正常数据移动到新簇中。）
            坏扇区中数据可以恢复的前提是，存在冗余的数据副本，并可以复制出来。检测之后，坏扇区将不再用于存储数据，因此至少可以保证将来不会引发问题。对磁盘上每个扇区都进行检查是一个耗时的过程，有鉴于此，典型情况下都是使用ChkDsk /F参数来检测与修复常见的错误，而不使用ChkDsk /R。
            对NTFS卷，可以强制chkdsk.exe重新评估那些使用/B参数标记为bad的簇，/B参数暗含了/R参数的功能。重新评估时，chkdsk.exe会再一次确定标记为bad的簇是否可以正常读写。如果可以，则将该簇标记为good，以便磁盘子系统可以使用该簇。
            通过使用/V参数，可以使chkdsk.exe显示更多的信息。对NTFS卷，通过使用/I参数，可以使chkdsk.exe只对磁盘索引条目进行有限的检查；通过使用/C参数，可以使chkdsk.exe跳过对文件夹结构总循环错误的检查。所谓循环错误，实际上是一种极少发生的错误类型，发生这种错误时，目录中包含一个指向自身的指针，导致无限循环。
            要了解如何使用chkdsk.exe，可以参考如下一些实例。
                发现并修复C盘驱动器上的错误：
                chkdsk /f c:
                定位并修复C盘驱动器上的坏扇区：
                chksak /r c:
                对C盘驱动器（NTFS卷）进行最小限度的检查：
                chkdsk /i /c C:
        10.4.4对系统启动时的自动检测进行控制
            默认情况下，Windows Server 2008与Windows Vista在启动时会对所有磁盘进行检查，并在必要时候启动chkdsk.exe来修复存在的错误。有两个工具可用于对启动的自动磁盘检查进行控制，分别是AUTOCHK与CHKNTFS。操作系统启动时，会启动自动检测，以便对驱动器进行自动检查。不能直接调用自动检测，但可以使用NTFS检测来控制其工作方式。通过NTFS检测，可以决定计算机下一次启动时是否对磁盘进行检查，也可以更改磁盘自动检查的选项。
            1.确定自动检测状态
                要确定计算机下次启动时是否对某磁盘进行检查，可以键入：
                chkntfs Volume:
                其中，Volume是待检查的盘符，其后跟随一个分号，比如：
                chkntfs c:
                你也可以同时指定多个盘符，其间使用空格分隔开。下面的命令可以确定驱动器C、D、E的磁盘检测状态：
                chkntfs c: d: e:
                NTFS检测可以报告文件系统类型，以及磁盘状态为dirty还是not dirty，如下所示：
                The type of the file system is NTFS.
                C: is not dirty.
                The type of the file system is NTFS.
                D: is dirty.
                从上面信息可以看出，C盘驱动器的状态为not dirty，因而自动检测不会再其上触发磁盘检测。而D盘驱动器的状态为dirty，这表明该驱动器上可能存在错误，因而计算机启动时，自动检测会在其上触发磁盘检测。
            2.配置自动检测参数
                通过使用NTFS检测，可以对自动检测的工作方式进行配置。计算机重新引导时，操作系统会显示一个倒计时定时器，使得用户可以在自动检测开始之前对其进行取消。通过/T参数，可以设置倒计时定时器的时间长度，如下所示：
                chkdsk /t:NumSeconds
                其中，NumSeconds是该定时器设定的倒计时秒数，比如：
                chkntfs /t:5
                如果希望计算机启动时不对某个或某几个卷进行检查（即便该卷标记为需要检查），可以使用/X参数，其后跟随盘符，比如：
                chkntfs /x d: e:
                这一命令使得计算机不会对D盘与E盘进行检查，即便这两个磁盘标记为dirty。
                如果希望计算机启动时对某个或几个卷进行检查（这也是自动检测的默认配置），可以使用/C参数，其后跟随盘符，比如：
                chkntfs /c c: d:
                这一命令使得计算机启动时对D盘与C盘进行检查，用于确定这两个磁盘标记为dirty还是not dirty。
                最后一个可用的参数是/D，用于恢复自动检测的默认配置（倒计时定时器除外），即计算机启动时对所有磁盘驱动器进行自动检查。
    10.5磁盘碎片整理
        进行文件添加、移动或删除时，计算机磁盘驱动器上的数据会变得碎片化。磁盘上碎片数据较多时，大文件无法写入到磁盘上单一的连续区域。由此导致的结果是，大文件被分散写到磁盘上很多小区域中，从而导致文件读取时花费更多的时间开销。要减少磁盘中的碎片，应该定期对其进行分析与碎片整理。尽管可以将Windows Server 2008与Windows Vista配置为自动磁盘碎片整理，但也可以使用Defrag这一命令行工具来检测FAT、FAT32、NTFS卷上的碎片情况，并根据需要对其进行碎片整理。
        1.理解与使用Defrag
            典型情况下，碎片整理的过程分为两个步骤。首先，分析磁盘的碎片化程度，确定其是需要进行碎片整理，之后根据分析结果决定下一步。实际使用时，可以键入defrag命令（其后跟随盘符与分号）来完成这两个步骤，比如：
            defrag c:
            Defrag会对磁盘进行分析，如果分析结果表明该磁盘需要进行碎片整理，则开始这一过程；如果不需要，则Defrag在分析之后不进行整理，并报告说磁盘不需要进行碎片整理。
            如果需要对磁盘进行彻底的碎片整理，一般要求磁盘上至少有15%的空闲空间。Defrag会使用这一部分空间作为文件碎片的存储区域。如果磁盘空闲空间小于15%，则只能进行部分的碎片整理。此外，不能对已标记为Dirty的磁盘进行碎片整理，因为这意味着磁盘上存在错误。对这种情况，必须先运行磁盘检测工具来修复其上的错误。
            Defrag有几个可用的参数，比如-a，作用是只对磁盘进行分析，但不对其进行碎片整理。Defrag有两种碎片整理模式：部分整理，由-r标记指定；全面整理，由-w标记指定。默认情况下，在文件碎片小于64MB时，Defrag会进行部分的碎片整理。使用-w标记后，Defrag会进行全面的碎片整理，而不管文件碎片的大小。
            Defrag还有两个参数：-v，用于指定verbose输出；-f，强制进行碎片整理（即便自由空间较小），但强制进行碎片整理可能需要花费很长的时间，并且也不能保证碎片整理的完全性。
        2.只进行Defrag分析
            有时候，只需要对磁盘进行分析，以便确定以后是否对其进行碎片整理。Defrag有两种分析模式：概要模式，由-a标记指定，且不使用-v标记；全模式，使用-a标记，同时使用-v标记。
            要对磁盘进行概要分析，而不对其进行碎片整理，可以键入defrag -a命令，其后跟随盘符与分号。分析之后，Defrag会报告磁盘是否应该进行整理。下面实例中，分析之后，报告说该磁盘不需要进行碎片整理：
                c:\>defrag -a c:
                windows磁盘碎片整理程序
                版权所有（c）2006 Microsoft Corp.

                卷C分析报告
                    卷大小    =457 GB
                    可用空间  =358 GB
                    最大可用空间扩展   =209 GB
                    文件碎片百分比     = 2 %
                    注意：在NTFS卷上，大小超过64MB的文件碎片不包含在碎片统计信息中。

                    不需要对该卷进行碎片整理。
            可以看出，该磁盘只有2%的碎片率，因而不需要进行碎片整理。下面的实例则展示了一个碎片化程序很高的磁盘：
                C:\>defrag -a d:
                Windows磁盘碎片整理程序
                版权所有（c） 2006 Microsoft Corp.

                卷D分析报告
                    卷大小       = 446 GB
                    可用空间     = 131 GB
                    最大可用空间扩展    = 74.69 GB
                    文件碎片百分比      = 29 %
                    注意：在NTFS卷上，大小超过64MB的文件碎片不包含在碎片统计信息中。

                    你应该对该卷进行碎片整理。
            分析之后，Defrag建议对磁盘进行碎片整理，可以根据系统维护需要进行。
            要对磁盘进行全面分析，但不对其进行碎片整理，可以键入defrag -a -v命令，其后跟随盘符与分号。分析之后，Defrag会报告磁盘是否应该进行整理是否应该进行整理。下面实例中，分析之后，报告说该磁盘需要进行碎片整理：
                C:\>defrag -a -v d:
                Windows磁盘碎片整理程序
                版权所有（c）2006 Microsoft Corp.

                卷D分析报告
                    卷大小           = 466 GB
                    簇大小           = 4 KB
                    已使用空间       = 355 GB
                    可用空间         = 131 GB
                    可用空间百分比   = 28 %

                    文件碎片
                        文件碎片百分比     = 29 %
                        可移动文件总数     = 72608
                        文件平均大小       =5 MB 
                        碎片文件总数       = 18200
                        剩余碎片总数       = 91257
                        每个文件的碎片平均个数 = 1.64
                        不可移动文件总数   = 10
                    
                    可用空间碎片
                        可用空间           = 131 GB
                        可用空间扩展总数    = 552
                        每个扩展的可用空间平均大小  = 243 MB
                        最大可用空间        = 74.69 GB

                    文件夹碎片
                        文件夹总数          = 3504
                        零碎文件夹          = 15
                        剩余文件夹碎片      = 35
                    宿主文件表（MFT）碎片
                        MFT总大小          = 71 MB
                        MFT记录计数        = 72757
                        使用中国的MFT百分比 = 99
                        总得MFT碎片        = 8
                    注意：在NTFS卷上，大小超过64MB的文件碎片不包含在碎片统计信息中。

                    你应该对该卷进行碎片整理。

            当前分析卷的类型决定了报告中不同区域，报告区域包含如下一些要素。
            · 文件碎片。提供了对文件级碎片的整体描述，包含使用中磁盘空间的碎片率，卷上可移动文件总量，这些文件的平均大小，碎片化文件总量，更多的碎片总量，每个文件的平均碎片数，不可移动文件总量等。理想情况下，整体碎片化程度应该小于等于10%，而每个文件的碎片化程序接近100%。
            · 空闲空间碎片。提供了对卷上未使用磁盘空间碎片的整体描述，包括卷上有多少可用的空闲空间，空闲空间定位所在的范围总数，每个范围上的平均空间量，以及最大空闲空间范围。
            · 文件夹碎片。提供了对文件夹级碎片的整体描述，包括卷上文件夹总量，存在碎片的文件夹总量等。
            · 主文件表（MFT）碎片。只适用于NTFS卷，提供了对MFT碎片的整体描述，包括MFT当前大小，其中包含的记录数，使用中的MFT的百分比，MFT中碎片总量等。在上面的实例中，MFT中存在的一些碎片。但应该引起注意的是MFT使用率已达到最大值的99%，这会导致MFT碎片化程度岁时间不断增加。鉴于该卷上还有28%的空间，MFT碎片将有可能分布到这一部分。
            鉴于上面的分析结果，应该再次运行Defrag（而不需要指定-a参数），并且使用-w参数进行全面的碎片整理（而不是默认情况的部分碎片整理）。尽管每一种技术都不能消除所有碎片，但都会有所帮助，使得磁盘空间的使用更加高效。对存在碎片的卷，进行碎片整理后，会发现性能有所提升。

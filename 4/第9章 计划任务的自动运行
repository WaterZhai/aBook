第9章  计划任务的自动运行

作为管理员，每天都会重复执行一些相同或相似的任务。其中某些任务有时候还不得不提前或推迟到非工作时间进行。其中一些任务可能是例行的维护活动，比如删除临时文件（以免磁盘空间耗尽），或者备份重要数据等。另外一些任务肯恩故事比较繁琐的过程，比如，在所有交易服务器上搜索事件日志，以便发现需要解决的问题。幸运的是，如果将这些任务分解为一系列步骤，就可以自动执行这些任务，Windows提供了下面两种实现方法。
· Schtasks。一个高级命令行工具，可根据计划来运行命令、脚本以及程序。你可以根据实际需要对任务进行计划，使其只运行一次，每分钟运行一次，在特定的时间间隔后运行（比如每小时、每天、每星期、每月运行一次），在系统启动时运行，在登录时运行或在系统空闲时运行。
· 任务计划程序。一个图形界面工具，可根据调度计划来运行命令、脚本以及程序。任务计划程序与Schtask执行同样的操作，二者可以一起使用，也可以分别管理或执行另外一款工具创建的任务。

Schtask命令与任务计划程序可以互换使用，本章讨论如何使用这两款工具来自动运行程序、命令行工具与脚本。大多数情况下，你会发现，同时理解这两款工具是有用的，即便有时候可以通过任务计划程序单击与选择，但你也可以使用命令行开完成同样的任务。

9.1在本地与远程系统上执行计划任务
    在命令行中运行的一切对象都可以配置为计划任务，包括命令行工具、脚本、应用程序、快捷方式、文档等，也可以在其中指定命令行参数。有些时候，你可以需要在当前登录的本地系统上进行这些任务计划与配置，但更常见的情况是从本地系统对网络中的远程系统进行这些操作。
    9.1.1计划任务简介
        本地系统与远程系统上的计划任务都是通过Task Schedule服务激活的，对于需要在其上执行计划任务的任意系统，都必须首先启动该服务。默认情况下，Task Scheduler服务以本地系统帐号登录系统，该账号通常不具备执行管理型任务的许可权限。为此，对要计划执行的每一个任务，都应该对其进行适当配置，使用具有适当权限的账号运行相应任务。此外，对需要在其上执行计划任务的所有系统，要确保Task Scheduler服务配置为自动启动。再次强调，必须对Task Scheduler服务的启动方式与登录帐号选项进行正确配置。
        你可以使用任务计划程序控制台来查看并操作计划任务。要访问任务计划程序，可以依次单击“开始”、“管理工具”、“任务计划程序”。任意用户都可以在本地计算机上设置计划任务，并根据需要对其进行查看与修改。管理员可以在本地计算机上计划、查看、修改必备该远程计算机上管理员组成员的身份，或者在遇到提示信息时提供管理员登录凭据。
        在任务计划程序中，任务技术程序库包含了计算机上定义的所有任务。与以前的Windows版本不同的是，Windows Vista与Windows Server 2008都广泛地使用了计划任务，很多任务在第一次安装操作系统是就已经自动创建。安装角色、角色服务、功能以及应用程序时，这些组件也可能创建额外的任务。在图中，任务计划程序库展示了如下一些要素。
        · 名称。表示任务名，在形式上可以是任意字符串。与任务的其他属性一样，任务名可以在创建时设置。
        · 状态。表示任务当前状态。“正在运行”表示任务计划程序已启动该任务，该任务正在运行中。“准备就绪”表示该任务已激活，准备就诸，并等待触发。“禁用”表示该任务被禁用，不再运行。“失败”表示该任务由于某些故障无法启动。
        · 触发器。列出了与该任务相关联的触发器。
        · 下次运行时间。表示该任务下次将要运行的日期与时间。Never表示该任务在调度运行的时间过后不会再次运行，这种情况通常是一次性任务。
        · 上次运行结果。表示退出错误代码。为0时表示没有发生错误，其他数值表示了某种类型的错误。
        · 创建者。表示创建该任务的用户名。
        · 创建时间。表示该任务创建的日期与时间。
        Windows Vista与Windows Server 2008中包含两种通常意义的任务类型。
        · 标准任务。自动执行的例行任务，执行日常的维护操作。这些任务对用户可见，并可以在必须时进行修改。
        · 隐藏的任务。自动执行的特定系统任务。默认情况下，这些任务对用户不可见，大多数时候也不应该进行修改。有些隐含任务是通过相关程序进行创建与管理的，比如Windows Defender。
        （注解  在任务计划程序的“查看”菜单中，选择“显示隐藏的任务”，可以显示隐藏的任务。）
        在任务计划程序库中，Microsoft\Windows下与Microsoft\Windows Defender下的任务为系统任务。Microsoft\Windows下的任务主要用于完成计算机上很多后台的维护操作，MIcrosoft\Windows Defender下的任务则用于自动扫描恶意软件。Windows Defender是Windows Vista中默认使用的恶意软件扫描工具，在Windows Server 2008中，通过安装桌面体验功能，也可以将该工具添加到系统中。
        尽管可以在任务计划程序库中的任一层次创建任务，但大多数情况下是在其顶层进行任务创建，为做到这一点，创建任务时，可以选择任务计划程序节点而非其他低层节点。
        如果需要对任务进行组织，可以在任务计划程序库中创建文件夹。这些文件夹在形式上称为任务计划程序库层级结构中的节点，并充当任务容器的角色。在大型企业网络中，甚至可以在任务计划程序库中刚创建子层结构。通过如下步骤，可以创建文件夹，使其包含自己的任务。
        （1）在任务计划程序中，选择用于包含文件夹的顶层节点。比如，如果希望文件夹成为任务计划程序库节点的子节点，则可以选择该节点。
        （2）在“操作”菜单或“操作”面板中，选择“新文件夹”。在弹出的对话框中，为该文件夹输入一个唯一的名字，之后单击“确定”。
        在Windows Vista与Windows Server 2008中，任务计划程序是与操作系统中实现的Windows安全模型完全整合在一起的。定义任务时，需要指定运行该任务的用户账号。默认情况下，任务以用户账号的标准权限运行。如果任务需要更高的权限，而又不希望Windows阻止其运行并显示用户账号控制提示，就需要在定义任务时指定Windows总是使用最高权限运行该任务。以用户账号的最高权限运行时，任务计划程序会弹出提示要求输入该用户账号的口令，之后，该口令会被安全地存储在系统中。
        （注解  在修订后的任务计划程序中，微软改变了任务使用用户登录凭据的方式。以前，如果某用户帐号的口令进行了修改，就需要对使用该用户账号的任务设置进行修改。在Windows Vista与Windows Server 2008中，如果任务只访问本地资源，则不需要再用户口令改变后进行任务相关的口令更新。口令更改不会影响任务，任务可以继续运行。如果任务访问外部资源，则需要在用户账号口令改变之后，对使用该账号的任务相关口令设置进行更新。）
        任务包含了很多属性，主要包括下面5个。
        · 触发器。指定了任务开始与结束的环境。
        · 操作。定义了任务启动时执行的操作。
        · 条件。限定了任务启动与终止的条件。
        · 设置。影响人物的行为。
        · 记录。展示了任务运行或尝试运行时生成的事件。
        与以前的Windows版本中的计划任务不同的是，在Windows Vista与Windows Server 2008中可以为任务指定不止一个触发器与动作。这意味着，每个计划任务可以运行多个程序、工具或脚本，也可以被配置为以多种方式运行，包括下面4种。
        · 在特定的时间与日期运行，比如，在2009年10月25日的下午5:45运行。
        · 在指定的时间间隔运行，比如，在每个星期一、星期三、星期五的下午5:45运行。
        · 在特定系统事件发生时运行，比如，在某用户登录系统时运行。
        以上面几个运行条件的任意合理组合运行，或以其他未列出的方式运行。
        在任务的相关属性中，任务触发器应该引起特别的关注，因为他们并不总是能按预期的那样工作，任务触发器包括下面5个。
        · 系统启动。如果将计划任务设置为在系统启动时运行，则任务计划程序会在系统每次启动时自动运行该任务（而不需要用户的交互），并一直运行到任务完成、任务被终止，或者系统关机。要记住的是，只有任务的属主或管理员才可以终止运行中的任务。
        · 系统登录。如果需要将计划任务设置为在某用户登录系统时运行，则可以对其进行配置，使其在任意用户登录系统时运行（而不管是哪个用户对其进行配置），或者只有在某个指定的用户登录系统时运行。经过这样配置并启动后，任务计划程序会一直运行该任务，直至该任务完成。任务被终止，或者该用户退出登录。这种方式运行的任务可以是交互式的，也可以是非交互式的，取决于其具体配置方式。
        （提示  如果某用户使用自己的登录凭据配置了一个交互式的任务，但其他用户登录了系统，则该任务仍然会以其创建者的许可权限运行，并且在其他用户退出登录时并不会终止运行（因为该任务有其创建者拥有，其他用户不具备权限终止其运行）。进一步地，使用快速用户切换时，登录型任务并不会在用户切换后运行，只有在某用户登录而其他用户都退出登录时才运行。）
        · 系统空闲。如果将计划任务设置为在系统空闲时运行，则任务计划程序会在某个时间间隔之内没有任何用户活动后执行该任务。比如，你可以创建一个任务，使其在系统空闲5分钟之后运行。要记住的是，后续的用户活动并不会终止该任务。该任务会一直运行，直至任务完成或被终止。
        · Windows事件。如果将计划任务设置为在特定Windows事件发生时运行，则任务计划程序会在Windows将带有指定标识符的事件写入到特定事件日志时运行该任务。在基本的配置中，可以指定一个单独的时间标识符、一个可选的事件源以及要进行监控的单一事件日志。在自定义配置中，可以定义一个事件过滤器，并像前面章节中讲述的那样对其进行操作，可以实现对多个日志、多个事件源以及两者相结合的多种事件类型的监控。
        · 用户会话。如果将计划任务设置为某用户建立了一个终端服务用户会话时运行，则任务计划程序会在用户从本地或远程系统建立连接、创建用户会话时运行该任务。你也可以将计划任务设置为在用户终止来自本地或远程系统额终端服务会话时运行。
        尽管可以为任务定义多个操作，但实际上也可以在任务启动时创建一个命令行脚本，使其运行多个命令、程序与工具，以便执行其他任务。你可能需要该脚本以特定用户或管理员的登录凭据运行，以便保证该脚本有必要的许可权限与访问权限。该脚本还应该配置其他必须的用户设置，以便确保所做的一切操作都在其可控范围之内。此外，域用户设置，比如驱动器映射，在必要的时候也是可用的。
        （真实场景  配置任务的运行方式时，可以指定该任务运行时使用的用户账号与登录口令。对于递归的任务，这种做法会导致问题，尤其是在许可权限与口令变更是更是如此，而这种变更通常是难以避免的，如果账号许可权限或口令发生变更，而某些任务又需要对远程资源进行操作，则至少需要对使用这些登录凭据的一个任务的属性进行编辑，并为该账号提供新的登录凭据。）
    9.1.2监控计划任务
        任务计划程序不会对用户提供的信息进行验证，也不会对程序、命令、工具的可用性进行验证。如果提供了错误的信息，则任务只是不能运行或者运行时出错。如果需要对任务进行检查，有一种方法是在任务计划程序中查看任务状态以及上次的运行结果，这些信息是任务上次运行生成的。如果上次运行结果为错误信息，就需要解决存在的问题，以便任务可以正常运行。通过单击任务在任务计划程序中国的入口，就可以对其属性进行查看与编辑。
        列为正在运行状态的任务实际上也可能并未运行，而是一个失去响应的或失控的进程。你可以使用上次运行时间来检查失去响应的或失控的进程，该值用于表明任务的启动时间。如果检查结果表明该任务已运行超过一天，则很可能存在需要纠正的问题。如果是脚本，则可能在等待输入信息，或者读写文件存在问题，也可能是一个需要终止的进程。要终止任务，可以在任务计划程序中右击该任务，之后选择“结束”。
        然而，上次运行结果并不能表明上一次运行该任务之前是否发生过问题。要深入挖掘并透彻理解任务的运行历史，你应该定期检查任务计划程序的运行日志。在事件查看器中，该日志存储于Applications And Services Logs\Microsoft\Windows\TaksScheduler\Operational。对任务计划程序日志进行检查时，会发现如下一些信息。
        · 记录了Task Scheduler服务启动与退出（终止）的时间。
        · 记录了任务启动、完成运行的时间，以及退出错误代码或结果代码。取值为0时意味着任务正常运行和终止，其他值都表示了发生了某种错误。
        · 记录了任务计划程序启动任务时产生的告警与错误消息。
        （提示  在命令行中，任务计划程序操作日志的引用名为\MicrosoftWindows-TaskScheduler/Operational。默认情况下，该日志存储在%SystemRoot%\System32\Winevt\Logs文件夹下，名为Microsoft-Windows-TaskScheduler/Operational.evtx。通过使用第6章、第8章中讨论的技术，可以像对其他日志一样操作这一日志。）
        任务计划程序中包含了操作日志的自定义过滤视图。选定了任务计划程序中的任务计划程序节点后，主面板分为几个子面板，包括任务状态子面板与活动任务子面板。通过任务状态面板中的选项，可以查看不同时间间隔内（最近1个小时、最近24个小时、最近7天、最近30天）所有计划任务的状态摘要。通过活动任务面板，可以查看运行中任务的摘要信息。通过双击一个运行中的任务，就可以访问任务计划程序库中的任务定义。
        选定了任务计划程序中的任务定义之后，单击“记录”选项卡，就可以查看任务计划程序操作日志的筛选后的视图，其中包含了与该任务相关的事件。如果选中其中一个特定的事件，就可以在下一级面板中看到该事件的详细信息。
        脚本运行时，如果需要对所发生的事件有更详尽的理解，可以将命令与工具的输出信息记录到单独的日志问价中，之后可以通过该日志文件分析那些命令与工具是否生成了预期中的结果。通过对标准输出与标准错误输出的重定向，可以将命令输出信息写入到指定的文件。下面的实例中，DEFRAG命令的输出信息以及错误信息被以添加模式写入到Stat-log.txt。
            defrag c: >> c:\logs\stat-log.txt 2>&1
            
